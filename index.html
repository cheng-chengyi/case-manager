<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1a365d">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å€‹æ¡ˆç®¡ç†">
<link rel="apple-touch-icon" href="icon-192.png">
<title>å€‹æ¡ˆç®¡ç†ç³»çµ±ï½œå‹ä¿ãƒ»è·ç½ãƒ»å•†æ¥­ä¿éšªãƒ»å‹è³‡çˆ­è­°</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0f1f3d;
    --navy-2: #1a2f52;
    --navy-3: #243a63;
    --gold: #c9a84c;
    --gold-light: #e8c87a;
    --teal: #0EA5B0;
    --teal-light: #23a3a3;
    --bg: #f4f6fa;
    --surface: #ffffff;
    --surface-2: #f0f4f8;
    --border: #d4dce8;
    --text: #1a2236;
    --text-2: #4a5568;
    --text-3: #718096;
    --danger: #D55E00;
    --warning: #d69e2e;
    --success: #0072B2;
    --info: #2b6cb0;
    --shadow: 0 2px 12px rgba(15,31,61,0.08);
    --shadow-lg: 0 8px 32px rgba(15,31,61,0.14);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Layout */
  .app { display: flex; height: 100vh; overflow: hidden; }
  .sidebar { width: 240px; background: var(--surface); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; border-right: 1px solid var(--border); }
  .main { flex: 1; overflow-y: auto; }
  
  /* Sidebar */
  .sidebar-logo { padding: 24px 20px 20px; border-bottom: 1px solid var(--border); }
  .sidebar-logo h1 { font-family: 'Playfair Display', serif; color: var(--navy); font-size: 15px; line-height: 1.4; }
  .sidebar-logo p { color: var(--text-3); font-size: 11px; margin-top: 4px; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-label { color: var(--text-3); font-size: 11px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; padding: 0 8px; margin-bottom: 6px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px; cursor: pointer; color: var(--text-2); font-size: 13px; transition: all 0.18s; margin-bottom: 2px; }
  .nav-item:hover { background: var(--surface-2); color: var(--navy); }
  .nav-item.active { background: rgba(0,114,178,0.12); color: #0072B2; font-weight: 600; border-left: 3px solid #0072B2; padding-left: 7px; }
  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
  .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid var(--border); }
  .sidebar-footer p { color: var(--text-3); font-size: 11px; text-align: center; }

  /* Top bar */
  .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 28px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
  .topbar-title { font-size: 15px; font-weight: 600; color: var(--navy); }
  .topbar-actions { display: flex; gap: 10px; align-items: center; }
  .btn { padding: 7px 16px; border-radius: 7px; font-size: 13px; font-family: inherit; cursor: pointer; border: none; font-weight: 500; transition: all 0.18s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover { background: var(--navy-2); }
  .btn-gold { background: var(--gold); color: var(--navy); font-weight: 600; }
  .btn-gold:hover { background: var(--gold-light); }
  .btn-outline { background: transparent; color: var(--text-2); border: 1px solid var(--border); }
  .btn-outline:hover { border-color: var(--navy); color: var(--navy); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 5px 12px; font-size: 13px; }
  .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 6px; justify-content: center; }

  /* Content area */
  .content { padding: 24px 28px; }

  /* Stats cards */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stat-card.all::before { background: var(--navy); }
  .stat-card.active::before { background: var(--success); }
  .stat-card.pending::before { background: var(--warning); }
  .stat-card.closed::before { background: var(--text-3); }
  .stat-label { font-size: 13px; color: var(--text-3); font-weight: 500; margin-bottom: 8px; }
  .stat-num { font-size: 32px; font-weight: 700; color: var(--navy); line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--text-3); margin-top: 6px; }
  .stat-icon { position: absolute; right: 16px; top: 16px; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
  .stat-card.all .stat-icon { background: rgba(15,31,61,0.08); }
  .stat-card.active .stat-icon { background: rgba(0,114,178,0.1); }
  .stat-card.pending .stat-icon { background: rgba(214,158,46,0.1); }
  .stat-card.closed .stat-icon { background: rgba(113,128,150,0.1); }

  /* Type badges */
  .type-chips { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 24px; }
  .type-chip { background: var(--surface); border-radius: 10px; padding: 14px 16px; border: 1px solid var(--border); cursor: pointer; transition: all 0.18s; }
  .type-chip:hover { border-color: var(--navy); transform: translateY(-1px); }
  .type-chip.selected { border-color: var(--gold); background: rgba(201,168,76,0.06); }
  .type-chip-label { font-size: 13px; color: var(--text-3); margin-bottom: 4px; }
  .type-chip-count { font-size: 24px; font-weight: 700; }
  .type-chip.labor .type-chip-count { color: #2b6cb0; }
  .type-chip.injury-ins .type-chip-count { color: #D55E00; }
  .type-chip.farmer .type-chip-count { color: #0072B2; }
  .type-chip.civil .type-chip-count { color: #0EA5B0; }
  .type-chip.injury .type-chip-count { color: #dd6b20; }
  .type-chip.commercial .type-chip-count { color: #6b46c1; }
  .type-chip.dispute .type-chip-count { color: #4a5568; }

  /* Table */
  .table-card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
  .table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .search-box { display: flex; align-items: center; gap: 8px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; flex: 1; max-width: 300px; }
  .search-box input { border: none; background: transparent; font-family: inherit; font-size: 13px; color: var(--text); outline: none; width: 100%; }
  .search-box input::placeholder { color: var(--text-3); }
  table { width: 100%; border-collapse: collapse; }
  th { background: var(--surface-2); color: var(--text-3); font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 13px 16px; font-size: 13px; color: var(--text); border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(15,31,61,0.025); cursor: pointer; }
  
  /* Badges */
  .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-blue { background: rgba(43,108,176,0.12); color: #2b6cb0; }
  .badge-red { background: rgba(213,94,0,0.12); color: #D55E00; }
  .badge-purple { background: rgba(107,70,193,0.12); color: #6b46c1; }
  .badge-green { background: rgba(0,114,178,0.12); color: #0072B2; }
  .badge-yellow { background: rgba(214,158,46,0.12); color: #b7791f; }
  .badge-gray { background: rgba(113,128,150,0.12); color: #4a5568; }
  .badge-teal { background: rgba(14,165,176,0.12); color: #0EA5B0; }
  .badge-orange { background: rgba(221,107,32,0.12); color: #dd6b20; }
  
  /* Status pill */
  .status-active { background: rgba(0,114,178,0.12); color: #0072B2; }
  .status-pending { background: rgba(214,158,46,0.15); color: #b7791f; }
  .status-review { background: rgba(43,108,176,0.12); color: #2b6cb0; }
  .status-mediation { background: rgba(14,165,176,0.12); color: #0EA5B0; }
  .status-lawsuit { background: rgba(213,94,0,0.12); color: #D55E00; }
  .status-closed { background: rgba(113,128,150,0.12); color: #4a5568; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(15,31,61,0.45); backdrop-filter: blur(2px); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .modal { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-lg); width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto; }
  .modal-head { padding: 22px 24px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--surface); z-index: 1; }
  .modal-head h2 { font-size: 15px; font-weight: 700; color: var(--navy); }
  .modal-body { padding: 22px 24px; }
  .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-full { grid-column: 1/-1; }
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label { font-size: 13px; font-weight: 600; color: var(--text-2); }
  .field input, .field select, .field textarea { padding: 9px 12px; border: 1px solid var(--border); border-radius: 7px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--surface); outline: none; transition: border 0.18s; }
  .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--navy); box-shadow: 0 0 0 3px rgba(15,31,61,0.08); }
  .field textarea { resize: vertical; min-height: 80px; }
  .section-divider { margin: 18px 0 14px; padding-bottom: 8px; border-bottom: 2px solid var(--border); font-size: 13px; font-weight: 700; color: var(--navy); letter-spacing: 0.5px; text-transform: uppercase; }

  /* Detail view */
  .detail-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
  .detail-main {}
  .detail-aside {}
  .card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
  .track-highlight { box-shadow: 0 0 0 3px rgba(0,114,178,0.4), var(--shadow); border-color: #0072B2; transition: box-shadow 0.2s, border-color 0.2s; }
  .card-head { padding: 14px 18px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; color: var(--navy); display: flex; align-items: center; justify-content: space-between; }
  .card-body { padding: 16px 18px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .info-item label { font-size: 11px; color: var(--text-3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
  .info-item value, .info-item .val { display: block; font-size: 13px; color: var(--text); margin-top: 3px; font-weight: 500; }
  
  /* Timeline */
  .timeline { list-style: none; padding-left: 0; }
  .timeline li { position: relative; padding: 0 0 20px 32px; }
  .timeline li::before { content: ''; position: absolute; left: 10px; top: 20px; bottom: 0; width: 1px; background: var(--border); }
  .timeline li:last-child::before { display: none; }
  .timeline-dot { position: absolute; left: 4px; top: 4px; width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--navy); background: var(--surface); }
  .timeline-dot.done { background: var(--success); border-color: var(--success); }
  .timeline-dot.active { background: var(--gold); border-color: var(--gold); }
  .timeline-date { font-size: 11px; color: var(--text-3); font-weight: 500; }
  .timeline-stage { font-size: 13px; font-weight: 700; color: var(--navy); margin: 2px 0; }
  .timeline-desc { font-size: 13px; color: var(--text-2); }
  .timeline-next { font-size: 11px; color: var(--teal); margin-top: 4px; }

  /* Deadline alert */
  .deadline-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; border: 1px solid; }
  .deadline-urgent { background: rgba(213,94,0,0.06); border-color: rgba(213,94,0,0.25); }
  .deadline-soon { background: rgba(214,158,46,0.06); border-color: rgba(214,158,46,0.25); }
  .deadline-ok { background: rgba(0,114,178,0.06); border-color: rgba(0,114,178,0.2); }
  .deadline-label { font-size: 13px; font-weight: 600; }
  .deadline-days { font-size: 13px; font-weight: 700; padding: 2px 10px; border-radius: 12px; }
  .days-urgent { background: rgba(213,94,0,0.15); color: #D55E00; }
  .days-soon { background: rgba(214,158,46,0.15); color: #b7791f; }
  .days-ok { background: rgba(0,114,178,0.12); color: #0072B2; }

  /* Empty state */
  .empty { text-align: center; padding: 60px 20px; color: var(--text-3); }
  .empty svg { width: 48px; height: 48px; margin: 0 auto 12px; opacity: 0.3; }
  .empty p { font-size: 13px; }

  /* Progress bar */
  .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 6px; }
  .progress-fill { height: 100%; border-radius: 3px; background: var(--gold); }

  /* Amount */
  .amount { font-family: 'Playfair Display', serif; }

  /* Tabs */
  .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; gap: 0; }
  .tab { padding: 10px 18px; font-size: 13px; font-weight: 500; color: var(--text-3); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.18s; }
  .tab:hover { color: var(--navy); }
  .tab.active { color: var(--navy); border-bottom-color: var(--gold); font-weight: 700; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  
  /* Misc */
  .text-muted { color: var(--text-3); font-size: 11px; }
  .divider { height: 1px; background: var(--border); margin: 16px 0; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: var(--surface-2); color: var(--text-2); border: 1px solid var(--border); margin: 2px; }

  @media (max-width: 1100px) {
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .type-chips { grid-template-columns: repeat(2,1fr); }
    .detail-grid { grid-template-columns: 1fr; }
  }

  /* Tablet (iPad Pro 12.9 landscape = 1366px) */
  @media (max-width: 1400px) {
    .sidebar { width: 260px; font-size: 120%; }
    .sidebar .nav-item { font-size: 15px; padding: 13px 12px; }
    .sidebar-logo h1 { font-size: 21px; }
    .sidebar-logo p { font-size: 15px; }
    .nav-label { font-size: 13px; }
    #sidebar-date { font-size: 15px !important; }
    .sidebar-footer p { font-size: 13px; }
    .content { font-size: 16px; }
    .content .card-head { font-size: 16px; }
    .content .stats-grid .stat-number { font-size: 32px; }
    .content .stats-grid .stat-label { font-size: 15px; }
    .content .type-chips { font-size: 15px; }
    .content .type-chip-label { font-size: 15px; }
    .content .type-chip-count { font-size: 22px; }
    .content .deadline-label { font-size: 15px; }
    .content .deadline-item div[style*="font-size:11px"] { font-size: 13px !important; }
    .content .badge { font-size: 11px; }
    .content th, .content td { font-size: 15px; }
    .topbar { font-size: 18px; }
    .topbar .topbar-title { font-size: 20px; }
    .topbar .btn { font-size: 15px; padding: 10px 20px; }
    .modal-overlay .modal { font-size: 15px; }
    .modal-overlay .modal-head h2 { font-size: 20px; }
    .modal-overlay .modal label { font-size: 15px; }
    .modal-overlay .modal input,
    .modal-overlay .modal select,
    .modal-overlay .modal textarea { font-size: 15px; }
    .modal-overlay .modal .btn { font-size: 15px; }
    .content [style*="grid-template-columns:1fr 3"],
    .content [style*="grid-template-columns:1fr 2"] { display: block !important; }
    .content [style*="grid-template-columns:1fr 3"] > div,
    .content [style*="grid-template-columns:1fr 2"] > div { margin-bottom: 16px; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .type-chips { grid-template-columns: repeat(2,1fr); }
    .detail-grid { grid-template-columns: 1fr; }
  }

  /* â”€â”€â”€ Mobile â”€â”€â”€ */
  .mobile-menu-btn { display: none; background: none; border: none; cursor: pointer; padding: 6px; color: var(--navy); }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 49; }

  @media (max-width: 768px) {
    html { font-size: 18px; }
    .app { flex-direction: column; }
    .sidebar {
      position: fixed; left: -260px; top: 0; bottom: 0; width: 250px; z-index: 50;
      transition: left 0.25s ease; box-shadow: none;
    }
    .sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
    .sidebar-overlay.open { display: block; }
    .mobile-menu-btn { display: block; }
    .main { width: 100%; }
    .topbar { padding: 0 14px; height: auto; min-height: 50px; flex-wrap: wrap; gap: 8px; padding-top: 10px; padding-bottom: 10px; -webkit-text-size-adjust: 135%; }
    .topbar-title { font-size: 22px; width: 100%; }
    .topbar-actions { width: 100%; flex-wrap: wrap; }
    .topbar .btn { font-size: 16px; padding: 10px 18px; }
    .content { padding: 14px; font-size: 16px; -webkit-text-size-adjust: 135%; }
    .modal-overlay { padding: 10px; }
    .modal-overlay .modal { font-size: 16px; }
    .modal-overlay .modal-head h2 { font-size: 20px; }
    .modal-overlay .modal input,
    .modal-overlay .modal select,
    .modal-overlay .modal textarea { font-size: 16px; }
    .modal-overlay .modal .btn { font-size: 16px; }
    .modal-overlay .modal label { font-size: 15px; }
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
    .type-chips { grid-template-columns: 1fr; }
    .stat-card { padding: 14px; }
    .stat-card .num { font-size: 28px; }
    .stat-card .label { font-size: 15px; }
    .form-grid { grid-template-columns: 1fr; }
    .form-grid.cols-3 { grid-template-columns: 1fr; }
    .info-grid { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr; }
    .content > div[style*="grid-template-columns"] { display: block !important; }
    .content > div[style*="grid-template-columns"] > div { margin-bottom: 16px; }
    .content [style*="grid-template-columns:1fr 3"],
    .content [style*="grid-template-columns:1fr 2"] { display: block !important; }
    .content [style*="grid-template-columns:1fr 3"] > div,
    .content [style*="grid-template-columns:1fr 2"] > div { margin-bottom: 16px; }
    .card-body [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
    .card-body [style*="grid-template-columns:repeat(3"] { grid-template-columns: 1fr !important; }
    .table-card { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 700px; }
    table th, table td { font-size: 15px; padding: 10px 12px; }
    .modal { max-width: 100%; margin: 10px; border-radius: 12px; }
    .modal-head { padding: 16px; }
    .modal-head h2 { font-size: 20px; }
    .modal-body { padding: 16px; font-size: 16px; }
    .modal-foot { padding: 12px 16px; }
    .card-head { font-size: 16px; }
    .card-body { padding: 14px 16px; font-size: 15px; }
    .field label { font-size: 15px; }
    .field input, .field select, .field textarea { font-size: 16px; }
    .btn { font-size: 15px; padding: 10px 18px; }
    .badge { font-size: 13px; }
    .nav-item { font-size: 16px; padding: 12px 10px; }
  }

  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr; }
    .topbar-actions { gap: 6px; }
    .topbar-actions .btn { font-size: 15px; padding: 8px 12px; }
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo" onclick="navigate('dashboard')" style="cursor:pointer">
      <h1>å€‹æ¡ˆç®¡ç†ç³»çµ±</h1>
      <p>å‹ä¿ãƒ»è·ç½ãƒ»å•†æ¥­ä¿éšªãƒ»å‹è³‡çˆ­è­°</p>
      <div id="sidebar-date" style="color:var(--text-2);font-size:11px;margin-top:8px;font-weight:500"></div>
    </div>
    <div class="nav-section">
      <div class="nav-label">ä¸»è¦åŠŸèƒ½</div>
      <div class="nav-item active" onclick="navigate('dashboard')" id="nav-dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        å€‹æ¡ˆç¸½è¦½
      </div>
      <div class="nav-item" onclick="navigate('cases')" id="nav-cases">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        å€‹æ¡ˆæ¸…å–®
      </div>
      <div class="nav-item" onclick="navigate('deadlines')" id="nav-deadlines">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        æœŸé™ç®¡ç†
      </div>
      <div class="nav-item" onclick="progressView='list';navigate('progress')" id="nav-progress-list">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        é€²åº¦æ¸…å–®è¡¨
      </div>
      <div class="nav-item" onclick="progressView='calendar';navigate('progress')" id="nav-progress-calendar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        é€²åº¦è¡Œäº‹æ›†
      </div>
      <div class="nav-item" onclick="navigate('todos')" id="nav-todos">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        å¾…è¾¦äº‹é …
      </div>
      <div class="nav-item" onclick="navigate('gcal')" id="nav-gcal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="12" cy="15" r="2"/></svg>
        Google è¡Œäº‹æ›†
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">è³‡æ–™ç®¡ç†</div>
      <div class="nav-item" onclick="navigate('archive')" id="nav-archive">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
        æ­¸æª”èˆ‡å‚™ä»½
      </div>
    </div>
    <div class="sidebar-footer">
      <p><span id="sync-indicator" style="cursor:pointer" onclick="navigate('archive')" title="é›²ç«¯åŒæ­¥ç‹€æ…‹">â˜ï¸</span> è³‡æ–™è‡ªå‹•åŒæ­¥</p>
    </div>
  </nav>

  <!-- Main -->
  <div class="main" id="main-content">
    <!-- Content renders here via JS -->
  </div>

</div>

<script>
// â”€â”€â”€ Data Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = 'case_mgmt_v4';

const defaultCases = [];

// è¿½è¹¤è»¸ï¼šæ¯å€‹æ¡ˆä»¶å¯æœ‰å¤šæ¢ä¸¦è¡Œè¿½è¹¤è»¸
const defaultTracks = [];


function loadData() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (s) return JSON.parse(s);
  } catch(e) {}
  return { cases: defaultCases, tracks: defaultTracks, progress: [] };
}
function saveData(data) {
  data._date = new Date().toISOString();
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
  // è‡ªå‹•ä¸Šå‚³åˆ° GitHubï¼ˆèƒŒæ™¯éœé»˜ï¼‰
  ghAutoSync(data);
}
var _ghSyncTimer = null;
function ghAutoSync(data) {
  // é˜²æŠ–ï¼š2ç§’å…§å¤šæ¬¡å„²å­˜åªæ¨ä¸€æ¬¡
  clearTimeout(_ghSyncTimer);
  _ghSyncTimer = setTimeout(function() { ghPushSilent(data); }, 2000);
}
let db = loadData();
if (!db.cases) db.cases = defaultCases;
if (!db.tracks) db.tracks = defaultTracks;
if (!db.progress) db.progress = [];
if (!db.todos) db.todos = [];
var _pid = 1;
db.progress.forEach(function(p){ if (!p.id) p.id = 'P' + String(_pid++).padStart(4,'0'); });
function genProgressId() {
  var nums = db.progress.map(function(p){ return parseInt((p.id||'').slice(1))||0; });
  return 'P' + String((nums.length ? Math.max.apply(null,nums) : 0) + 1).padStart(4,'0');
}
function genTrackId(caseId) {
  const prefix = 'TR-' + caseId + '-';
  const nums = db.tracks.filter(t => t.id.startsWith(prefix)).map(t => parseInt(t.id.slice(prefix.length))||0);
  const max = nums.length ? Math.max(...nums) : 0;
  return prefix + (max + 1);
}
function genTodoId() {
  const nums = db.todos.map(t => parseInt((t.id||'').slice(1))||0);
  return 'T' + String((nums.length ? Math.max(...nums) : 0) + 1).padStart(4,'0');
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const typeColor = {
  'å‹å·¥ä¿éšªçµ¦ä»˜':'badge-blue','è·ç½ä¿éšªçµ¦ä»˜':'badge-red','è¾²ä¿çµ¦ä»˜':'badge-green','å…¬ä¿çµ¦ä»˜':'badge-teal',
  'è·ç½è£œå„Ÿè³ å„Ÿ':'badge-orange','å•†æ¥­ä¿éšªç†è³ ':'badge-purple','å‹è³‡çˆ­è­°äº‹é …':'badge-gray',
  'å‹ä¿ç”Ÿè‚²çµ¦ä»˜':'badge-blue','å‹ä¿å‚·ç—…çµ¦ä»˜':'badge-blue','å‹ä¿å¤±èƒ½çµ¦ä»˜':'badge-blue','å‹ä¿è€å¹´çµ¦ä»˜':'badge-blue','å‹ä¿æ­»äº¡çµ¦ä»˜':'badge-blue',
  'è·ä¿é†«ç™‚çµ¦ä»˜':'badge-red','è·ä¿å‚·ç—…çµ¦ä»˜':'badge-red','è·ä¿å¤±èƒ½çµ¦ä»˜':'badge-red','è·ä¿æ­»äº¡çµ¦ä»˜':'badge-red',
  'çˆ­è­°å¯©è­°è¨´é¡˜':'badge-gray','è»Šç¦è™•ç†ç¨‹åº':'badge-red','è·ç½è£œå„Ÿè³ å„Ÿ':'badge-orange','å‹è³‡çˆ­è­°äº‹é …':'badge-gray',
  'å£½éšª':'badge-purple','é†«ç™‚éšª':'badge-purple','æ„å¤–éšª':'badge-purple','å¤±èƒ½éšª':'badge-purple','é•·ç…§éšª':'badge-purple','å¼·åˆ¶éšª':'badge-purple'
};
const statusColor = {
  'æœªç”³è«‹': 'status-pending', 'å¾…è£œä»¶': 'status-pending', 'å¯©æ ¸ä¸­': 'status-review',
  'å·²çµ¦ä»˜': 'status-closed', 'å·²æ‹’è³ ': 'status-lawsuit', 'ç”³è¨´ä¸­': 'status-active',
  'è©•è­°ä¸­': 'status-review', 'æœªèª¿è§£': 'status-pending', 'å·²èª¿è§£å®Œæˆ': 'status-closed',
  'èª¿è§£ä¸æˆç«‹': 'status-lawsuit', 'åµæŸ¥åº­': 'status-mediation', 'åˆ‘äº‹è¨´è¨Ÿ': 'status-lawsuit',
  'æ°‘äº‹è¨´è¨Ÿ': 'status-lawsuit', 'çˆ­è­°å¯©è­°': 'status-active', 'è¨´é¡˜ä¸­': 'status-active', 'æ’¤æ¡ˆ': 'status-closed'
};
const stageColor = {
  'æœªç”³è«‹': 'badge-gray', 'å¾…è£œä»¶': 'badge-yellow', 'å¯©æ ¸ä¸­': 'badge-orange',
  'å·²çµ¦ä»˜': 'badge-green', 'å·²æ‹’è³ ': 'badge-red', 'ç”³è¨´ä¸­': 'badge-blue',
  'è©•è­°ä¸­': 'badge-orange', 'æœªèª¿è§£': 'badge-gray', 'å·²èª¿è§£å®Œæˆ': 'badge-green',
  'èª¿è§£ä¸æˆç«‹': 'badge-red', 'åµæŸ¥åº­': 'badge-teal', 'åˆ‘äº‹è¨´è¨Ÿ': 'badge-red',
  'æ°‘äº‹è¨´è¨Ÿ': 'badge-red', 'çˆ­è­°å¯©è­°': 'badge-blue', 'è¨´é¡˜ä¸­': 'badge-blue', 'æ’¤æ¡ˆ': 'badge-gray'
};
function fmt(n) { return n ? parseInt(n).toLocaleString('zh-TW') : '-'; }
function fmtDate(d) {
  if (!d) return '-';
  const parts = d.split('-');
  if (parts.length !== 3) return d;
  const roc = parseInt(parts[0]) - 1911;
  return roc + 'å¹´' + parts[1] + 'æœˆ' + parts[2] + 'æ—¥';
}
function fmtDateTime(dt) {
  if (!dt) return '';
  const datePart = dt.includes('T') ? dt.split('T')[0] : dt;
  return fmtDate(datePart);
}
function rocHint(inputId) {
  const el = document.getElementById(inputId);
  if (!el || !el.value) return '';
  return fmtDate(el.value);
}
function daysUntil(d) {
  if (!d) return null;
  const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
  return diff;
}
function daysBadge(days) {
  if (days === null) return '';
  if (days < 0) return `<span class="badge badge-red">å·²é€¾æœŸ ${Math.abs(days)} å¤©</span>`;
  if (days <= 14) return `<span class="days-urgent deadline-days">${days} å¤©å¾Œ</span>`;
  if (days <= 30) return `<span class="days-soon deadline-days">${days} å¤©å¾Œ</span>`;
  return `<span class="days-ok deadline-days">${days} å¤©å¾Œ</span>`;
}
function genId() {
  const ids = db.cases.map(c => c.id).filter(id => /^A\d+$/.test(id)).map(id => parseInt(id.slice(1)));
  const max = ids.length ? Math.max(...ids) : 0;
  return 'A' + String(max + 1).padStart(3, '0');
}

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentView = 'dashboard';
let selectedCase = null;
let filterType = null;
let filterStatus = null;
let searchQuery = '';
let caseSortBy = null; // 'id','status','deadline','planned'
let caseSortDir = 'asc';
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-based
let progressView = 'list';
let progressFilter = '';

function navigate(view, caseId = null) {
  if (view !== 'cases') filterStatus = null;
  currentView = view;
  selectedCase = caseId;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  let navId = view === 'case-detail' ? 'cases' : view;
  if (view === 'progress') navId = 'progress-' + progressView;
  const nav = document.getElementById('nav-' + navId);
  if (nav) nav.classList.add('active');
  // æ‰‹æ©Ÿç‰ˆï¼šé—œé–‰å´æ¬„
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  render();
}

function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
}

function render() {
  const main = document.getElementById('main-content');
  main.innerHTML = views[currentView]();
  // æ’å…¥æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ•
  const topbar = main.querySelector('.topbar');
  if (topbar) {
    const btn = document.createElement('button');
    btn.className = 'mobile-menu-btn';
    btn.onclick = toggleSidebar;
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    topbar.insertBefore(btn, topbar.firstChild);
  }
  // æ›´æ–°å´æ¬„æ—¥æœŸ
  const _d = new Date();
  const _wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const sdEl = document.getElementById('sidebar-date');
  if (sdEl) sdEl.textContent = (_d.getFullYear()-1911) + 'å¹´' + String(_d.getMonth()+1).padStart(2,'0') + 'æœˆ' + String(_d.getDate()).padStart(2,'0') + 'æ—¥ æ˜ŸæœŸ' + _wd[_d.getDay()];
}

// â”€â”€â”€ Views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const views = {

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dashboard() {
  const cases = db.cases;
  const total = cases.length;
  const active = cases.filter(c => c.status === 'é€²è¡Œä¸­').length;
  const pending = cases.filter(c => c.status === 'å¾…è£œä»¶').length;
  const closed = cases.filter(c => c.status === 'å·²çµ¦ä»˜' || c.status === 'å·²èª¿è§£å®Œæˆ' || c.status === 'å·²çµæ¡ˆ' || c.status === 'æ’¤æ¡ˆ').length;
  const typeGroups = [
    { label:'å‹å·¥ä¿éšª', cls:'labor', types:['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'è·ç½ä¿éšª', cls:'injury-ins', types:['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'å…¬ä¿è¾²ä¿', cls:'farmer', types:['è¾²ä¿çµ¦ä»˜','å…¬ä¿çµ¦ä»˜'] },
    { label:'è»Šç¦è·ç½çˆ­è­°', cls:'dispute', types:['è»Šç¦è™•ç†ç¨‹åº','çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'] },
    { label:'å•†æ¥­ä¿éšª', cls:'commercial', types:['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª','å¼·åˆ¶éšª'] },
  ];
  
  const deadlines = cases.filter(c => (c.deadline || c.plannedDate) && c.status !== 'å·²çµ¦ä»˜' && c.status !== 'å·²èª¿è§£å®Œæˆ')
    .filter(c => {
      const d1 = c.deadline ? daysUntil(c.deadline) : null;
      const d2 = c.plannedDate ? daysUntil(c.plannedDate) : null;
      return (d1 !== null && d1 <= 45) || (d2 !== null && d2 <= 45);
    })
    .sort((a,b) => {
      const da = Math.min(a.deadline ? daysUntil(a.deadline) : 999, a.plannedDate ? daysUntil(a.plannedDate) : 999);
      const db2 = Math.min(b.deadline ? daysUntil(b.deadline) : 999, b.plannedDate ? daysUntil(b.plannedDate) : 999);
      return da - db2;
    });

  const _now = new Date();
  const rocY = _now.getFullYear() - 1911;
  const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const today = rocY + 'å¹´' + String(_now.getMonth()+1).padStart(2,'0') + 'æœˆ' + String(_now.getDate()).padStart(2,'0') + 'æ—¥ æ˜ŸæœŸ' + weekdays[_now.getDay()];

  return `
  <div class="topbar">
    <div class="topbar-title">å€‹æ¡ˆç¸½è¦½</div>
    <div class="topbar-actions">
      <button class="btn btn-gold" onclick="openNewCase()">ï¼‹ æ–°å¢å€‹æ¡ˆ</button>
    </div>
  </div>
  <div class="content">
    <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px">ğŸ“Š æ¡ˆä»¶ç‹€æ…‹çµ±è¨ˆ</div>
    <div class="stats-grid">
      <div class="stat-card all" onclick="navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0f1f3d" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <div class="stat-label">å…¨éƒ¨å€‹æ¡ˆ</div>
        <div class="stat-num">${total}</div>
        
      </div>
      <div class="stat-card active" onclick="filterStatus='é€²è¡Œä¸­';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0072B2" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div class="stat-label">é€²è¡Œä¸­</div>
        <div class="stat-num" style="color:#0072B2">${active}</div>
        
      </div>
      <div class="stat-card pending" onclick="filterStatus='å¾…è£œä»¶';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#b7791f" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <div class="stat-label">å¾…è£œä»¶</div>
        <div class="stat-num" style="color:#b7791f">${pending}</div>
        
      </div>
      <div class="stat-card closed" onclick="filterStatus='_closed';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4a5568" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
        <div class="stat-label">å·²çµæ¡ˆ/å®Œæˆ</div>
        <div class="stat-num" style="color:#4a5568">${closed}</div>
        
      </div>
    </div>

    <div style="font-size:13px;font-weight:700;color:var(--navy);margin:16px 0 8px">ğŸ“‚ æ¡ˆä»¶é¡å‹åˆ†ä½ˆ</div>
    <div class="type-chips">
      ${typeGroups.map(g => `
        <div class="type-chip ${g.cls}" onclick='filterType=${JSON.stringify(g.types)};navigate("cases")' style="cursor:pointer">
          <div class="type-chip-label">${g.label}</div>
          <div class="type-chip-count">${cases.filter(c=>g.types.includes(c.type)).length}</div>
        </div>
      `).join('')}
    </div>

    <div style="display:grid;grid-template-columns:1fr 380px;gap:20px">
      <div>
        <div class="table-card">
          <div class="table-header">
            <div style="font-size:15px;font-weight:700;color:var(--navy)">â° è¿‘æœŸæœŸé™ï¼ˆ45å¤©å…§ï¼‰</div>
          </div>
          ${deadlines.length === 0 ? '<div class="empty"><p>è¿‘æœŸç„¡åˆ°æœŸäº‹é …</p></div>' : `
          <div style="padding:12px 16px">
            ${deadlines.map(c => {
              const rows = [];
              if (c.deadline && daysUntil(c.deadline) <= 45) {
                const days = daysUntil(c.deadline);
                const cls = days <= 14 ? 'deadline-urgent' : days <= 30 ? 'deadline-soon' : 'deadline-ok';
                rows.push(`<div class="deadline-item ${cls}" onclick="navigate('case-detail','${c.id}')" style="cursor:pointer">
                  <div>
                    <div class="deadline-label">${c.name} <span style="font-size:11px;color:#D55E00;font-weight:700;margin-left:6px">âš ï¸ æˆªæ­¢æ—¥æœŸ</span></div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:2px">${c.deadlineNote} Â· ${fmtDate(c.deadline)}</div>
                  </div>
                  ${daysBadge(days)}
                </div>`);
              }
              if (c.plannedDate && daysUntil(c.plannedDate) <= 45) {
                const days2 = daysUntil(c.plannedDate);
                const cls2 = days2 <= 7 ? 'deadline-soon' : 'deadline-ok';
                rows.push(`<div class="deadline-item ${cls2}" onclick="navigate('case-detail','${c.id}')" style="cursor:pointer">
                  <div>
                    <div class="deadline-label">${c.name} <span style="font-size:11px;color:#0EA5B0;font-weight:700;margin-left:6px">ğŸ“‹ é è¨ˆå®Œæˆ</span></div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:2px">${c.plannedDateNote} Â· ${fmtDate(c.plannedDate)}</div>
                  </div>
                  ${daysBadge(days2)}
                </div>`);
              }
              return rows.join('');
            }).join('')}
          </div>`}
        </div>
      </div>
      <div>
        <div class="table-card">
          <div class="table-header"><div style="font-size:15px;font-weight:700;color:var(--navy)">æœ€è¿‘æ›´æ–°å€‹æ¡ˆ</div></div>
          <div>
            ${[...db.cases].sort((a,b) => b.updated.localeCompare(a.updated)).slice(0,5).map(c => `
              <div onclick="navigate('case-detail','${c.id}')" style="padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseenter="this.style.background='rgba(15,31,61,0.025)'" onmouseleave="this.style.background=''">
                <div style="display:flex;align-items:center;justify-content:space-between">
                  <div style="font-size:13px;font-weight:600">${c.name} <span style="color:var(--text-3);font-weight:400">${c.id}</span></div>
                  <span class="badge ${statusColor[c.status]}">${c.status}</span>
                </div>
                <div style="font-size:11px;color:var(--text-3);margin-top:3px">${c.type} Â· æ›´æ–°ï¼š${fmtDate(c.updated)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  </div>`;
},

// â”€â”€ Cases List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cases() {
  let list = db.cases;
  if (filterType) {
    if (Array.isArray(filterType)) list = list.filter(c => filterType.includes(c.type));
    else list = list.filter(c => c.type === filterType);
  }
  if (filterStatus === '_closed') list = list.filter(c => c.status === 'å·²çµ¦ä»˜' || c.status === 'å·²èª¿è§£å®Œæˆ' || c.status === 'å·²çµæ¡ˆ' || c.status === 'æ’¤æ¡ˆ');
  else if (filterStatus) list = list.filter(c => c.status === filterStatus);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    list = list.filter(c => c.name.includes(q) || c.id.toLowerCase().includes(q) || c.employer.includes(q) || (c.insuredUnit||'').includes(q) || (c.insurer||'').includes(q));
  }
  // æ’åº
  if (caseSortBy) {
    list = [...list].sort((a, b) => {
      let va, vb;
      if (caseSortBy === 'id') { va = a.id; vb = b.id; }
      else if (caseSortBy === 'status') { va = a.status||''; vb = b.status||''; }
      else if (caseSortBy === 'deadline') { va = a.deadline||'9999'; vb = b.deadline||'9999'; }
      else if (caseSortBy === 'planned') { va = a.plannedDate||'9999'; vb = b.plannedDate||'9999'; }
      if (va < vb) return caseSortDir === 'asc' ? -1 : 1;
      if (va > vb) return caseSortDir === 'asc' ? 1 : -1;
      return 0;
    });
  }
  const typeFilterGroups = [
    { label:'å‹å·¥ä¿éšª', types:['å‹å·¥ä¿éšªçµ¦ä»˜','å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'è·ç½ä¿éšª', types:['è·ç½ä¿éšªçµ¦ä»˜','è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'å…¬ä¿è¾²ä¿', types:['è¾²ä¿çµ¦ä»˜','å…¬ä¿çµ¦ä»˜'] },
    { label:'è»Šç¦è·ç½çˆ­è­°', types:['è»Šç¦è™•ç†ç¨‹åº','çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'] },
    { label:'å•†æ¥­ä¿éšª', types:['å•†æ¥­ä¿éšªç†è³ ','å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª','å¼·åˆ¶éšª'] },
  ];
  const statusLabel = filterStatus ? ' Â· ç¯©é¸ï¼š'+(filterStatus==='_closed'?'å·²çµæ¡ˆ/å®Œæˆ':filterStatus) : '';
  return `
  <div class="topbar">
    <div class="topbar-title">å€‹æ¡ˆæ¸…å–® <span class="text-muted">ï¼ˆ${list.length} ç­†${statusLabel}ï¼‰</span></div>
    <div class="topbar-actions">
      ${filterStatus ? '<button class="btn btn-outline btn-sm" onclick="filterStatus=null;render()">âœ• æ¸…é™¤ç‹€æ…‹ç¯©é¸</button>' : ''}
      <button class="btn btn-gold" onclick="openNewCase()">ï¼‹ æ–°å¢å€‹æ¡ˆ</button>
    </div>
  </div>
  <div class="content">
    <div class="table-card">
      <div class="table-header">
        <div class="search-box">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="æœå°‹å§“åã€ç·¨è™Ÿã€å—åƒ±å…¬å¸ã€æŠ•ä¿å–®ä½..." value="${searchQuery}"
            oninput="searchQuery=this.value;render()" />
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm ${!filterType?'btn-primary':'btn-outline'}" onclick="filterType=null;render()">å…¨éƒ¨</button>
          ${typeFilterGroups.map(g => {
            const isActive = Array.isArray(filterType) && JSON.stringify(filterType) === JSON.stringify(g.types);
            return '<button class="btn btn-sm '+(isActive?'btn-primary':'btn-outline')+'" onclick=\'filterType='+JSON.stringify(g.types)+';render()\'>'+g.label+'</button>';
          }).join('')}
        </div>
      </div>
      <table>
        <thead><tr>
          <th style="cursor:pointer" onclick="if(caseSortBy==='id')caseSortDir=caseSortDir==='asc'?'desc':'asc';else{caseSortBy='id';caseSortDir='asc';}render()">å€‹æ¡ˆç·¨è™Ÿ ${caseSortBy==='id'?(caseSortDir==='asc'?'â–²':'â–¼'):''}</th><th>ç•¶äº‹äºº</th><th>å€‹æ¡ˆé¡å‹</th>
          <th>å—åƒ±å…¬å¸/ä¿éšªå…¬å¸</th><th style="cursor:pointer" onclick="if(caseSortBy==='status')caseSortDir=caseSortDir==='asc'?'desc':'asc';else{caseSortBy='status';caseSortDir='asc';}render()">æ¥æ¡ˆç‹€æ…‹ ${caseSortBy==='status'?(caseSortDir==='asc'?'â–²':'â–¼'):''}</th><th style="color:#0EA5B0;cursor:pointer" onclick="if(caseSortBy==='planned')caseSortDir=caseSortDir==='asc'?'desc':'asc';else{caseSortBy='planned';caseSortDir='asc';}render()">ğŸ“‹ é è¨ˆå®Œæˆ ${caseSortBy==='planned'?(caseSortDir==='asc'?'â–²':'â–¼'):''}</th><th style="color:#D55E00;cursor:pointer" onclick="if(caseSortBy==='deadline')caseSortDir=caseSortDir==='asc'?'desc':'asc';else{caseSortBy='deadline';caseSortDir='asc';}render()">âš ï¸ æˆªæ­¢æ—¥æœŸ ${caseSortBy==='deadline'?(caseSortDir==='asc'?'â–²':'â–¼'):''}</th>
          <th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
        ${list.length === 0 ? `<tr><td colspan="8"><div class="empty"><p>æ‰¾ä¸åˆ°ç¬¦åˆçš„å€‹æ¡ˆ</p></div></td></tr>` :
          list.map(c => {
            const days = daysUntil(c.deadline);
            const daysP = daysUntil(c.plannedDate);
            return `
            <tr onclick="navigate('case-detail','${c.id}')">
              <td><span style="font-family:'Playfair Display';font-weight:600;color:var(--navy)">${c.id}</span></td>
              <td><strong>${c.name}</strong></td>
              <td><span class="badge ${typeColor[c.type]}">${c.type}</span></td>
              <td style="max-width:140px"><div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px">${c.employer}</div>${c.insurer?`<div style="font-size:11px;color:var(--text-3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px">${c.insurer}</div>`:""}</td>
              <td><span class="badge ${statusColor[c.status]}">${c.status}</span></td>
              <td>${c.plannedDate ? `<div style="font-size:13px;font-weight:600;color:#0EA5B0">${fmtDate(c.plannedDate)}</div><div style="font-size:11px;color:var(--text-3)">${c.plannedDateNote}</div>${daysBadge(daysP)}` : '<span style="color:var(--text-3);font-size:11px">æœªè¨­å®š</span>'}</td>
              <td>${c.deadline ? `<div style="font-size:13px;font-weight:600;color:#D55E00">${fmtDate(c.deadline)}</div><div style="font-size:11px;color:var(--text-3)">${c.deadlineNote}</div>${daysBadge(days)}` : '<span style="color:var(--text-3);font-size:11px">æœªè¨­å®š</span>'}</td>
              <td onclick="event.stopPropagation()" style="white-space:nowrap">
                <button class="btn btn-outline btn-sm" onclick="openEditCase('${c.id}');event.stopPropagation()">ç·¨è¼¯</button>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
},

// â”€â”€ Case Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
'case-detail'() {
  const c = db.cases.find(x => x.id === selectedCase);
  if (!c) return '<div class="content"><p>æ‰¾ä¸åˆ°å€‹æ¡ˆ</p></div>';
  const tracks = db.tracks.filter(t => t.caseId === c.id);
  const totalAmount = tracks.reduce((s,t) => s + (parseInt(t.amount)||0), 0) || parseInt(c.amount)||0;
  const trackColors = ['#2b6cb0','#D55E00','#0072B2','#6b46c1','#E69F00','#0EA5B0','#b7791f'];
  const trackBgColors = ['rgba(43,108,176,0.06)','rgba(213,94,0,0.06)','rgba(0,114,178,0.06)',
    'rgba(107,70,193,0.06)','rgba(230,159,0,0.06)','rgba(14,165,176,0.06)','rgba(183,121,31,0.06)'];

  function renderTrack(tr, idx) {
    var col = trackColors[idx % trackColors.length];
    var bg = trackBgColors[idx % trackBgColors.length];
    var days = daysUntil(tr.deadline);
    var daysP = daysUntil(tr.plannedDate);

    var deadlineRow = tr.deadline
      ? '<div style="font-size:11px"><span style="color:#D55E00;font-weight:600">ğŸ”” æé†’æ—¥æœŸï¼š</span>'
        + fmtDate(tr.deadline) + ' ' + daysBadge(days) + '</div>' : '';
    var plannedRow = tr.plannedDate
      ? '<div style="font-size:11px"><span style="color:#0EA5B0;font-weight:600">ğŸ“‹ é è¨ˆå®Œæˆï¼š</span>'
        + fmtDate(tr.plannedDate) + ' ' + daysBadge(daysP) + '</div>' : '';

    var noteHtml = tr.note
      ? '<div style="font-size:11px;color:var(--text-2);padding:10px 12px;background:var(--surface-2);border-radius:6px;margin-bottom:10px">'+tr.note+'</div>' : '';

    return '<div class="card" id="track-'+tr.id+'" style="border-top:3px solid '+col+';margin-bottom:20px">'
      + '<div class="card-head" style="background:'+bg+';padding:14px 18px">'
      + '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'
      + '<div style="width:10px;height:10px;border-radius:50%;background:'+col+';flex-shrink:0"></div>'
      + '<span style="font-size:15px;font-weight:700;color:'+col+'">'+tr.name+'</span>'
      + '<span class="badge '+(typeColor[tr.type]||'badge-gray')+'">'+tr.type+'</span>'
      + '<span class="badge '+(statusColor[tr.status]||'badge-gray')+'">'+tr.status+'</span>'
      + '<span style="margin-left:auto;font-size:13px;font-weight:700;color:'+col+'" class="amount">NT$ '+fmt(tr.amount)+'</span>'
      + '</div>'
      + (deadlineRow||plannedRow ? '<div style="display:flex;gap:16px;margin-top:10px;flex-wrap:wrap">'+deadlineRow+plannedRow+'</div>' : '')
      + (tr.contact ? '<div style="margin-top:8px;font-size:11px;color:var(--text-2)">ğŸ‘¤ æ‰¿è¾¦ï¼š<strong>'+tr.contact+'</strong>'+(tr.contactPhone?' â˜ '+tr.contactPhone:'')+'</div>' : '')
      + '</div>'
      + '<div class="card-body" style="padding:12px 20px">'
      + noteHtml
      + '<div style="display:flex;gap:8px">'
      + '<button class="btn btn-outline btn-sm" style="flex:1;border-color:'+col+';color:'+col+'" onclick="_trackAction(this)" data-action="addProgress" data-case="'+c.id+'" data-track="'+tr.id+'">ï¼‹ æ–°å¢é€²åº¦</button>'
      + '</div></div></div>';
  }

  var tracksHtml = tracks.length === 0
    ? '<div class="card"><div class="card-body"><div class="empty"><p>å°šç„¡è¿½è¹¤è»¸</p>'
      + '<button class="btn btn-gold" style="margin-top:12px" onclick="_trackAction(this)" data-action="addTrack" data-case="'+c.id+'">ï¼‹ æ–°å¢ç¬¬ä¸€æ¢è¿½è¹¤è»¸</button>'
      + '</div></div></div>'
    : tracks.map(function(tr,i){ return renderTrack(tr,i); }).join('');

  var sidebarTracks = tracks.length === 0
    ? '<div class="text-muted" style="text-align:center;padding:12px;font-size:11px">å°šç„¡è¿½è¹¤è»¸</div>'
    : tracks.map(function(tr,i){
        var col2 = trackColors[i%trackColors.length];
        var bg2 = trackBgColors[i%trackBgColors.length];
        return '<div style="padding:8px 10px;border-radius:8px;margin-bottom:6px;background:'+bg2+';border:1px solid rgba(0,0,0,0.05)">'
          + '<div style="display:flex;align-items:center;gap:8px;cursor:pointer" onclick="_trackAction(this)" data-action="scrollTo" data-track="'+tr.id+'">'
          + '<div style="width:8px;height:8px;border-radius:50%;background:'+col2+';flex-shrink:0"></div>'
          + '<div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+tr.name+'</div>'
          + '<div style="font-size:11px;color:var(--text-3)">'+tr.type+'</div></div>'
          + '<span class="badge '+(statusColor[tr.status]||'badge-gray')+'" style="font-size:11px">'+tr.status+'</span>'
          + '</div>'
          + '<div style="display:flex;gap:4px;margin-top:6px;padding-left:16px">'
          + '<button class="btn btn-outline btn-sm" style="font-size:11px;padding:3px 8px" onclick="_trackAction(this)" data-action="editTrack" data-track="'+tr.id+'">âœï¸ ç·¨è¼¯</button>'
          + '<button class="btn btn-outline btn-sm" style="font-size:11px;padding:3px 8px" onclick="_trackAction(this)" data-action="copyTrack" data-track="'+tr.id+'">ğŸ“‹ è¤‡è£½</button>'
          + '<button class="btn btn-outline btn-sm" style="font-size:11px;padding:3px 8px;color:#D55E00" onclick="if(confirm(\'ç¢ºå®šåˆªé™¤è¿½è¹¤è»¸ã€Œ'+tr.name.replace(/'/g,"\\'")+'ã€ï¼Ÿ\'))deleteTrack(\''+tr.id+'\')">ğŸ—‘ åˆªé™¤</button>'
          + '</div></div>';
      }).join('')
    + '<div style="padding-top:10px;border-top:1px solid var(--border);margin-top:6px">'
    + '<div style="font-size:11px;color:var(--text-3)">å„è»¸ç¸½è¨ˆé ä¼°é‡‘é¡</div>'
    + '<div class="amount" style="font-size:20px;font-weight:700;color:var(--navy);margin-top:4px">NT$ '+fmt(totalAmount)+'</div></div>';

  var dateQuickHtml = '';
  var hasDateTracks = tracks.filter(function(tr){ return tr.deadline||tr.plannedDate; });
  if (hasDateTracks.length > 0) {
    var dateRows = hasDateTracks.map(function(tr){
      var rows = '';
      if (tr.deadline) {
        var d = daysUntil(tr.deadline);
        rows += '<div class="deadline-item '+(d<=14?'deadline-urgent':d<=30?'deadline-soon':'deadline-ok')+'" style="margin-bottom:6px">'
          + '<div><div style="font-size:11px;font-weight:700">'+tr.name+'</div>'
          + '<div style="font-size:11px;color:var(--text-3)">ğŸ”” '+(tr.deadlineNote||'æé†’æ—¥æœŸ')+' '+fmtDate(tr.deadline)+'</div></div>'
          + daysBadge(d) + '</div>';
      }
      if (tr.plannedDate) {
        var d2 = daysUntil(tr.plannedDate);
        rows += '<div class="deadline-item '+(d2<=7?'deadline-soon':'deadline-ok')+'" style="margin-bottom:6px">'
          + '<div><div style="font-size:11px;font-weight:700">'+tr.name+'</div>'
          + '<div style="font-size:11px;color:var(--text-3)">ğŸ“‹ '+(tr.plannedDateNote||'é è¨ˆå®Œæˆ')+' '+fmtDate(tr.plannedDate)+'</div></div>'
          + daysBadge(d2) + '</div>';
      }
      return rows;
    }).join('');
    dateQuickHtml = '<div class="card"><div class="card-head">æ—¥æœŸå¿«è¦½</div><div class="card-body" style="padding:10px">' + dateRows + '</div></div>';
  }

  return `
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn btn-outline btn-sm" onclick="navigate('cases')">â† è¿”å›</button>
      <div class="topbar-title">${c.name}ï½œ${c.id}</div>
      <span class="badge ${statusColor[c.status]}">${c.status}</span>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-outline btn-sm" onclick="openEditCase('${c.id}')">ç·¨è¼¯å€‹æ¡ˆ</button>
      <button class="btn btn-outline btn-sm" onclick="openAddTrack('${c.id}')" style="border-color:var(--teal);color:var(--teal)">ï¼‹ æ–°å¢è¿½è¹¤è»¸</button>
      <button class="btn btn-gold btn-sm" onclick="openAddProgress('${c.id}','')">ï¼‹ æ–°å¢é€²åº¦</button>
    </div>
  </div>
  <div class="content">
    <div class="card" style="margin-bottom:16px">
      <div class="card-head">
        ç•¶äº‹äººåŸºæœ¬è³‡æ–™
        <span style="font-size:11px;color:var(--text-3);font-weight:400">å…± ${tracks.length} æ¢è¿½è¹¤è»¸ãƒ»ç¸½é ä¼° NT$ ${fmt(totalAmount)}</span>
      </div>
      <div class="card-body">
        <div class="info-grid">
          <div class="info-item"><label>å§“å</label><value>${c.name}</value></div>
          <div class="info-item"><label>é€£çµ¡é›»è©±</label><value>${c.phone}</value></div>
          <div class="info-item"><label>åœ°å€</label><value>${c.address||'â€”'}</value></div>
          <div class="info-item"><label>å—åƒ±å…¬å¸</label><value>${c.employer}</value></div>
          <div class="info-item"><label>æŠ•ä¿å–®ä½</label><value>${c.insuredUnit||c.employer||'â€”'}</value></div>
          <div class="info-item"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><value>${c.insurer||'â€”'}</value></div>
          <div class="info-item"><label>äº‹æ•…/èµ·å§‹æ—¥</label><value>${fmtDate(c.accidentDate)}</value></div>
          <div class="info-item"><label>å—ç†æ—¥æœŸ</label><value>${fmtDate(c.receiveDate)}</value></div>
        </div>
        ${c.note ? '<div class="divider"></div><div style="font-size:11px;color:var(--text-2)">'+c.note+'</div>' : ''}
      </div>
    </div>

    <div>
        <div class="card">
          <div class="card-head">è¿½è¹¤è»¸ç¸½è¦½</div>
          <div class="card-body" style="padding:0">
            ${tracks.length === 0
              ? '<div style="padding:30px;text-align:center;color:var(--text-3);font-size:13px"><p>å°šç„¡è¿½è¹¤è»¸</p><button class="btn btn-gold" style="margin-top:12px" onclick="openAddTrack(\''+c.id+'\')">ï¼‹ æ–°å¢ç¬¬ä¸€æ¢è¿½è¹¤è»¸</button></div>'
              : tracks.map(function(tr,i){
                var col2 = trackColors[i%trackColors.length];
                var bg2 = trackBgColors[i%trackBgColors.length];
                var days = daysUntil(tr.deadline);
                var daysP = daysUntil(tr.plannedDate);
                var deadlineInfo = tr.deadline ? '<span style="font-size:11px;color:#D55E00">ğŸ”” '+fmtDate(tr.deadline)+' '+daysBadge(days)+'</span>' : '';
                var plannedInfo = tr.plannedDate ? '<span style="font-size:11px;color:#0EA5B0">ğŸ“‹ '+fmtDate(tr.plannedDate)+' '+daysBadge(daysP)+'</span>' : '';
                var contactInfo = tr.contact ? '<span style="font-size:11px;color:var(--text-3)">ğŸ‘¤ '+tr.contact+(tr.contactPhone?' â˜ '+tr.contactPhone:'')+'</span>' : '';
                return '<div id="track-'+tr.id+'" style="padding:14px 18px;border-bottom:1px solid var(--border);border-left:4px solid '+col2+'">'
                  + '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">'
                  + '<div style="width:8px;height:8px;border-radius:50%;background:'+col2+';flex-shrink:0"></div>'
                  + '<span style="font-size:14px;font-weight:700">'+tr.name+'</span>'
                  + '<span class="badge '+(typeColor[tr.type]||'badge-gray')+'" style="font-size:11px">'+tr.type+'</span>'
                  + '<span class="badge '+(statusColor[tr.status]||'badge-gray')+'" style="font-size:11px">'+tr.status+'</span>'
                  + '<span style="font-size:13px;font-weight:600;color:'+col2+';margin-left:auto" class="amount">NT$ '+fmt(tr.amount)+'</span>'
                  + '</div>'
                  + ((deadlineInfo||plannedInfo||contactInfo) ? '<div style="display:flex;gap:14px;margin-top:6px;flex-wrap:wrap">'+deadlineInfo+plannedInfo+contactInfo+'</div>' : '')
                  + (tr.note ? '<div style="font-size:11px;color:var(--text-3);margin-top:4px">'+tr.note+'</div>' : '')
                  + '<div style="display:flex;gap:6px;margin-top:8px">'
                  + '<button class="btn btn-outline btn-sm" style="font-size:11px;border-color:'+col2+';color:'+col2+'" onclick="_trackAction(this)" data-action="addProgress" data-case="'+c.id+'" data-track="'+tr.id+'">ï¼‹ æ–°å¢é€²åº¦</button>'
                  + '<button class="btn btn-outline btn-sm" style="font-size:11px" onclick="_trackAction(this)" data-action="editTrack" data-track="'+tr.id+'">âœï¸ ç·¨è¼¯</button>'
                  + '<button class="btn btn-outline btn-sm" style="font-size:11px" onclick="_trackAction(this)" data-action="copyTrack" data-track="'+tr.id+'">ğŸ“‹ è¤‡è£½</button>'
                  + '<button class="btn btn-outline btn-sm" style="font-size:11px;color:#D55E00" onclick="if(confirm(\'ç¢ºå®šåˆªé™¤è¿½è¹¤è»¸ã€Œ'+tr.name.replace(/'/g,"\\\\'")+'ã€ï¼Ÿ\'))deleteTrack(\''+tr.id+'\')">ğŸ—‘ åˆªé™¤</button>'
                  + '</div></div>';
              }).join('')
            }
          </div>
        </div>
      </div>

    ${(function(){
      var caseTodos = (db.todos||[]).filter(function(t){ return t.caseId === c.id || (!t.caseId && (t.title||'').indexOf(c.name) >= 0); });
      var nowStr = new Date().toISOString().slice(0,10);
      var pendingTodos = caseTodos.filter(function(t){ return !t.done; });
      var doneTodos = caseTodos.filter(function(t){ return t.done; });
      return '<div class="card" style="margin-top:16px"><div class="card-head" style="display:flex;align-items:center;justify-content:space-between">ç›¸é—œå¾…è¾¦äº‹é … <span class="badge badge-yellow">'+pendingTodos.length+' é …æœªå®Œæˆ</span><button class="btn btn-outline btn-sm" style="font-size:11px;border-color:var(--gold);color:var(--gold)" onclick="openAddTodo(\''+c.id+'\')">ï¼‹ æ–°å¢å¾…è¾¦</button></div>'
        + '<div class="card-body" style="padding:0">'
        + (pendingTodos.length === 0 ? '<div style="padding:16px;text-align:center;color:var(--text-3);font-size:13px">æ‰€æœ‰å¾…è¾¦å·²å®Œæˆ ğŸ‰</div>' :
          pendingTodos.sort(function(a,b){ return (a.dueDate||'9999').localeCompare(b.dueDate||'9999'); }).map(function(t){
            var isOverdue = t.dueDate && t.dueDate < nowStr;
            var subtasksHtml = '';
            if (t.subtasks && t.subtasks.length) {
              t.subtasks.sort(function(a,b){ return (a.dueDate||'9999').localeCompare(b.dueDate||'9999'); });
              subtasksHtml = '<div style="margin-top:6px;padding-left:4px">' + t.subtasks.map(function(s,i){
                var sOverdue = s.dueDate && s.dueDate < nowStr && !s.done;
                return '<div style="display:flex;align-items:center;gap:8px;padding:3px 0;font-size:12px">'
                  + '<input type="checkbox" '+(s.done?'checked':'')+' onchange="toggleSubtask(\''+t.id+'\','+i+')" style="width:14px;height:14px;cursor:pointer;accent-color:#0072B2">'
                  + '<span style="flex:1;'+(s.done?'text-decoration:line-through;color:var(--text-3)':'')+'">'+s.title+'</span>'
                  + (s.dueDate ? '<span style="font-size:11px;color:'+(sOverdue?'#D55E00':'var(--text-3)')+'">'+fmtDate(s.dueDate)+'</span>' : '')
                  + '</div>';
              }).join('') + '</div>';
            }
            return '<div style="padding:12px 18px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:10px">'
              + '<input type="checkbox" onchange="toggleTodo(\''+t.id+'\')" style="width:16px;height:16px;margin-top:2px;cursor:pointer;accent-color:#0072B2;flex-shrink:0">'
              + '<div style="flex:1;min-width:0">'
              + '<div style="font-size:13px;font-weight:600;'+(isOverdue?'color:#D55E00':'')+'">'+t.title
              + (t.subtasks&&t.subtasks.length ? ' <span style="font-size:11px;font-weight:400;color:var(--text-3)">'+t.subtasks.filter(function(s){return s.done}).length+'/'+t.subtasks.length+'</span>' : '')
              + '</div>'
              + (t.note ? '<div style="font-size:11px;color:var(--text-3);margin-top:2px">'+t.note+'</div>' : '')
              + subtasksHtml
              + '<div style="display:flex;gap:10px;margin-top:4px;font-size:11px;color:var(--text-3)">'
              + (t.dueDate ? '<span style="'+(isOverdue?'color:#D55E00;font-weight:600':'')+'">ğŸ“… '+fmtDate(t.dueDate)+'</span>' : '')
              + (t.remind ? '<span>â° '+fmtDate(t.remind)+'</span>' : '')
              + '</div></div>'
              + '<div style="display:flex;gap:4px;flex-shrink:0">'
              + '<button class="btn btn-outline btn-sm" style="font-size:11px;padding:2px 6px" onclick="openEditTodo(\''+t.id+'\')">âœï¸</button>'
              + '<button class="btn btn-outline btn-sm" style="font-size:11px;padding:2px 6px;color:#D55E00" onclick="deleteTodo(\''+t.id+'\')">ğŸ—‘</button>'
              + '</div></div>';
          }).join(''))
        + (doneTodos.length ? '<div style="padding:10px 18px;border-top:1px solid var(--border);font-size:11px;color:var(--text-3)">âœ… å·²å®Œæˆ '+doneTodos.length+' é …</div>' : '')
        + '</div></div>';
    })()}

  </div>`;
},

// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
progress() {
  let progs = db.progress.filter(p => db.cases.some(c => c.id === p.caseId));
  if (progressFilter) progs = progs.filter(p => p.caseId === progressFilter);

  function listView() {
    return `<div class="table-card">
      <table>
        <thead><tr>
          <th>å€‹æ¡ˆ</th><th>è¿½è¹¤è»¸</th><th>æ—¥æœŸ</th><th>é€²åº¦éšæ®µ</th><th>è¾¦ç†äº‹é …èªªæ˜</th>
          <th>æ”¶/é€ä»¶</th><th>ä¸‹ä¸€æ­¥</th><th>å‚™è¨»</th>
        </tr></thead>
        <tbody>
        ${progs.length === 0 ? `<tr><td colspan="8"><div class="empty"><p>å°šç„¡é€²åº¦è¨˜éŒ„</p></div></td></tr>` :
          [...progs].sort((a,b) => b.date.localeCompare(a.date)).map(p => {
            const c = db.cases.find(x => x.id === p.caseId);
            const tr = p.trackId ? db.tracks.find(t => t.id === p.trackId) : null;
            return `<tr onclick="navigate('case-detail','${p.caseId}')" style="cursor:pointer">
              <td><strong>${p.caseId}</strong><div style="font-size:11px;color:var(--text-3)">${c?c.name:''}</div></td>
              <td style="max-width:130px">${tr ? `<div style="font-size:13px;font-weight:600">${tr.name}</div><span class="badge ${typeColor[tr.type]||'badge-gray'}" style="font-size:11px">${tr.type}</span>` : '<span style="color:var(--text-3);font-size:11px">â€”</span>'}</td>
              <td style="white-space:nowrap">${fmtDate(p.date)}</td>
              <td><span class="badge ${stageColor[p.stage]||'badge-gray'}">${p.stage}</span></td>
              <td style="max-width:180px">${p.desc}</td>
              <td>${p.sendRecv ? `<span class="badge ${p.sendRecv==='æ”¶ä»¶'?'badge-green':'badge-teal'}">${p.sendRecv}</span>` : '-'}</td>
              <td style="max-width:130px">${p.nextStep||'-'}${p.nextDate?`<div style="font-size:11px;color:var(--text-3)">${fmtDate(p.nextDate)}</div>`:''}</td>
              <td style="max-width:110px;color:var(--text-3);font-size:11px">${p.note||'-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  }

  function todoSection() {
    let todos = (db.todos||[]).filter(t => !t.done);
    if (progressFilter) todos = todos.filter(t => t.caseId === progressFilter);
    if (todos.length === 0) return '';
    return `<div class="card" style="margin-top:16px">
      <div class="card-head" style="display:flex;justify-content:space-between;align-items:center">
        <span>â˜ å¾…è¾¦äº‹é … <span class="badge badge-yellow">${todos.length}</span></span>
        <button class="btn btn-outline btn-sm" onclick="navigate('todos')">æŸ¥çœ‹å…¨éƒ¨</button>
      </div>
      <div class="card-body" style="padding:0">
        ${todos.map(t => {
          const isOverdue = t.dueDate && t.dueDate < new Date().toISOString().slice(0,10);
          const subDone = (t.subtasks||[]).filter(s=>s.done).length;
          const subTotal = (t.subtasks||[]).length;
          return `<div style="padding:10px 16px;border-bottom:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" onchange="toggleTodo('${t.id}')" style="width:16px;height:16px;cursor:pointer;accent-color:#0072B2">
              <span style="font-size:13px;font-weight:600;${isOverdue?'color:#D55E00':''}">${t.title}</span>
              ${subTotal?'<span style="font-size:11px;color:var(--text-3)">'+subDone+'/'+subTotal+'</span>':''}
              ${t.dueDate?'<span style="font-size:11px;margin-left:auto;color:'+(isOverdue?'#D55E00':'var(--text-3)')+'">ğŸ“… '+fmtDate(t.dueDate)+'</span>':''}
            </div>
            ${subTotal?'<div style="padding-left:24px;margin-top:4px">'+
              (t.subtasks||[]).map((s,i)=>'<div style="display:flex;align-items:center;gap:6px;padding:2px 0;font-size:13px"><input type="checkbox" '+(s.done?'checked':'')+' onchange="toggleSubtask(\''+t.id+'\','+i+')" style="width:14px;height:14px;cursor:pointer;accent-color:#0072B2"><span style="'+(s.done?'text-decoration:line-through;color:var(--text-3)':'')+'">'+s.title+'</span>'+(s.dueDate?'<span style="font-size:11px;color:var(--text-3);margin-left:auto">'+fmtDate(s.dueDate)+'</span>':'')+'</div>').join('')
            +'</div>':''}
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  function calendarView() {
    const _validProgs = db.progress.filter(p => db.cases.some(c => c.id === p.caseId));
    const allProgs = progressFilter ? _validProgs.filter(p=>p.caseId===progressFilter) : _validProgs;
    const allTracks = db.tracks.filter(t => !progressFilter || t.caseId === progressFilter);
    const eventsByDate = {};
    allProgs.forEach(p => {
      if (!p.date) return;
      if (!eventsByDate[p.date]) eventsByDate[p.date] = [];
      const c = db.cases.find(x => x.id === p.caseId);
      eventsByDate[p.date].push({ type:'progress', label:(c?c.name:p.caseId), desc:p.desc, stage:p.stage, caseId:p.caseId, badge:stageColor[p.stage]||'badge-gray', dot:'#0072B2', bg:'rgba(0,114,178,0.08)' });
    });
    allTracks.forEach(tr => {
      const c = db.cases.find(x => x.id === tr.caseId);
      if (tr.deadline) {
        if (!eventsByDate[tr.deadline]) eventsByDate[tr.deadline] = [];
        eventsByDate[tr.deadline].push({ type:'deadline', label:(c?c.name:tr.caseId)+' æé†’æ—¥æœŸ', desc:tr.deadlineNote||tr.name, caseId:tr.caseId, badge:'badge-red', dot:'#D55E00', bg:'rgba(213,94,0,0.08)' });
      }
      if (tr.plannedDate) {
        if (!eventsByDate[tr.plannedDate]) eventsByDate[tr.plannedDate] = [];
        eventsByDate[tr.plannedDate].push({ type:'planned', label:(c?c.name:tr.caseId)+' é è¨ˆå®Œæˆ', desc:tr.plannedDateNote||tr.name, caseId:tr.caseId, badge:'badge-teal', dot:'#0EA5B0', bg:'rgba(14,165,176,0.08)' });
      }
    });
    // å¾…è¾¦äº‹é …åˆ°æœŸæ—¥
    (db.todos||[]).filter(t => !t.done).forEach(t => {
      if (t.dueDate) {
        if (!eventsByDate[t.dueDate]) eventsByDate[t.dueDate] = [];
        eventsByDate[t.dueDate].push({ type:'todo', label:'â˜ '+t.title, desc:'', caseId:t.caseId||'', badge:'badge-yellow', dot:'#C9A84C', bg:'rgba(201,168,76,0.08)' });
      }
      (t.subtasks||[]).filter(s => !s.done && s.dueDate).forEach(s => {
        if (!eventsByDate[s.dueDate]) eventsByDate[s.dueDate] = [];
        eventsByDate[s.dueDate].push({ type:'todo', label:'â˜ '+s.title, desc:t.title, caseId:t.caseId||'', badge:'badge-yellow', dot:'#C9A84C', bg:'rgba(201,168,76,0.08)' });
      });
    });
    const now = new Date();
    const y = calYear || now.getFullYear(), m = calMonth != null ? calMonth : now.getMonth();
    const first = new Date(y, m, 1);
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const today = now.toISOString().slice(0,10);
    const mLabel = (y-1911)+'å¹´'+(m+1)+'æœˆ';
    let cellArr = [];
    // é€±ä¸€é–‹å§‹ï¼šgetDay() 0=æ—¥ -> è½‰æˆ 0=ä¸€
    const startDay = (first.getDay() + 6) % 7;
    // ä¸Šæœˆè£œè¶³
    const prevMonthDays = new Date(y, m, 0).getDate();
    for (let i=startDay-1; i>=0; i--) {
      const d = prevMonthDays - i;
      cellArr.push('<div style="min-height:90px;padding:4px 6px;overflow:hidden;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);opacity:0.5"><div style="font-size:11px;color:var(--text-3)">'+d+'</div></div>');
    }
    for (let d=1; d<=daysInMonth; d++) {
      const ds = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      const evts = eventsByDate[ds] || [];
      const isToday = ds === today;
      cellArr.push(`<div style="min-height:90px;padding:4px 6px;overflow:hidden;border:1px solid var(--border);border-radius:6px;background:${isToday?'rgba(0,114,178,0.06)':'#fff'};${isToday?'border-color:#0072B2':''}">
        <div style="font-size:11px;font-weight:${isToday?'700':'500'};color:${isToday?'#0072B2':'var(--text-2)'};margin-bottom:2px">${d}</div>
        ${evts.slice(0,3).map(e => `<div onclick="navigate('${e.type==='todo'?'todos':'case-detail'}','${e.caseId}')" style="font-size:11px;padding:2px 4px;margin-bottom:1px;border-radius:3px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-left:3px solid ${e.dot};background:${e.bg||'rgba(0,0,0,0.03)'};color:var(--text)">${e.type==='deadline'?'âš ï¸ ':e.type==='planned'?'ğŸ“‹ ':e.type==='todo'?'â˜‘ï¸ ':'â— '}${e.label}</div>`).join('')}
        ${evts.length>3?`<div style="font-size:11px;color:var(--text-3)">+${evts.length-3}é …</div>`:''}
      </div>`);
    }
    // ä¸‹æœˆè£œè¶³
    const totalCells = startDay + daysInMonth;
    const remaining = (7 - totalCells % 7) % 7;
    for (let nd=1; nd<=remaining; nd++) {
      cellArr.push('<div style="min-height:90px;padding:4px 6px;overflow:hidden;border:1px solid var(--border);border-radius:6px;background:var(--surface-2);opacity:0.5"><div style="font-size:11px;color:var(--text-3)">'+nd+'</div></div>');
    }
    // ç”¢ç”Ÿè¡¨æ ¼è¡Œ
    let tableRows = '';
    for (let r=0; r<cellArr.length; r+=7) {
      tableRows += '<tr>';
      for (let c=0; c<7; c++) tableRows += '<td style="padding:2px;vertical-align:top">'+(cellArr[r+c]||'')+'</td>';
      tableRows += '</tr>';
    }
    return `<div style="margin-bottom:16px;display:flex;align-items:center;gap:12px">
      <button class="btn btn-outline btn-sm" onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--}render()">â—€</button>
      <span style="font-size:15px;font-weight:700;min-width:100px;text-align:center">${mLabel}</span>
      <button class="btn btn-outline btn-sm" onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++}render()">â–¶</button>
      <button class="btn btn-outline btn-sm" style="margin-left:8px" onclick="calYear=${now.getFullYear()};calMonth=${now.getMonth()};render()">ä»Šå¤©</button>
    </div>
    <div style="display:flex;gap:16px;margin-bottom:12px;font-size:11px;color:var(--text-2);flex-wrap:wrap">
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(0,114,178,0.5);margin-right:4px;vertical-align:middle"></span>â— é€²åº¦ç´€éŒ„</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(213,94,0,0.5);margin-right:4px;vertical-align:middle"></span>âš ï¸ æˆªæ­¢æ—¥æœŸ</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(14,165,176,0.5);margin-right:4px;vertical-align:middle"></span>ğŸ“‹ é è¨ˆå®Œæˆ</span>
      <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:rgba(201,168,76,0.5);margin-right:4px;vertical-align:middle"></span>â˜‘ï¸ å¾…è¾¦äº‹é …</span>
    </div>
    <table style="width:100%;border-collapse:separate;border-spacing:3px;table-layout:fixed">
      <thead><tr>${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(w=>'<th style="text-align:center;font-size:11px;font-weight:700;color:var(--text-3);padding:4px;background:none;border:none;text-transform:none;letter-spacing:0">'+w+'</th>').join('')}</tr></thead>
      <tbody>${tableRows}</tbody>
    </table>`;
  }

  const viewContent = progressView === 'calendar' ? calendarView() : (listView() + todoSection());
  return `<div class="topbar">
    <div class="topbar-title">é€²åº¦è¿½è¹¤</div>
    <div class="topbar-actions">
      <select class="btn btn-outline" onchange="progressFilter=this.value;render()" style="cursor:pointer">
        <option value="">å…¨éƒ¨å€‹æ¡ˆ</option>
        ${db.cases.map(c => `<option value="${c.id}" ${progressFilter===c.id?'selected':''}>${c.id} ${c.name}</option>`).join('')}
      </select>
      <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden">
        <button class="btn btn-sm" style="border-radius:0;border:none;${progressView==='list'?'background:#0072B2;color:#fff':''}" onclick="progressView='list';navigate('progress')" title="æ¸…å–®æª¢è¦–">â˜° æ¸…å–®</button>
        <button class="btn btn-sm" style="border-radius:0;border:none;border-left:1px solid var(--border);${progressView==='calendar'?'background:#0072B2;color:#fff':''}" onclick="progressView='calendar';navigate('progress')" title="è¡Œäº‹æ›†æª¢è¦–">ğŸ“… è¡Œäº‹æ›†</button>
      </div>
      <button class="btn btn-gold" onclick="openAddProgress('','')">ï¼‹ æ–°å¢é€²åº¦</button>
    </div>
  </div>
  <div class="content">
    ${viewContent}
  </div>`;
},

// â”€â”€ Deadlines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deadlines() {
  // åŒæ™‚è®€å–è¿½è¹¤è»¸ + å€‹æ¡ˆå±¤ç´šçš„æ—¥æœŸ
  const activeCases = db.cases.filter(c => c.status !== 'å·²çµ¦ä»˜' && c.status !== 'å·²èª¿è§£å®Œæˆ' && c.status !== 'æ’¤æ¡ˆ');
  const activeCaseIds = new Set(activeCases.map(c => c.id));

  // å½™æ•´æ‰€æœ‰æˆªæ­¢æ—¥æœŸï¼ˆè¿½è¹¤è»¸å„ªå…ˆï¼Œå€‹æ¡ˆå±¤ç´šè£œå……ï¼‰
  const hardItems = [];
  const plannedItems = [];

  db.tracks.filter(t => activeCaseIds.has(t.caseId) && t.status !== 'å·²çµ¦ä»˜' && t.status !== 'å·²èª¿è§£å®Œæˆ' && t.status !== 'æ’¤æ¡ˆ').forEach(t => {
    const c = db.cases.find(x => x.id === t.caseId);
    if (!c) return;
    if (t.deadline) hardItems.push({ id:t.id, caseId:t.caseId, name:c.name, type:t.type, deadline:t.deadline, deadlineNote:t.deadlineNote||t.name, days:daysUntil(t.deadline), trackName:t.name, done:!!t.deadlineDone, doneDate:t.deadlineDoneDate||'' });
    if (t.plannedDate) plannedItems.push({ id:t.id, caseId:t.caseId, name:c.name, type:t.type, plannedDate:t.plannedDate, plannedDateNote:t.plannedDateNote||t.name, days:daysUntil(t.plannedDate), trackName:t.name, done:!!t.plannedDone, doneDate:t.plannedDoneDate||'' });
  });
  // å€‹æ¡ˆå±¤ç´šï¼ˆç„¡è¿½è¹¤è»¸æ™‚çš„ fallbackï¼‰
  activeCases.filter(c => c.deadline && !db.tracks.some(t=>t.caseId===c.id&&t.deadline)).forEach(c => {
    hardItems.push({ id:c.id, caseId:c.id, name:c.name, type:c.type, deadline:c.deadline, deadlineNote:c.deadlineNote||'', days:daysUntil(c.deadline), trackName:null, done:!!c.deadlineDone, doneDate:c.deadlineDoneDate||'' });
  });
  activeCases.filter(c => c.plannedDate && !db.tracks.some(t=>t.caseId===c.id&&t.plannedDate)).forEach(c => {
    plannedItems.push({ id:c.id, caseId:c.id, name:c.name, type:c.type, plannedDate:c.plannedDate, plannedDateNote:c.plannedDateNote||'', days:daysUntil(c.plannedDate), trackName:null, done:!!c.plannedDone, doneDate:c.plannedDoneDate||'' });
  });

  hardItems.sort((a,b) => a.days - b.days);
  plannedItems.sort((a,b) => a.days - b.days);

  // åˆ†é›¢å·²å®Œæˆå’Œæœªå®Œæˆ
  const hardDone = hardItems.filter(i => i.done);
  const hardPending = hardItems.filter(i => !i.done);
  const plannedDone = plannedItems.filter(i => i.done);
  const plannedPending = plannedItems.filter(i => !i.done);

  // å¾…è¾¦äº‹é …çš„åˆ°æœŸæ—¥ä¹ŸåŠ å…¥
  const todoItems = [];
  (db.todos||[]).filter(t => !t.done && t.dueDate).forEach(t => {
    todoItems.push({ id:t.id, caseId:t.caseId||'', name:t.title, type:'å¾…è¾¦äº‹é …', deadline:t.dueDate, deadlineNote:t.note||'', days:daysUntil(t.dueDate), trackName:null, isTodo:true });
  });
  // ç´°é …åˆ°æœŸæ—¥
  (db.todos||[]).filter(t => !t.done && t.subtasks).forEach(t => {
    (t.subtasks||[]).filter(s => !s.done && s.dueDate).forEach(s => {
      todoItems.push({ id:t.id, caseId:t.caseId||'', name:t.title+' â€º '+s.title, type:'å¾…è¾¦ç´°é …', deadline:s.dueDate, deadlineNote:'', days:daysUntil(s.dueDate), trackName:null, isTodo:true });
    });
  });
  todoItems.sort((a,b) => a.days - b.days);

  function hardCard(item) {
    const done = item.done;
    const cls = done ? 'deadline-ok' : (item.days < 0 ? 'deadline-urgent' : item.days <= 14 ? 'deadline-urgent' : item.days <= 30 ? 'deadline-soon' : 'deadline-ok');
    const accent = done ? '#56a65c' : (item.days < 0 ? '#5C1A1A' : item.days <= 14 ? '#D55E00' : item.days <= 30 ? '#b7791f' : '#0072B2');
    return `<div class="deadline-item ${cls}" style="margin-bottom:8px;border-left:3px solid ${accent};display:flex;align-items:flex-start;gap:8px;${done?'opacity:0.6':''}">
      <input type="checkbox" ${done?'checked':''} onclick="event.stopPropagation();markDeadlineDone('${item.id}','deadline')" style="width:16px;height:16px;margin-top:4px;cursor:pointer;accent-color:#56a65c;flex-shrink:0" title="${done?'å–æ¶ˆå®Œæˆ':'æ¨™è¨˜å®Œæˆ'}">
      <div style="flex:1;min-width:0;cursor:pointer" onclick="navigate('case-detail','${item.caseId}')">
        <div style="font-size:13px;font-weight:700;${done?'text-decoration:line-through;color:var(--text-3)':''}">${item.name} <span style="color:var(--text-3);font-weight:400;font-size:11px">${item.caseId}</span></div>
        ${item.trackName ? `<div style="font-size:11px;color:var(--text-3)">è¿½è¹¤è»¸ï¼š${item.trackName}</div>` : ''}
        <div style="font-size:11px;color:var(--text-3);margin-top:1px">${item.deadlineNote} Â· ${fmtDate(item.deadline)}</div>
        <span class="badge ${typeColor[item.type]||'badge-gray'}" style="font-size:11px;margin-top:4px">${item.type}</span>
        ${done ? '<span style="font-size:11px;color:#56a65c;margin-left:8px">âœ… å®Œæˆæ–¼ '+fmtDate(item.doneDate)+'</span>' : ''}
      </div>
      <div style="flex-shrink:0">${done ? '<span class="badge badge-green" style="font-size:11px">å·²å®Œæˆ</span>' : daysBadge(item.days)}</div>
    </div>`;
  }

  function plannedCard(item) {
    const done = item.done;
    const cls = done ? 'deadline-ok' : (item.days <= 7 ? 'deadline-soon' : 'deadline-ok');
    const accent = done ? '#56a65c' : (item.days <= 7 ? '#b7791f' : '#0EA5B0');
    return `<div class="deadline-item ${cls}" style="margin-bottom:8px;border-left:3px solid ${accent};display:flex;align-items:flex-start;gap:8px;${done?'opacity:0.6':''}">
      <input type="checkbox" ${done?'checked':''} onclick="event.stopPropagation();markDeadlineDone('${item.id}','planned')" style="width:16px;height:16px;margin-top:4px;cursor:pointer;accent-color:#56a65c;flex-shrink:0" title="${done?'å–æ¶ˆå®Œæˆ':'æ¨™è¨˜å®Œæˆ'}">
      <div style="flex:1;min-width:0;cursor:pointer" onclick="navigate('case-detail','${item.caseId}')">
        <div style="font-size:13px;font-weight:700;${done?'text-decoration:line-through;color:var(--text-3)':''}">${item.name} <span style="color:var(--text-3);font-weight:400;font-size:11px">${item.caseId}</span></div>
        ${item.trackName ? `<div style="font-size:11px;color:var(--text-3)">è¿½è¹¤è»¸ï¼š${item.trackName}</div>` : ''}
        <div style="font-size:11px;color:var(--text-3);margin-top:1px">${item.plannedDateNote} Â· ${fmtDate(item.plannedDate)}</div>
        <span class="badge ${typeColor[item.type]||'badge-gray'}" style="font-size:11px;margin-top:4px">${item.type}</span>
        ${done ? '<span style="font-size:11px;color:#56a65c;margin-left:8px">âœ… å®Œæˆæ–¼ '+fmtDate(item.doneDate)+'</span>' : ''}
      </div>
      <div style="flex-shrink:0">${done ? '<span class="badge badge-green" style="font-size:11px">å·²å®Œæˆ</span>' : daysBadge(item.days)}</div>
    </div>`;
  }

  function todoCard(item) {
    const cls = item.days < 0 ? 'deadline-urgent' : item.days <= 7 ? 'deadline-soon' : 'deadline-ok';
    const accent = item.days < 0 ? '#D55E00' : item.days <= 7 ? '#b7791f' : '#0072B2';
    return `<div class="deadline-item ${cls}" style="margin-bottom:8px;border-left:3px solid ${accent};display:flex;align-items:flex-start;gap:8px">
      <input type="checkbox" onclick="event.stopPropagation();toggleTodo('${item.id}')" style="width:16px;height:16px;margin-top:4px;cursor:pointer;accent-color:#0072B2;flex-shrink:0" title="æ¨™è¨˜å®Œæˆ">
      <div style="flex:1;min-width:0;cursor:pointer" onclick="navigate('todos')">
        <div style="font-size:13px;font-weight:700">â˜ ${item.name}</div>
        ${item.caseId ? '<div style="font-size:11px;color:var(--text-3)">ğŸ“ '+item.caseId+'</div>' : ''}
        <div style="font-size:11px;color:var(--text-3);margin-top:1px">${fmtDate(item.deadline)}</div>
      </div>
      <div style="flex-shrink:0">${daysBadge(item.days)}</div>
    </div>`;
  }

  const tOverdue = todoItems.filter(i => i.days < 0);
  const tUrgent = todoItems.filter(i => i.days >= 0 && i.days <= 7);
  const tSoon = todoItems.filter(i => i.days > 7 && i.days <= 30);
  const tLater = todoItems.filter(i => i.days > 30);

  const overdue = hardPending.filter(i => i.days < 0);
  const urgent  = hardPending.filter(i => i.days >= 0 && i.days <= 14);
  const soon    = hardPending.filter(i => i.days > 14 && i.days <= 30);
  const later   = hardPending.filter(i => i.days > 30);

  const p7    = plannedPending.filter(i => i.days <= 7);
  const p30   = plannedPending.filter(i => i.days > 7 && i.days <= 30);
  const pLater= plannedPending.filter(i => i.days > 30);

  function section(label, color, bg, items, cardFn, emptyMsg) {
    return `<div style="margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:${color};margin-bottom:8px;padding:5px 10px;background:${bg};border-radius:6px">${label}</div>
      ${items.length ? items.map(cardFn).join('') : `<div class="text-muted" style="padding:10px;font-size:11px">${emptyMsg}</div>`}
    </div>`;
  }

  return `
  <div class="topbar">
    <div class="topbar-title">æœŸé™ç®¡ç†</div>
    <div class="topbar-actions" style="font-size:11px;color:var(--text-3)">å…± ${hardPending.length + plannedPending.length + todoItems.length} ç­†æœŸé™</div>
  </div>
  <div class="content">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">

      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:rgba(14,165,176,0.05);border-radius:10px;border:1px solid rgba(14,165,176,0.25)">
          <span style="font-size:20px">ğŸ“‹</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:#0EA5B0">é è¨ˆå®Œæˆæ—¥æœŸ</div>
            <div style="font-size:11px;color:var(--text-3)">å…§éƒ¨è¦åŠƒç›®æ¨™ãƒ»é è¨ˆå‚™ä»¶å®Œæˆæ—¥</div>
          </div>
          <span style="margin-left:auto;font-size:13px;font-weight:700;color:#0EA5B0">${plannedPending.length} ç­†</span>
        </div>
        ${section('â° 7å¤©å…§ï¼ˆå³å°‡åˆ°æœŸï¼‰', '#0EA5B0', 'rgba(14,165,176,0.07)', p7, plannedCard, 'ç„¡')}
        ${section('ğŸ“… 8â€“30å¤©', '#0072B2', 'rgba(0,114,178,0.07)', p30, plannedCard, 'ç„¡')}
        ${section('ğŸ“Œ 30å¤©ä»¥ä¸Š', '#4a5568', 'var(--surface-2)', pLater, plannedCard, 'ç„¡')}
      </div>

      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:rgba(213,94,0,0.05);border-radius:10px;border:1px solid rgba(213,94,0,0.25)">
          <span style="font-size:20px">âš ï¸</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:#D55E00">å®Œæˆæˆªæ­¢æ—¥æœŸ</div>
            <div style="font-size:11px;color:var(--text-3)">æ³•å®šæœŸé™ãƒ»æ³•é™¢æœŸæ—¥ãƒ»æ©Ÿé—œè¦æ±‚æˆªæ­¢</div>
          </div>
          <span style="margin-left:auto;font-size:13px;font-weight:700;color:#D55E00">${hardPending.filter(i=>i.days>=0).length} ç­†</span>
        </div>
        ${overdue.length ? section('ğŸš« å·²é€¾æœŸ', '#5C1A1A', 'rgba(92,26,26,0.08)', overdue, hardCard, '') : ''}
        ${section('ğŸ”” 14å¤©å…§ï¼ˆç·Šæ€¥ï¼‰', '#D55E00', 'rgba(213,94,0,0.07)', urgent, hardCard, 'ç„¡ç·Šæ€¥æˆªæ­¢')}
        ${section('â± 15â€“30å¤©', '#b7791f', 'rgba(214,158,46,0.07)', soon, hardCard, 'ç„¡')}
        ${section('ğŸ“Œ 30å¤©ä»¥ä¸Š', '#4a5568', 'var(--surface-2)', later, hardCard, 'ç„¡')}
      </div>
    </div>

    <!-- å¾…è¾¦äº‹é …æœŸé™ -->
    <div style="margin-top:24px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:rgba(201,168,76,0.08);border-radius:10px;border:1px solid rgba(201,168,76,0.3)">
        <span style="font-size:20px">â˜‘ï¸</span>
        <div>
          <div style="font-size:13px;font-weight:700;color:var(--gold)">å¾…è¾¦äº‹é …åˆ°æœŸæ—¥</div>
          <div style="font-size:11px;color:var(--text-3)">å¾…è¾¦äº‹é …åŠç´°é …çš„é å®šæ—¥æœŸ</div>
        </div>
        <span style="margin-left:auto;font-size:13px;font-weight:700;color:var(--gold)">${todoItems.length} ç­†</span>
      </div>
      ${todoItems.length === 0 ? '<div style="padding:16px;text-align:center;color:var(--text-3);font-size:13px">ç›®å‰æ²’æœ‰è¨­å®šåˆ°æœŸæ—¥çš„å¾…è¾¦äº‹é …</div>' : `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          ${tOverdue.length ? section('ğŸš« å·²é€¾æœŸ', '#5C1A1A', 'rgba(92,26,26,0.08)', tOverdue, todoCard, '') : ''}
          ${section('â° 7å¤©å…§', '#D55E00', 'rgba(213,94,0,0.07)', tUrgent, todoCard, 'ç„¡')}
        </div>
        <div>
          ${section('ğŸ“… 8â€“30å¤©', '#b7791f', 'rgba(214,158,46,0.07)', tSoon, todoCard, 'ç„¡')}
          ${section('ğŸ“Œ 30å¤©ä»¥ä¸Š', '#4a5568', 'var(--surface-2)', tLater, todoCard, 'ç„¡')}
        </div>
      </div>`}
    </div>

    ${(hardDone.length + plannedDone.length) > 0 ? `
    <div style="margin-top:24px">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(86,166,92,0.08);border-radius:10px;border:1px solid rgba(86,166,92,0.25);cursor:pointer" onclick="var el=document.getElementById('done-section');el.style.display=el.style.display==='none'?'block':'none';this.querySelector('.toggle-arrow').textContent=el.style.display==='none'?'â–¶':'â–¼'">
        <span style="font-size:20px">âœ…</span>
        <div>
          <div style="font-size:13px;font-weight:700;color:#56a65c">å·²å®Œæˆ</div>
          <div style="font-size:11px;color:var(--text-3)">é»æ“Šå±•é–‹/æ”¶åˆ</div>
        </div>
        <span style="margin-left:auto;font-size:13px;font-weight:700;color:#56a65c">${hardDone.length + plannedDone.length} ç­†</span>
        <span class="toggle-arrow" style="font-size:11px;color:var(--text-3)">â–¶</span>
      </div>
      <div id="done-section" style="display:none;margin-top:12px">
        <div style="padding:8px 12px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;background:var(--surface-2);border-radius:8px;margin-bottom:8px">
          <label style="font-size:11px;color:var(--text-3);cursor:pointer;display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="dl-select-all" onchange="document.querySelectorAll('.dl-done-cb').forEach(function(c){c.checked=this.checked}.bind(this))" style="cursor:pointer"> å…¨é¸
          </label>
          <button class="btn btn-sm btn-outline" style="font-size:11px;color:#D55E00;margin-left:auto" onclick="var els=document.querySelectorAll('.dl-done-cb:checked');if(!els.length){alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®');return}if(confirm('ç¢ºå®šåˆªé™¤å·²é¸çš„ '+els.length+' é …å®Œæˆè¨˜éŒ„ï¼Ÿ')){els.forEach(function(c){markDeadlineDone(c.dataset.id,c.dataset.dtype)});render()}">ğŸ—‘ åˆªé™¤å·²é¸</button>
          <button class="btn btn-sm btn-outline" style="font-size:11px;color:#D55E00" onclick="if(confirm('ç¢ºå®šæ¸…é™¤å…¨éƒ¨ ${hardDone.length + plannedDone.length} é …å®Œæˆè¨˜éŒ„ï¼Ÿ')){${JSON.stringify(hardDone.map(i=>i.id))}.forEach(function(id){var tr=db.tracks.find(function(t){return t.id===id});if(tr){tr.deadlineDone=false;tr.deadlineDoneDate=''}else{var c=db.cases.find(function(x){return x.id===id});if(c){c.deadlineDone=false;c.deadlineDoneDate=''}}});${JSON.stringify(plannedDone.map(i=>i.id))}.forEach(function(id){var tr=db.tracks.find(function(t){return t.id===id});if(tr){tr.plannedDone=false;tr.plannedDoneDate=''}else{var c=db.cases.find(function(x){return x.id===id});if(c){c.plannedDone=false;c.plannedDoneDate=''}}});saveData(db);render()}">ğŸ—‘ å…¨éƒ¨æ¸…é™¤</button>
        </div>
        ${hardDone.length ? '<div style="font-size:11px;font-weight:700;color:#56a65c;margin-bottom:6px;padding:4px 10px;background:rgba(86,166,92,0.06);border-radius:6px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸ</div>' + hardDone.map(i => '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:4px"><input type="checkbox" class="dl-done-cb" data-id="'+i.id+'" data-dtype="deadline" style="width:16px;height:16px;margin-top:4px;cursor:pointer;flex-shrink:0"><div style="flex:1">'+hardCard(i)+'</div></div>').join('') : ''}
        ${plannedDone.length ? '<div style="font-size:11px;font-weight:700;color:#56a65c;margin-bottom:6px;margin-top:12px;padding:4px 10px;background:rgba(86,166,92,0.06);border-radius:6px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸ</div>' + plannedDone.map(i => '<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:4px"><input type="checkbox" class="dl-done-cb" data-id="'+i.id+'" data-dtype="planned" style="width:16px;height:16px;margin-top:4px;cursor:pointer;flex-shrink:0"><div style="flex:1">'+plannedCard(i)+'</div></div>').join('') : ''}
      </div>
    </div>` : ''}
  </div>`;
},

// â”€â”€ Todos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
todos() {
  const todos = db.todos || [];
  const pending = todos.filter(t => !t.done);
  const done = todos.filter(t => t.done);

  // æª¢æŸ¥æé†’
  const now = new Date();
  const alerts = pending.filter(t => t.remind && t.remind <= now.toISOString().slice(0,10));

  const sortedPending = [...pending].sort((a,b) => {
    const now2 = new Date();
    const aAlert = a.remind && a.remind.slice(0,10) <= now2.toISOString().slice(0,10) ? 0 : 1;
    const bAlert = b.remind && b.remind.slice(0,10) <= now2.toISOString().slice(0,10) ? 0 : 1;
    if (aAlert !== bAlert) return aAlert - bAlert;
    const aDate = a.dueDate || a.remind || '9999';
    const bDate = b.dueDate || b.remind || '9999';
    return aDate.localeCompare(bDate);
  });
  // å­ä»»å‹™ä¹ŸæŒ‰æ—¥æœŸæ’åº
  sortedPending.forEach(t => {
    if (t.subtasks && t.subtasks.length) {
      t.subtasks.sort((a,b) => (a.dueDate||'9999').localeCompare(b.dueDate||'9999'));
    }
  });

  return `
  <div class="topbar">
    <div class="topbar-title">å¾…è¾¦äº‹é … <span class="text-muted">ï¼ˆ${pending.length} é …æœªå®Œæˆï¼‰</span></div>
    <div class="topbar-actions">
      <button class="btn btn-gold" onclick="openAddTodo()">ï¼‹ æ–°å¢å¾…è¾¦</button>
    </div>
  </div>
  <div class="content">
    ${alerts.length ? `<div style="padding:12px 16px;background:rgba(213,94,0,0.08);border:1px solid rgba(213,94,0,0.2);border-radius:10px;margin-bottom:16px;font-size:13px;color:#D55E00">
      â° æœ‰ <strong>${alerts.length}</strong> é …å¾…è¾¦å·²åˆ°æé†’æ—¥æœŸï¼
    </div>` : ''}

    <!-- æœªå®Œæˆ -->
    <div class="card" style="margin-bottom:20px">
      <div class="card-head">æœªå®Œæˆ <span class="badge badge-blue">${pending.length}</span></div>
      <div class="card-body" style="padding:0">
        ${sortedPending.length === 0 ? '<div style="padding:30px;text-align:center;color:var(--text-3);font-size:13px">æ²’æœ‰å¾…è¾¦äº‹é … ğŸ‰</div>' :
          sortedPending.map(t => {
            const isOverdue = t.dueDate && t.dueDate < now.toISOString().slice(0,10);
            const isAlerted = t.remind && t.remind <= now.toISOString().slice(0,10);
            return `<div style="padding:14px 18px;border-bottom:1px solid var(--border);${isAlerted?'background:rgba(213,94,0,0.04)':''}">
              <div style="display:flex;align-items:flex-start;gap:10px">
                <input type="checkbox" onchange="toggleTodo('${t.id}')" style="width:18px;height:18px;margin-top:2px;cursor:pointer;flex-shrink:0;accent-color:#0072B2">
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:600;${isOverdue?'color:#D55E00':''}">
                    ${isAlerted?'â° ':''}${t.title}
                    ${(t.subtasks&&t.subtasks.length)?'<span style="font-size:11px;font-weight:400;color:var(--text-3);margin-left:6px">'+t.subtasks.filter(s=>s.done).length+'/'+t.subtasks.length+'</span>':''}
                  </div>
                  ${t.note?'<div style="font-size:11px;color:var(--text-3);margin-top:4px;white-space:pre-line">'+t.note+'</div>':''}
                  ${(t.subtasks&&t.subtasks.length)?'<div style="margin-top:8px;padding-left:4px">'+t.subtasks.map((s,i)=>'<div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:13px"><input type="checkbox" '+(s.done?'checked':'')+' onchange="toggleSubtask(\''+t.id+'\','+i+')" style="width:15px;height:15px;cursor:pointer;accent-color:#0072B2"><span style="'+(s.done?'text-decoration:line-through;color:var(--text-3)':'')+';flex:1">'+s.title+'</span>'+(s.dueDate?'<span style="font-size:11px;color:'+(s.dueDate<now.toISOString().slice(0,10)&&!s.done?'#D55E00':'var(--text-3)')+'">'+fmtDate(s.dueDate)+'</span>':'')+'</div>').join('')+'</div>':''}
                  <div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:var(--text-3);flex-wrap:wrap">
                    ${t.remind?'<span>â° '+fmtDate(t.remind)+'</span>':''}
                    ${t.dueDate?'<span style="'+(isOverdue?'color:#D55E00;font-weight:600':'')+'">ğŸ“… '+fmtDate(t.dueDate)+'</span>':''}
                    ${t.caseId?'<span>ğŸ“ '+t.caseId+'</span>':''}
                  </div>
                </div>
              </div>
              <div style="display:flex;gap:6px;margin-top:10px;padding-left:28px">
                <button class="btn btn-sm btn-outline" onclick="copyTodo('${t.id}')">ğŸ“‹ è¤‡è£½</button>
                <button class="btn btn-sm btn-outline" onclick="openEditTodo('${t.id}')">âœï¸ ç·¨è¼¯</button>
                <button class="btn btn-sm btn-outline" onclick="deleteTodo('${t.id}')" style="color:#D55E00">ğŸ—‘ åˆªé™¤</button>
              </div>
            </div>`;
          }).join('')}
      </div>
    </div>

    <!-- å·²å®Œæˆ -->
    ${done.length ? `
    <div class="card">
      <div class="card-head" style="cursor:pointer;display:flex;align-items:center;justify-content:space-between" onclick="var el=this.nextElementSibling;el.style.display=el.style.display==='none'?'block':'none'">
        <div>âœ… å·²å®Œæˆ <span class="badge badge-gray">${done.length}</span>
        <span style="font-size:11px;color:var(--text-3);margin-left:8px">é»æ“Šå±•é–‹/æ”¶åˆ</span></div>
      </div>
      <div class="card-body" style="padding:0;display:none">
        <div style="padding:8px 18px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;background:var(--surface-2)">
          <label style="font-size:11px;color:var(--text-3);cursor:pointer;display:flex;align-items:center;gap:4px">
            <input type="checkbox" id="todo-select-all" onchange="document.querySelectorAll('.todo-done-cb').forEach(function(c){c.checked=this.checked}.bind(this))" style="cursor:pointer"> å…¨é¸
          </label>
          <button class="btn btn-sm btn-outline" style="font-size:11px;color:#D55E00;margin-left:auto" onclick="var ids=[];document.querySelectorAll('.todo-done-cb:checked').forEach(function(c){ids.push(c.dataset.id)});if(!ids.length){alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„é …ç›®');return}if(confirm('ç¢ºå®šåˆªé™¤å·²é¸çš„ '+ids.length+' é …ï¼Ÿ')){ids.forEach(function(id){db.todos=db.todos.filter(function(t){return t.id!==id})});saveData(db);render()}">ğŸ—‘ åˆªé™¤å·²é¸</button>
          <button class="btn btn-sm btn-outline" style="font-size:11px;color:#D55E00" onclick="if(confirm('ç¢ºå®šåˆªé™¤å…¨éƒ¨ ${done.length} é …å·²å®Œæˆå¾…è¾¦ï¼Ÿ')){db.todos=db.todos.filter(function(t){return !t.done});saveData(db);render()}">ğŸ—‘ å…¨éƒ¨åˆªé™¤</button>
        </div>
        ${done.map(t => `<div style="display:flex;align-items:center;gap:10px;padding:10px 18px;border-bottom:1px solid var(--border);opacity:0.6">
          <input type="checkbox" class="todo-done-cb" data-id="${t.id}" style="width:16px;height:16px;cursor:pointer;flex-shrink:0">
          <input type="checkbox" checked onchange="toggleTodo('${t.id}')" style="width:18px;height:18px;cursor:pointer;flex-shrink:0;accent-color:#0072B2" title="å–æ¶ˆå®Œæˆ">
          <div style="flex:1;font-size:13px;text-decoration:line-through;color:var(--text-3)">${t.title}</div>
          <div style="font-size:11px;color:var(--text-3)">${t.doneDate ? fmtDate(t.doneDate) : ''}</div>
          <button class="btn btn-sm btn-outline" onclick="deleteTodo('${t.id}')" title="åˆªé™¤" style="color:#D55E00;font-size:11px;padding:2px 6px">ğŸ—‘</button>
        </div>`).join('')}
      </div>
    </div>` : ''}
  </div>`;
},

// â”€â”€ Google Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gcal() {
  return `<div class="topbar">
    <div class="topbar-title">Google è¡Œäº‹æ›†</div>
    <div class="topbar-actions">
      <button class="btn btn-outline btn-sm" onclick="window.open('https://calendar.google.com','_blank')">â†— é–‹å•Ÿ Google æ—¥æ›†</button>
    </div>
  </div>
  <div class="content">
    <div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);border:1px solid var(--border)">
      <iframe src="https://calendar.google.com/calendar/embed?src=bms.cheng%40gmail.com&ctz=Asia%2FTaipei&wkst=2&showTitle=0&showNav=1&showPrint=0&showTabs=1&showCalendars=0" style="border:0;width:100%;height:calc(100vh - 140px);min-height:500px" frameborder="0" scrolling="no"></iframe>
    </div>
  </div>`;
},

// â”€â”€ Archive & Backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
archive() {
  const closedCases = db.cases.filter(c => c.status === 'å·²çµ¦ä»˜' || c.status === 'å·²èª¿è§£å®Œæˆ' || c.status === 'æ’¤æ¡ˆ');
  const activeCases = db.cases.filter(c => c.status !== 'å·²çµ¦ä»˜' && c.status !== 'å·²èª¿è§£å®Œæˆ' && c.status !== 'æ’¤æ¡ˆ');
  const closedTracks = db.tracks.filter(t => closedCases.some(c => c.id === t.caseId));

  // ä¼°ç®— localStorage ä½¿ç”¨é‡
  let storageUsed = 0;
  try { const s = localStorage.getItem('case_mgmt_v4'); if (s) storageUsed = new Blob([s]).size; } catch(e){}
  const storageKB = (storageUsed / 1024).toFixed(1);
  const storagePct = Math.min((storageUsed / (5*1024*1024)) * 100, 100).toFixed(1);

  return `
  <div class="topbar">
    <div class="topbar-title">æ­¸æª”èˆ‡å‚™ä»½</div>
  </div>
  <div class="content">
    <div style="max-width:720px">

      <!-- å„²å­˜ç©ºé–“ -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head">ğŸ’¾ å„²å­˜ç©ºé–“æ¦‚æ³</div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;margin-bottom:16px">
            <div><div style="font-size:28px;font-weight:700;color:var(--navy)">${db.cases.length}</div><div style="font-size:11px;color:var(--text-3)">å…¨éƒ¨å€‹æ¡ˆ</div></div>
            <div><div style="font-size:28px;font-weight:700;color:#0072B2">${activeCases.length}</div><div style="font-size:11px;color:var(--text-3)">é€²è¡Œä¸­</div></div>
            <div><div style="font-size:28px;font-weight:700;color:var(--text-3)">${closedCases.length}</div><div style="font-size:11px;color:var(--text-3)">å·²çµæ¡ˆ/æ’¤æ¡ˆ</div></div>
          </div>
          <div style="font-size:11px;color:var(--text-2);margin-bottom:6px">localStorage ä½¿ç”¨ï¼š${storageKB} KB / 5,120 KBï¼ˆ${storagePct}%ï¼‰</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${storagePct}%;background:${parseFloat(storagePct)>80?'var(--danger)':parseFloat(storagePct)>50?'var(--warning)':'var(--gold)'}"></div></div>
        </div>
      </div>

      <!-- æ­¸æª”çµæ¡ˆ -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head" style="${closedCases.length ? 'background:rgba(201,168,76,0.06)' : ''}">
          ğŸ“¦ æ­¸æª”å·²çµæ¡ˆå€‹æ¡ˆ
          ${closedCases.length ? '<span class="badge badge-yellow">'+closedCases.length+' ç­†å¯æ­¸æª”</span>' : '<span class="badge badge-gray">ç„¡å¯æ­¸æª”å€‹æ¡ˆ</span>'}
        </div>
        <div class="card-body">
          ${closedCases.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-3);font-size:13px">ç›®å‰æ²’æœ‰å·²çµæ¡ˆæˆ–æ’¤æ¡ˆçš„å€‹æ¡ˆ</div>' : `
          <div style="padding:10px 14px;background:rgba(0,114,178,0.05);border-radius:8px;font-size:11px;color:var(--text-2);margin-bottom:14px;border-left:3px solid #0072B2">
            æ­¸æª”æœƒå…ˆä¸‹è¼‰ä¸€ä»½ JSON å‚™ä»½æª”ï¼Œç¢ºèªä¸‹è¼‰å¾Œå†å¾ç³»çµ±ä¸­åˆªé™¤ã€‚<br>
            å‚™ä»½æª”åŒ…å«å®Œæ•´çš„å€‹æ¡ˆè³‡æ–™å’Œè¿½è¹¤è»¸ï¼Œæ—¥å¾Œå¯é€éã€ŒåŒ¯å…¥ã€é‚„åŸã€‚
          </div>
          <div style="margin-bottom:14px">
            ${closedCases.map(c => {
              const tCount = db.tracks.filter(t => t.caseId === c.id).length;
              return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px">'
                + '<input type="checkbox" class="archive-cb" value="'+c.id+'" checked style="width:16px;height:16px;cursor:pointer">'
                + '<div style="flex:1;min-width:0">'
                + '<div style="font-size:13px;font-weight:600">'+c.name+' <span style="color:var(--text-3);font-weight:400">'+c.id+'</span></div>'
                + '<div style="font-size:11px;color:var(--text-3)">'+c.type+' Â· '+tCount+' æ¢è¿½è¹¤è»¸ Â· <span class="badge '+(c.status==='å·²çµ¦ä»˜'||c.status==='å·²èª¿è§£å®Œæˆ'?'status-closed':'status-closed')+'">'+c.status+'</span></div>'
                + '</div></div>';
            }).join('')}
          </div>
          <div style="display:flex;gap:10px">
            <button class="btn btn-gold" onclick="archiveSelected()">ğŸ“¦ æ­¸æª”ä¸¦ä¸‹è¼‰é¸å–çš„å€‹æ¡ˆ</button>
            <button class="btn btn-outline btn-sm" onclick="var cbs=document.querySelectorAll('.archive-cb');var allChecked=[].every.call(cbs,function(cb){return cb.checked});cbs.forEach(function(cb){cb.checked=!allChecked})">å…¨é¸ / å…¨ä¸é¸</button>
          </div>
          `}
        </div>
      </div>

      <!-- é›²ç«¯åŒæ­¥ -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head">â˜ï¸ GitHub é›²ç«¯åŒæ­¥</div>
        <div class="card-body">
          ${localStorage.getItem('gh_token') ? `
          <div style="font-size:13px;color:var(--text-2);margin-bottom:12px">âœ… å·²è¨­å®š Token Â· <span style="color:var(--text-3)">${localStorage.getItem('gh_repo')||'cheng-chengyi/case-manager'}</span>
            <button class="btn btn-sm btn-outline" style="margin-left:8px" onclick="localStorage.removeItem('gh_token');render()">é‡æ–°è¨­å®š</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <button class="btn btn-gold" onclick="ghPush()" style="width:100%">â¬†ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
            <button class="btn btn-outline" onclick="ghPull()" style="width:100%">â¬‡ï¸ å¾é›²ç«¯ä¸‹è¼‰</button>
          </div>
          ` : `
          <div style="font-size:11px;color:var(--text-3);margin-bottom:12px;line-height:1.6">
            é€é GitHub åœ¨å¤šå°é›»è…¦é–“åŒæ­¥è³‡æ–™ã€‚éœ€è¨­å®š Personal Access Tokenã€‚
          </div>
          <div class="form-grid" style="margin-bottom:12px">
            <div class="field"><label>GitHub Token</label><input type="password" id="gh-token" value="" placeholder="ghp_..." style="font-size:13px"></div>
            <div class="field"><label>Repository</label><input type="text" id="gh-repo" value="${localStorage.getItem('gh_repo')||'cheng-chengyi/case-manager'}" placeholder="user/repo" style="font-size:13px"></div>
          </div>
          <button class="btn btn-sm btn-outline" onclick="localStorage.setItem('gh_token',document.getElementById('gh-token').value);localStorage.setItem('gh_repo',document.getElementById('gh-repo').value);alert('âœ… å·²å„²å­˜è¨­å®š');render()" style="margin-bottom:14px">ğŸ’¾ å„²å­˜è¨­å®š</button>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <button class="btn btn-gold" onclick="ghPush()" style="width:100%">â¬†ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
            <button class="btn btn-outline" onclick="ghPull()" style="width:100%">â¬‡ï¸ å¾é›²ç«¯ä¸‹è¼‰</button>
          </div>
          `}
          <div id="gh-status" style="font-size:11px;color:var(--text-3);margin-top:8px;text-align:center"></div>
        </div>
      </div>

      <!-- åŒ¯å‡º -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head">ğŸ“¥ åŒ¯å‡ºå‚™ä»½</div>
        <div class="card-body">
          <button class="btn btn-gold" onclick="exportAllJson()" style="width:100%">ğŸ“¥ åŒ¯å‡ºå…¨éƒ¨è³‡æ–™ï¼ˆJSONï¼‰</button>
          <div style="font-size:11px;color:var(--text-3);margin-top:8px;text-align:center">ä¸‹è¼‰ç›®å‰ç³»çµ±å…§æ‰€æœ‰å€‹æ¡ˆã€è¿½è¹¤è»¸è³‡æ–™</div>
        </div>
      </div>

      <!-- åŒ¯å…¥ï¼šå…©ç¨®æ–¹å¼ä¸¦æ’ -->
      <div class="card">
        <div class="card-head">ğŸ“¤ åŒ¯å…¥é‚„åŸ</div>
        <div class="card-body" style="padding:0">
          <div style="display:grid;grid-template-columns:1fr 1fr;min-height:100%">

            <!-- å·¦ï¼šé‚„åŸæ­¸æª” -->
            <div style="padding:18px;border-right:1px solid var(--border)">
              <div style="font-size:15px;font-weight:700;color:#0072B2;margin-bottom:4px">â™»ï¸ é‚„åŸæ­¸æª”å€‹æ¡ˆ</div>
              <div style="font-size:11px;color:var(--text-2);margin-bottom:14px;line-height:1.6">
                æŠŠä¹‹å‰æ­¸æª”çš„å€‹æ¡ˆ<strong>åŠ å›ä¾†</strong>ã€‚<br>ç¾æœ‰é€²è¡Œä¸­çš„å€‹æ¡ˆ<strong style="color:#0072B2">ä¸å—å½±éŸ¿</strong>ã€‚
              </div>
              <div style="padding:10px;background:rgba(0,114,178,0.05);border-radius:8px;font-size:11px;color:var(--text-3);margin-bottom:14px">
                <div style="margin-bottom:4px"><strong>è¡Œç‚ºï¼š</strong>Mergeï¼ˆåˆä½µï¼‰</div>
                <div style="margin-bottom:4px"><strong>é©åˆï¼š</strong>æŸ¥èˆŠæ¡ˆã€é‡å•Ÿå·²çµæ¡ˆå€‹æ¡ˆ</div>
                <div><strong>é¢¨éšªï¼š</strong><span style="color:#0072B2">ä½</span> â€” åƒ…ç›¸åŒ ID æœƒè¢«è¦†è“‹</div>
              </div>
              <button class="btn btn-outline" onclick="document.getElementById('restore-file').click()" style="width:100%">é¸æ“‡æ­¸æª”æª”æ¡ˆ</button>
              <input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreArchive(this)">
            </div>

            <!-- å³ï¼šå…¨é‡é‚„åŸ -->
            <div style="padding:18px">
              <div style="font-size:15px;font-weight:700;color:#D55E00;margin-bottom:4px">ğŸ”„ å…¨é‡é‚„åŸ</div>
              <div style="font-size:11px;color:var(--text-2);margin-bottom:14px;line-height:1.6">
                å¾å‚™ä»½æª”<strong>å®Œæ•´é‚„åŸ</strong>ã€‚<br>ç¾æœ‰è³‡æ–™<strong style="color:#D55E00">å…¨éƒ¨è¢«å–ä»£</strong>ã€‚
              </div>
              <div style="padding:10px;background:rgba(213,94,0,0.04);border-radius:8px;font-size:11px;color:var(--text-3);margin-bottom:14px">
                <div style="margin-bottom:4px"><strong>è¡Œç‚ºï¼š</strong>è¦†è“‹ï¼ˆæ¸…ç©ºå¾ŒåŒ¯å…¥ï¼‰</div>
                <div style="margin-bottom:4px"><strong>é©åˆï¼š</strong>æ›é›»è…¦ã€ç€è¦½å™¨è³‡æ–™éºå¤±</div>
                <div><strong>é¢¨éšªï¼š</strong><span style="color:#D55E00">é«˜</span> â€” ç¾æœ‰è³‡æ–™å…¨éƒ¨æ¶ˆå¤±</div>
              </div>
              <button class="btn btn-outline" onclick="document.getElementById('import-file').click()" style="width:100%;border-color:rgba(213,94,0,0.4);color:#D55E00">é¸æ“‡å‚™ä»½æª”æ¡ˆ</button>
              <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJson(this)">
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>`;
}
};

// â”€â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openNewCase() {
  const id = genId();
  openFormModal('æ–°å¢å€‹æ¡ˆ', `
    <div class="form-grid">
      <div class="field"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-id" value="${id}" placeholder="è‡ªå‹•ç·¨è™Ÿ"></div>
      <div class="field"><label>å€‹æ¡ˆé¡å‹ *</label>
        <select id="f-type"><option value="">è«‹é¸æ“‡</option>
          <optgroup label="å‹å·¥ä¿éšª">
            <option>å‹ä¿ç”Ÿè‚²çµ¦ä»˜</option>
            <option>å‹ä¿å‚·ç—…çµ¦ä»˜</option>
            <option>å‹ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>å‹ä¿è€å¹´çµ¦ä»˜</option>
            <option>å‹ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            <option>è·ä¿é†«ç™‚çµ¦ä»˜</option>
            <option>è·ä¿å‚·ç—…çµ¦ä»˜</option>
            <option>è·ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>è·ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="å…¬ä¿è¾²ä¿">
            <option>è¾²ä¿çµ¦ä»˜</option>
            <option>å…¬ä¿çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è»Šç¦è·ç½çˆ­è­°">
            <option>è»Šç¦è™•ç†ç¨‹åº</option>
            <option>çˆ­è­°å¯©è­°è¨´é¡˜</option>
            <option>è·ç½è£œå„Ÿè³ å„Ÿ</option>
            <option>å‹è³‡çˆ­è­°äº‹é …</option>
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            <option>å£½éšª</option>
            <option>é†«ç™‚éšª</option>
            <option>æ„å¤–éšª</option>
            <option>å¤±èƒ½éšª</option>
            <option>é•·ç…§éšª</option>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="section-divider">ç•¶äº‹äººè³‡æ–™</div>
    <div class="form-grid">
      <div class="field"><label>å§“å *</label><input type="text" id="f-name"></div>
      <div class="field"><label>é€£çµ¡é›»è©±</label><input type="text" id="f-phone" placeholder="0912-345-678"></div>
    </div>
    <div class="field"><label>åœ°å€</label><input type="text" id="f-address" placeholder="é€šè¨Šåœ°å€"></div>
    <div class="form-grid">
      <div class="field"><label>å—åƒ±å…¬å¸</label><input type="text" id="f-employer" oninput="var u=document.getElementById('f-insured-unit');if(u&&!u._edited)u.value=this.value" placeholder="å…¬å¸åç¨±"></div>
      <div class="field"><label>æŠ•ä¿å–®ä½</label><input type="text" id="f-insured-unit" placeholder="é è¨­èˆ‡å—åƒ±å…¬å¸ç›¸åŒ" onfocus="this._edited=true"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="f-insurer" list="insurer-dl" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('f-insurer').value='';document.getElementById('f-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
    </div>
    <div class="form-grid cols-3">
      <div class="field"><label>äº‹æ•…/èµ·å§‹æ—¥æœŸ</label><input type="date" id="f-accident" onchange="var h=document.getElementById('hint-f-accident');if(h)h.textContent=rocHint('f-accident');"><div id="hint-f-accident" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>å—ç†æ—¥æœŸ</label><input type="date" id="f-receive" value="${new Date().toISOString().slice(0,10)}" onchange="var h=document.getElementById('hint-f-receive');if(h)h.textContent=rocHint('f-receive');"><div id="hint-f-receive" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="section-divider">æ¡ˆä»¶è³‡è¨Š</div>
    <div class="form-grid cols-3">
      <div class="field"><label>æ¥æ¡ˆç‹€æ…‹</label>
        <select id="f-status">
          ${['æœªç”³è«‹','å¾…è£œä»¶','å¯©æ ¸ä¸­','å·²çµ¦ä»˜','å·²æ‹’è³ ','ç”³è¨´ä¸­','è©•è­°ä¸­','æœªèª¿è§£','å·²èª¿è§£å®Œæˆ','èª¿è§£ä¸æˆç«‹','åµæŸ¥åº­','åˆ‘äº‹è¨´è¨Ÿ','æ°‘äº‹è¨´è¨Ÿ','çˆ­è­°å¯©è­°','è¨´é¡˜ä¸­','æ’¤æ¡ˆ'].map(s=>`<option ${s==='æœªç”³è«‹'?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-amount"></div>
    </div>
    <div style="margin-top:14px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸï¼ˆå…§éƒ¨è¦åŠƒï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:11px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-planned" onchange="var h=document.getElementById('hint-f-planned');if(h)h.textContent=rocHint('f-planned');"><div id="hint-f-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="f-planned-note" placeholder="å¦‚ï¼šé è¨ˆå‚™å¦¥æ–‡ä»¶ã€é è¨ˆé€ä»¶"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸï¼ˆæ³•å®š/æ©Ÿé—œè¦æ±‚ï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:11px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-deadline" onchange="var h=document.getElementById('hint-f-deadline');if(h)h.textContent=rocHint('f-deadline');"><div id="hint-f-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="f-deadline-note" placeholder="å¦‚ï¼šå‹ä¿å±€è£œä»¶æˆªæ­¢ã€æ³•é™¢é–‹åº­æ—¥"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><textarea id="f-note" rows="3"></textarea></div>
  `, () => {
    const newCase = {
      id: document.getElementById('f-id').value || id,
      type: document.getElementById('f-type').value,
      name: document.getElementById('f-name').value,
      phone: document.getElementById('f-phone').value,
      employer: document.getElementById('f-employer').value,
      insuredUnit: document.getElementById('f-insured-unit').value || document.getElementById('f-employer').value,
      address: document.getElementById('f-address').value,
      insurer: document.getElementById('f-insurer').value,
      accidentDate: document.getElementById('f-accident').value,
      status: document.getElementById('f-status').value,
      receiveDate: document.getElementById('f-receive').value,
      deadline: document.getElementById('f-deadline').value,
      deadlineNote: document.getElementById('f-deadline-note').value,
      plannedDate: document.getElementById('f-planned').value,
      plannedDateNote: document.getElementById('f-planned-note').value,
      amount: document.getElementById('f-amount').value,
      note: document.getElementById('f-note').value,
      created: new Date().toISOString().slice(0,10),
      updated: new Date().toISOString().slice(0,10)
    };
    if (!newCase.name || !newCase.type) { alert('å§“åå’Œå€‹æ¡ˆé¡å‹ç‚ºå¿…å¡«ï¼'); return false; }
    db.cases.push(newCase);
    saveData(db);
    return true;
  });
}

function openEditCase(id) {
  const c = db.cases.find(x => x.id === id);
  if (!c) return;
  openFormModal(`ç·¨è¼¯å€‹æ¡ˆ â€” ${c.name}`, `
    <div class="form-grid">
      <div class="field"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-id" value="${c.id}"></div>
      <div class="field"><label>å€‹æ¡ˆé¡å‹</label>
        <select id="f-type">
          <optgroup label="å‹å·¥ä¿éšª">
            ${['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            ${['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å…¬ä¿è¾²ä¿">
            ${['è¾²ä¿çµ¦ä»˜','å…¬ä¿çµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è»Šç¦è·ç½çˆ­è­°">
            ${['è»Šç¦è™•ç†ç¨‹åº','çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            ${['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª','å¼·åˆ¶éšª'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
        </select>
      </div>
    </div>
    <div class="section-divider">ç•¶äº‹äººè³‡æ–™</div>
    <div class="form-grid">
      <div class="field"><label>å§“å</label><input type="text" id="f-name" value="${c.name}"></div>
      <div class="field"><label>é€£çµ¡é›»è©±</label><input type="text" id="f-phone" value="${c.phone}"></div>
    </div>
    <div class="field"><label>åœ°å€</label><input type="text" id="f-address" value="${c.address||''}"></div>
    <div class="form-grid">
      <div class="field"><label>å—åƒ±å…¬å¸</label><input type="text" id="f-employer" value="${c.employer}" oninput="var u=document.getElementById('f-insured-unit');if(u&&!u._edited)u.value=this.value"></div>
      <div class="field"><label>æŠ•ä¿å–®ä½</label><input type="text" id="f-insured-unit" value="${c.insuredUnit||c.employer||''}" onfocus="this._edited=true"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="f-insurer" list="insurer-dl" value="${c.insurer||''}" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('f-insurer').value='';document.getElementById('f-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>äº‹æ•…/èµ·å§‹æ—¥æœŸ</label><input type="date" id="f-accident" value="${c.accidentDate}" onchange="var h=document.getElementById('hint-f-accident');if(h)h.textContent=rocHint('f-accident');"><div id="hint-f-accident" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>å—ç†æ—¥æœŸ</label><input type="date" id="f-receive" value="${c.receiveDate}" onchange="var h=document.getElementById('hint-f-receive');if(h)h.textContent=rocHint('f-receive');"><div id="hint-f-receive" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="section-divider">æ¡ˆä»¶è³‡è¨Š</div>
    <div class="form-grid cols-3">
      <div class="field"><label>æ¥æ¡ˆç‹€æ…‹</label>
        <select id="f-status">
          ${['æœªç”³è«‹','å¾…è£œä»¶','å¯©æ ¸ä¸­','å·²çµ¦ä»˜','å·²æ‹’è³ ','ç”³è¨´ä¸­','è©•è­°ä¸­','æœªèª¿è§£','å·²èª¿è§£å®Œæˆ','èª¿è§£ä¸æˆç«‹','åµæŸ¥åº­','åˆ‘äº‹è¨´è¨Ÿ','æ°‘äº‹è¨´è¨Ÿ','çˆ­è­°å¯©è­°','è¨´é¡˜ä¸­','æ’¤æ¡ˆ'].map(s=>`<option ${s===c.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-amount" value="${c.amount}"></div>
    </div>
    <div style="margin-top:14px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸï¼ˆå…§éƒ¨è¦åŠƒï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:11px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-planned" value="${c.plannedDate||''}" onchange="var h=document.getElementById('hint-f-planned');if(h)h.textContent=rocHint('f-planned');"><div id="hint-f-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="f-planned-note" value="${c.plannedDateNote||''}"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸï¼ˆæ³•å®š/æ©Ÿé—œè¦æ±‚ï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:11px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-deadline" value="${c.deadline}" onchange="var h=document.getElementById('hint-f-deadline');if(h)h.textContent=rocHint('f-deadline');"><div id="hint-f-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="f-deadline-note" value="${c.deadlineNote}"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><textarea id="f-note" rows="3">${c.note}</textarea></div>
    <div class="divider"></div>
    <button class="btn btn-danger btn-sm" onclick="if(confirm('ç¢ºå®šåˆªé™¤æ­¤å€‹æ¡ˆï¼Ÿ'))deleteCase('${c.id}')">åˆªé™¤æ­¤å€‹æ¡ˆ</button>
  `, () => {
    const newId = document.getElementById('f-id').value;
    const oldId = c.id;
    if (newId && newId !== oldId) {
      // æ›´æ–°æ‰€æœ‰é—œè¯è³‡æ–™çš„ caseId
      db.tracks.forEach(t => { if (t.caseId === oldId) t.caseId = newId; if (t.id.startsWith('TR-'+oldId+'-')) t.id = t.id.replace('TR-'+oldId+'-','TR-'+newId+'-'); });
      db.progress.forEach(p => { if (p.caseId === oldId) p.caseId = newId; });
      if (db.todos) db.todos.forEach(t => { if (t.caseId === oldId) t.caseId = newId; });
      c.id = newId;
    }
    c.type = document.getElementById('f-type').value;
    c.name = document.getElementById('f-name').value;
    c.phone = document.getElementById('f-phone').value;
    c.employer = document.getElementById('f-employer').value;
    c.insuredUnit = document.getElementById('f-insured-unit').value || document.getElementById('f-employer').value;
    c.address = document.getElementById('f-address').value;
    c.insurer = document.getElementById('f-insurer').value;
    c.accidentDate = document.getElementById('f-accident').value;
    c.status = document.getElementById('f-status').value;
    c.receiveDate = document.getElementById('f-receive').value;
    c.deadline = document.getElementById('f-deadline').value;
    c.deadlineNote = document.getElementById('f-deadline-note').value;
    c.plannedDate = document.getElementById('f-planned').value;
    c.plannedDateNote = document.getElementById('f-planned-note').value;
    c.amount = document.getElementById('f-amount').value;
    c.note = document.getElementById('f-note').value;
    c.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

function deleteCase(id) {
  db.cases = db.cases.filter(c => c.id !== id);
  db.tracks = db.tracks.filter(t => t.caseId !== id);
  db.progress = db.progress.filter(p => p.caseId !== id);
  saveData(db);
  closeModal();
  navigate('cases');
}


// â”€â”€â”€ Track Modal Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _trackAction(el) {
  var action = el.getAttribute('data-action');
  var caseId = el.getAttribute('data-case');
  var trackId = el.getAttribute('data-track');
  // æ¸…é™¤æ‰€æœ‰è¿½è¹¤è»¸é«˜äº®
  document.querySelectorAll('.track-highlight').forEach(function(e){ e.classList.remove('track-highlight'); });
  // é«˜äº®ç•¶å‰è¿½è¹¤è»¸
  if (trackId) {
    var card = document.getElementById('track-' + trackId);
    if (card) { card.classList.add('track-highlight'); }
  }
  if (action === 'addProgress') openAddProgress(caseId, trackId);
  else if (action === 'editTrack') openEditTrack(trackId);
  else if (action === 'copyTrack') copyTrack(trackId);
  else if (action === 'addTrack') openAddTrack(caseId);
  else if (action === 'scrollTo') {
    var el2 = document.getElementById('track-' + trackId);
    if (el2) { el2.classList.add('track-highlight'); el2.scrollIntoView({behavior: 'smooth'}); }
  }
}

function copyTrack(trackId) {
  var src = db.tracks.find(function(t){ return t.id === trackId; });
  if (!src) return;
  var newTr = {
    id: genTrackId(src.caseId), caseId: src.caseId,
    name: src.name + 'ï¼ˆè¤‡è£½ï¼‰',
    type: src.type, insurer: src.insurer,
    contact: src.contact || '', contactPhone: src.contactPhone || '',
    status: 'é€²è¡Œä¸­',
    deadline: src.deadline || '', deadlineNote: src.deadlineNote || '',
    plannedDate: src.plannedDate || '', plannedDateNote: src.plannedDateNote || '',
    amount: src.amount, note: src.note || '',
    created: new Date().toISOString().slice(0,10)
  };
  db.tracks.push(newTr);
  var c = db.cases.find(function(x){ return x.id === src.caseId; });
  if (c) c.updated = new Date().toISOString().slice(0,10);
  saveData(db);
  render();
  alert('å·²è¤‡è£½è¿½è¹¤è»¸ã€Œ' + src.name + 'ã€ï¼Œè«‹ç·¨è¼¯ä¿®æ”¹åç¨±å’Œæ—¥æœŸã€‚');
}

function openAddTrack(caseId) {
  var c = db.cases.find(function(x){ return x.id === caseId; });
  openFormModal('æ–°å¢è¿½è¹¤è»¸ â€” ' + (c ? c.name : caseId), `
    <div style="padding:10px 12px;background:rgba(201,168,76,0.08);border-radius:8px;font-size:11px;color:var(--text-2);margin-bottom:14px">
      åŒä¸€å€‹æ¡ˆä¸»å¯åŒæ™‚ä¸¦è¡Œå¤šæ¢è¿½è¹¤è»¸ï¼Œå„æœ‰è‡ªå·±çš„æœŸé™èˆ‡å‚™è¨»ã€‚
    </div>
    <div class="form-grid">
      <div class="field form-full"><label>è¿½è¹¤è»¸åç¨± *</label>
        <input type="text" id="ft-name" placeholder="ä¾‹ï¼šå‹ä¿å‚·ç—…çµ¦ä»˜ç”³è«‹ã€å¯Œé‚¦é†«ç™‚éšªç†è³ ">
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>é¡å‹ *</label>
        <select id="ft-type"><option value="">è«‹é¸æ“‡</option>
          <optgroup label="å‹å·¥ä¿éšª">
            <option>å‹ä¿ç”Ÿè‚²çµ¦ä»˜</option><option>å‹ä¿å‚·ç—…çµ¦ä»˜</option><option>å‹ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>å‹ä¿è€å¹´çµ¦ä»˜</option><option>å‹ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            <option>è·ä¿é†«ç™‚çµ¦ä»˜</option><option>è·ä¿å‚·ç—…çµ¦ä»˜</option><option>è·ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>è·ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="å…¬ä¿è¾²ä¿">
            <option>è¾²ä¿çµ¦ä»˜</option><option>å…¬ä¿çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è»Šç¦è·ç½çˆ­è­°">
            <option>è»Šç¦è™•ç†ç¨‹åº</option><option>çˆ­è­°å¯©è­°è¨´é¡˜</option><option>è·ç½è£œå„Ÿè³ å„Ÿ</option><option>å‹è³‡çˆ­è­°äº‹é …</option>
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            <option>å£½éšª</option><option>é†«ç™‚éšª</option><option>æ„å¤–éšª</option>
            <option>å¤±èƒ½éšª</option><option>é•·ç…§éšª</option><option>å¼·åˆ¶éšª</option>
          </optgroup>
        </select>
      </div>
      <div class="field"><label>ç›®å‰ç‹€æ…‹</label>
        <select id="ft-status">
          ${['æœªç”³è«‹','å¾…è£œä»¶','å¯©æ ¸ä¸­','å·²çµ¦ä»˜','å·²æ‹’è³ ','ç”³è¨´ä¸­','è©•è­°ä¸­','æœªèª¿è§£','å·²èª¿è§£å®Œæˆ','èª¿è§£ä¸æˆç«‹','åµæŸ¥åº­','åˆ‘äº‹è¨´è¨Ÿ','æ°‘äº‹è¨´è¨Ÿ','çˆ­è­°å¯©è­°','è¨´é¡˜ä¸­','æ’¤æ¡ˆ'].map(s=>`<option ${s==='æœªç”³è«‹'?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="ft-insurer" list="insurer-dl" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('ft-insurer').value='';document.getElementById('ft-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
      <div class="field"><label>æ‰¿è¾¦äººå“¡</label><input type="text" id="ft-contact" placeholder="ä¿éšªå…¬å¸/æ©Ÿé—œæ‰¿è¾¦äººå§“å"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>æ‰¿è¾¦äººé›»è©±</label><input type="text" id="ft-contact-phone" placeholder="åˆ†æ©Ÿæˆ–æ‰‹æ©Ÿ"></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="ft-amount" placeholder="0"></div>
    </div>
    <div style="margin-top:12px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">ğŸ”” æé†’æ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>æé†’æ—¥æœŸ</label><input type="date" id="ft-deadline" onchange="var h=document.getElementById('hint-ft-deadline');if(h)h.textContent=rocHint('ft-deadline');"><div id="hint-ft-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æé†’èªªæ˜</label><input type="text" id="ft-deadline-note" placeholder="å¦‚ï¼šå‹ä¿å±€è£œä»¶æˆªæ­¢"></div>
      </div>
      <div style="border-top:1px dashed rgba(213,94,0,0.2);margin-top:10px;padding-top:10px">
        <div class="form-grid">
          <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ</label><input type="date" id="ft-planned" onchange="var h=document.getElementById('hint-ft-planned');if(h)h.textContent=rocHint('ft-planned');"><div id="hint-ft-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
          <div class="field"><label>é è¨ˆå®Œæˆèªªæ˜</label><input type="text" id="ft-planned-note" placeholder="å¦‚ï¼šé è¨ˆå‚™å¦¥æ–‡ä»¶"></div>
        </div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><input type="text" id="ft-note"></div>
  `, () => {
    var name = document.getElementById('ft-name').value;
    if (!name) { alert('è¿½è¹¤è»¸åç¨±ç‚ºå¿…å¡«ï¼'); return false; }
    var tr = {
      id: genTrackId(caseId), caseId: caseId, name: name,
      type: document.getElementById('ft-type').value,
      insurer: document.getElementById('ft-insurer').value,
      contact: document.getElementById('ft-contact').value,
      contactPhone: document.getElementById('ft-contact-phone').value,
      status: document.getElementById('ft-status').value,
      deadline: document.getElementById('ft-deadline').value,
      deadlineNote: document.getElementById('ft-deadline-note').value,
      plannedDate: document.getElementById('ft-planned').value,
      plannedDateNote: document.getElementById('ft-planned-note').value,
      amount: document.getElementById('ft-amount').value,
      note: document.getElementById('ft-note').value,
      created: new Date().toISOString().slice(0,10)
    };
    db.tracks.push(tr);
    // è‡ªå‹•å»ºç«‹ç¬¬ä¸€ç­†é€²åº¦è¨˜éŒ„
    db.progress.push({
      id: genProgressId(),
      caseId: caseId,
      trackId: tr.id,
      date: new Date().toISOString().slice(0,10),
      stage: tr.status || 'æœªç”³è«‹',
      desc: 'å»ºç«‹è¿½è¹¤è»¸ï¼š' + tr.name,
      sendRecv: '', nextStep: '', nextDate: '', note: ''
    });
    var c2 = db.cases.find(function(x){ return x.id === caseId; });
    if (c2) c2.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

function openEditTrack(trackId) {
  var tr = db.tracks.find(function(x){ return x.id === trackId; });
  if (!tr) return;
  openFormModal(`ç·¨è¼¯è¿½è¹¤è»¸ â€” ${tr.name}`, `
    <div class="form-grid">
      <div class="field form-full"><label>è¿½è¹¤è»¸åç¨± *</label>
        <input type="text" id="ft-name" value="${tr.name}">
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>é¡å‹</label>
        <select id="ft-type">
          <optgroup label="å‹å·¥ä¿éšª">
            ${['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            ${['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å…¬ä¿è¾²ä¿">
            ${['è¾²ä¿çµ¦ä»˜','å…¬ä¿çµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è»Šç¦è·ç½çˆ­è­°">
            ${['è»Šç¦è™•ç†ç¨‹åº','çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            ${['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª','å¼·åˆ¶éšª'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
        </select>
      </div>
      <div class="field"><label>ç›®å‰ç‹€æ…‹</label>
        <select id="ft-status" onchange="var cr=document.getElementById('ft-closed-row');if(cr)cr.style.display=(this.value==='å·²çµ¦ä»˜'||this.value==='å·²èª¿è§£å®Œæˆ'||this.value==='æ’¤æ¡ˆ')?'block':'none'">
          ${['æœªç”³è«‹','å¾…è£œä»¶','å¯©æ ¸ä¸­','å·²çµ¦ä»˜','å·²æ‹’è³ ','ç”³è¨´ä¸­','è©•è­°ä¸­','æœªèª¿è§£','å·²èª¿è§£å®Œæˆ','èª¿è§£ä¸æˆç«‹','åµæŸ¥åº­','åˆ‘äº‹è¨´è¨Ÿ','æ°‘äº‹è¨´è¨Ÿ','çˆ­è­°å¯©è­°','è¨´é¡˜ä¸­','æ’¤æ¡ˆ'].map(s=>`<option ${s===tr.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div id="ft-closed-row" style="display:${(tr.status==='å·²çµ¦ä»˜'||tr.status==='å·²èª¿è§£å®Œæˆ'||tr.status==='æ’¤æ¡ˆ')?'block':'none'};margin-top:8px;padding:12px 14px;background:rgba(0,114,178,0.05);border:1px solid rgba(0,114,178,0.2);border-radius:8px;margin-bottom:8px">
      <div style="font-size:11px;font-weight:700;color:#0072B2;margin-bottom:8px">âœ“ çµæ¡ˆæ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>çµæ¡ˆæ—¥æœŸ</label><input type="date" id="ft-closed-date" value="${tr.closedDate||''}" onchange="var h=document.getElementById('hint-ft-closed-date');if(h)h.textContent=rocHint('ft-closed-date');"><div id="hint-ft-closed-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>çµæ¡ˆèªªæ˜</label><input type="text" id="ft-closed-note" value="${tr.closedNote||''}" placeholder="å¦‚ï¼šæ ¸å®šçµ¦ä»˜ã€èª¿è§£æˆç«‹"></div>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="ft-insurer" list="insurer-dl" value="${tr.insurer||''}" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('ft-insurer').value='';document.getElementById('ft-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
      <div class="field"><label>æ‰¿è¾¦äººå“¡</label><input type="text" id="ft-contact" value="${tr.contact||''}" placeholder="ä¿éšªå…¬å¸/æ©Ÿé—œæ‰¿è¾¦äººå§“å"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>æ‰¿è¾¦äººé›»è©±</label><input type="text" id="ft-contact-phone" value="${tr.contactPhone||''}" placeholder="åˆ†æ©Ÿæˆ–æ‰‹æ©Ÿ"></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="ft-amount" value="${tr.amount||''}"></div>
    </div>
    <div style="margin-top:12px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">ğŸ”” æé†’æ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>æé†’æ—¥æœŸ</label><input type="date" id="ft-deadline" value="${tr.deadline||''}" onchange="var h=document.getElementById('hint-ft-deadline');if(h)h.textContent=rocHint('ft-deadline');"><div id="hint-ft-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æé†’èªªæ˜</label><input type="text" id="ft-deadline-note" value="${tr.deadlineNote||''}"></div>
      </div>
      <div style="border-top:1px dashed rgba(213,94,0,0.2);margin-top:10px;padding-top:10px">
        <div class="form-grid">
          <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ</label><input type="date" id="ft-planned" value="${tr.plannedDate||''}" onchange="var h=document.getElementById('hint-ft-planned');if(h)h.textContent=rocHint('ft-planned');"><div id="hint-ft-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
          <div class="field"><label>é è¨ˆå®Œæˆèªªæ˜</label><input type="text" id="ft-planned-note" value="${tr.plannedDateNote||''}"></div>
        </div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><input type="text" id="ft-note" value="${tr.note||''}"></div>
    <div class="divider"></div>
    <button class="btn btn-danger btn-sm" onclick="if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¿½è¹¤è»¸ï¼Ÿ'))deleteTrack('${tr.id}')">åˆªé™¤æ­¤è¿½è¹¤è»¸</button>
  `, () => {
    tr.name = document.getElementById('ft-name').value;
    tr.type = document.getElementById('ft-type').value;
    tr.insurer = document.getElementById('ft-insurer').value;
    tr.contact = document.getElementById('ft-contact').value;
    tr.contactPhone = document.getElementById('ft-contact-phone').value;
    tr.status = document.getElementById('ft-status').value;
    var tcd = document.getElementById('ft-closed-date'); if (tcd) tr.closedDate = tcd.value || '';
    var tcn = document.getElementById('ft-closed-note'); if (tcn) tr.closedNote = tcn.value || '';
    tr.amount = document.getElementById('ft-amount').value;
    tr.deadline = document.getElementById('ft-deadline').value;
    tr.deadlineNote = document.getElementById('ft-deadline-note').value;
    tr.plannedDate = document.getElementById('ft-planned').value;
    tr.plannedDateNote = document.getElementById('ft-planned-note').value;
    tr.note = document.getElementById('ft-note').value;
    saveData(db);
    return true;
  });
}

function deleteTrack(trackId) {
  db.tracks = db.tracks.filter(function(t){ return t.id !== trackId; });
  db.progress = db.progress.filter(function(p){ return p.trackId !== trackId; });
  saveData(db);
  closeModal();
}

function markDeadlineDone(id, type) {
  // å…ˆæ‰¾è¿½è¹¤è»¸
  var tr = db.tracks.find(function(t){ return t.id === id; });
  if (tr) {
    if (type === 'deadline') {
      tr.deadlineDone = !tr.deadlineDone;
      tr.deadlineDoneDate = tr.deadlineDone ? new Date().toISOString().slice(0,10) : '';
    } else if (type === 'planned') {
      tr.plannedDone = !tr.plannedDone;
      tr.plannedDoneDate = tr.plannedDone ? new Date().toISOString().slice(0,10) : '';
    }
  } else {
    var c = db.cases.find(function(x){ return x.id === id; });
    if (c) {
      if (type === 'deadline') {
        c.deadlineDone = !c.deadlineDone;
        c.deadlineDoneDate = c.deadlineDone ? new Date().toISOString().slice(0,10) : '';
      } else if (type === 'planned') {
        c.plannedDone = !c.plannedDone;
        c.plannedDoneDate = c.plannedDone ? new Date().toISOString().slice(0,10) : '';
      }
    }
  }
  saveData(db);
  render();
}

function openAddProgress(caseIdDefault, trackIdDefault) {
  const caseOpts = db.cases.map(c => `<option value="${c.id}" ${c.id===caseIdDefault?'selected':''}>${c.id} ${c.name}</option>`).join('');
  const allTracks = trackIdDefault ? db.tracks.filter(t => t.caseId === caseIdDefault) : db.tracks;
  const trackOpts = allTracks.map(t => `<option value="${t.id}" ${t.id===trackIdDefault?'selected':''}>${t.name} (${t.type})</option>`).join('');
  openFormModal('æ–°å¢é€²åº¦è¨˜éŒ„', `
    <div class="form-grid">
      <div class="field"><label>æ‰€å±¬å€‹æ¡ˆ *</label>
        <select id="fp-case" onchange="var tid=document.getElementById('fp-track');if(tid){tid.innerHTML='<option value=\\'\\'>â€”</option>'+db.tracks.filter(t=>t.caseId===this.value).map(t=>'<option value=\\''+t.id+'\\'>'+t.name+' ('+t.type+')</option>').join('')}">
          <option value="">è«‹é¸æ“‡</option>${caseOpts}
        </select>
      </div>
      <div class="field"><label>è¿½è¹¤è»¸</label>
        <select id="fp-track"><option value="">â€”</option>${trackOpts}</select>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>æ—¥æœŸ *</label><input type="date" id="fp-date" value="${new Date().toISOString().slice(0,10)}" onchange="var h=document.getElementById('hint-fp-date');if(h)h.textContent=rocHint('fp-date');"><div id="hint-fp-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>é€²åº¦éšæ®µ *</label>
        <select id="fp-stage">
          ${['æœªç”³è«‹','å¾…è£œä»¶','å¯©æ ¸ä¸­','å·²çµ¦ä»˜','å·²æ‹’è³ ','ç”³è¨´ä¸­','è©•è­°ä¸­','æœªèª¿è§£','å·²èª¿è§£å®Œæˆ','èª¿è§£ä¸æˆç«‹','åµæŸ¥åº­','åˆ‘äº‹è¨´è¨Ÿ','æ°‘äº‹è¨´è¨Ÿ','çˆ­è­°å¯©è­°','è¨´é¡˜ä¸­','æ’¤æ¡ˆ'].map(s=>`<option>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="field"><label>è¾¦ç†äº‹é …èªªæ˜ *</label><textarea id="fp-desc" rows="2" placeholder="èªªæ˜æœ¬æ¬¡è¾¦ç†å…§å®¹"></textarea></div>
    <div class="form-grid">
      <div class="field"><label>æ”¶/é€ä»¶</label>
        <select id="fp-sr"><option value="">â€”</option><option>æ”¶ä»¶</option><option>é€ä»¶</option></select>
      </div>
      <div class="field"><label>ä¸‹ä¸€æ­¥</label><input type="text" id="fp-next" placeholder="ä¸‹ä¸€æ­¥å‹•ä½œ"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¸‹æ¬¡é‡è¦æ—¥æœŸ</label><input type="date" id="fp-next-date" onchange="var h=document.getElementById('hint-fp-next-date');if(h)h.textContent=rocHint('fp-next-date');"><div id="hint-fp-next-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>å‚™è¨»</label><input type="text" id="fp-note"></div>
    </div>
  `, () => {
    const caseId = document.getElementById('fp-case').value;
    const desc = document.getElementById('fp-desc').value;
    if (!caseId || !desc) { alert('å€‹æ¡ˆå’Œè¾¦ç†äº‹é …ç‚ºå¿…å¡«ï¼'); return false; }
    var p = {
      id: genProgressId(),
      caseId: caseId,
      trackId: document.getElementById('fp-track').value,
      date: document.getElementById('fp-date').value,
      stage: document.getElementById('fp-stage').value,
      desc: desc,
      sendRecv: document.getElementById('fp-sr').value,
      nextStep: document.getElementById('fp-next').value,
      nextDate: document.getElementById('fp-next-date').value,
      note: document.getElementById('fp-note').value
    };
    db.progress.push(p);
    var c2 = db.cases.find(x => x.id === caseId);
    if (c2) c2.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

// â”€â”€â”€ Modal Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFormModal(title, body, onConfirm) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-head">
        <h2>${title}</h2>
        <button class="btn btn-outline btn-icon" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">${body}</div>
      <div class="modal-foot">
        <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-gold" onclick="confirmModal()">ç¢ºèªå„²å­˜</button>
      </div>
    </div>`;
  overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
  document.body.appendChild(overlay);
  window._modalConfirm = onConfirm;
  setTimeout(() => {
    ['f-accident','f-receive','f-deadline','f-planned','fp-date','fp-next-date','ft-deadline','ft-planned','f-closed-date','ft-closed-date'].forEach(function(id) {
      var el = document.getElementById(id);
      var hint = document.getElementById('hint-'+id);
      if (el && hint && el.value) hint.textContent = rocHint(id);
    });
  }, 60);
}
function closeModal() {
  document.querySelector('.modal-overlay')?.remove();
  render();
}
function confirmModal() {
  if (window._modalConfirm && window._modalConfirm() !== false) closeModal();
}


// Insurer datalist injected via JS
document.body.insertAdjacentHTML("beforeend",'<datalist id="insurer-dl"><option value="å‹ä¿å±€"><option value="å°éŠ€äººå£½"><option value="å°ç£äººå£½"><option value="ä¿èª äººå£½"><option value="åœ‹æ³°äººå£½"><option value="å‡±åŸºäººå£½"><option value="å—å±±äººå£½"><option value="æ–°å…‰äººå£½"><option value="å¯Œé‚¦äººå£½"><option value="ä¸‰å•†ç¾é‚¦äººå£½"><option value="é é›„äººå£½"><option value="å®æ³°äººå£½"><option value="å®‰è¯äººå£½"><option value="ç¬¬ä¸€é‡‘äººå£½"><option value="åˆåº«äººå£½"><option value="å°æ–°äººå£½"><option value="å…¨çƒäººå£½"><option value="å…ƒå¤§äººå£½"><option value="å®‰é”äººå£½"><option value="å‹é‚¦äººå£½"><option value="æ³•å·´äººå£½"><option value="å…†è±ç”¢éšª"><option value="è‡ºç£ç”¢éšª"><option value="å¯Œé‚¦ç”¢éšª"><option value="å’Œæ³°ç”¢éšª"><option value="æ³°å®‰ç”¢éšª"><option value="æ˜å°ç”¢éšª"><option value="å—å±±ç”¢éšª"><option value="ç¬¬ä¸€ç”¢éšª"><option value="æ—ºæ—ºå‹è¯ç”¢éšª"><option value="è¯å—ç”¢éšª"><option value="æ–°å…‰ç”¢éšª"><option value="åœ‹æ³°ç”¢éšª"><option value="æ–°å®‰æ±äº¬ç”¢éšª"><option value="ä¸­åœ‹ä¿¡è¨—ç”¢éšª"><option value="å®‰é”ç”¢éšª"><option value="æ³•å·´ç”¢éšª"><option value="AIGç”¢éšª"></datalist>');

// â”€â”€â”€ Archive & Backup Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function archiveSelected() {
  const checkboxes = document.querySelectorAll('.archive-cb:checked');
  const ids = Array.from(checkboxes).map(cb => cb.value);
  if (ids.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å€‹æ¡ˆï¼'); return; }

  // æ”¶é›†è¦æ­¸æª”çš„è³‡æ–™
  const archiveCases = db.cases.filter(c => ids.includes(c.id));
  const archiveTracks = db.tracks.filter(t => ids.includes(t.caseId));

  const archiveData = {
    _type: 'archive',
    _date: new Date().toISOString(),
    _note: 'æ­¸æª”å€‹æ¡ˆï¼š' + archiveCases.map(c => c.id + ' ' + c.name).join('ã€'),
    cases: archiveCases,
    tracks: archiveTracks
  };

  // ä¸‹è¼‰
  const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'æ­¸æª”_' + ids.join('_') + '_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);

  // ç¢ºèªåˆªé™¤
  setTimeout(function() {
    const names = archiveCases.map(c => c.id + ' ' + c.name).join('\n  ');
    if (confirm('æª”æ¡ˆå·²ä¸‹è¼‰ã€‚\n\nç¢ºå®šè¦å¾ç³»çµ±ä¸­åˆªé™¤ä»¥ä¸‹ ' + ids.length + ' å€‹å€‹æ¡ˆï¼Ÿ\n  ' + names + '\n\nï¼ˆå¯éš¨æ™‚å¾å‚™ä»½æª”é‚„åŸï¼‰')) {
      db.cases = db.cases.filter(c => !ids.includes(c.id));
      db.tracks = db.tracks.filter(t => !ids.includes(t.caseId));
      db.progress = db.progress.filter(p => !ids.includes(p.caseId));
      saveData(db);
      alert('âœ… å·²åˆªé™¤ ' + ids.length + ' å€‹çµæ¡ˆå€‹æ¡ˆï¼Œè³‡æ–™å·²æ­¸æª”ä¿å­˜ã€‚');
      render();
    }
  }, 500);
}

function exportAllJson() {
  const data = {
    _type: 'full_backup',
    _date: new Date().toISOString(),
    cases: db.cases,
    tracks: db.tracks,
    progress: db.progress,
    todos: db.todos
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'å€‹æ¡ˆç®¡ç†_å…¨é‡å‚™ä»½_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

// â”€â”€â”€ GitHub Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ghStatus(msg, isError) {
  const el = document.getElementById('gh-status');
  if (el) { el.textContent = msg; el.style.color = isError ? '#D55E00' : 'var(--text-3)'; }
}

// èƒŒæ™¯éœé»˜æ¨é€ï¼ˆä¸å½ˆè¨Šæ¯ï¼‰
async function ghPushSilent(data) {
  const token = localStorage.getItem('gh_token');
  const repo = localStorage.getItem('gh_repo');
  if (!token || !repo) return;
  try {
    const payload = { _type:'cloud_sync', _date:new Date().toISOString(), cases:data.cases, tracks:data.tracks, progress:data.progress, todos:data.todos };
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));
    let sha = null;
    try {
      const getRes = await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', { headers:{'Authorization':'Bearer '+token} });
      if (getRes.ok) { const f = await getRes.json(); sha = f.sha; }
    } catch(e) {}
    const body = { message:'auto-sync: '+new Date().toISOString().slice(0,16), content:content };
    if (sha) body.sha = sha;
    await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', {
      method:'PUT', headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    // æ›´æ–°åŒæ­¥æŒ‡ç¤ºå™¨
    const ind = document.getElementById('sync-indicator');
    if (ind) { ind.textContent = 'â˜ï¸ å·²åŒæ­¥'; ind.style.color = '#0072B2'; setTimeout(()=>{ ind.textContent = 'â˜ï¸'; ind.style.color = 'var(--text-3)'; }, 3000); }
  } catch(e) {
    const ind = document.getElementById('sync-indicator');
    if (ind) { ind.textContent = 'âš ï¸ åŒæ­¥å¤±æ•—'; ind.style.color = '#D55E00'; setTimeout(()=>{ ind.textContent = 'â˜ï¸'; ind.style.color = 'var(--text-3)'; }, 5000); }
  }
}

// é é¢è¼‰å…¥è‡ªå‹•æ‹‰å–
async function ghAutoPull() {
  const token = localStorage.getItem('gh_token');
  const repo = localStorage.getItem('gh_repo');
  if (!token || !repo) return;
  try {
    const res = await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', { headers:{'Authorization':'Bearer '+token} });
    if (!res.ok) return;
    const f = await res.json();
    const json = decodeURIComponent(escape(atob(f.content)));
    const remote = JSON.parse(json);
    if (!remote.cases) return;
    // æ¯”è¼ƒé ç«¯å’Œæœ¬æ©Ÿèª°è¼ƒæ–°
    const remoteTime = new Date(remote._date || 0).getTime();
    const localData = localStorage.getItem(STORAGE_KEY);
    const local = localData ? JSON.parse(localData) : null;
    const localTime = local && local._date ? new Date(local._date).getTime() : 0;
    if (remoteTime > localTime) {
      // é ç«¯è¼ƒæ–°ï¼Œè‡ªå‹•æ›´æ–°æœ¬æ©Ÿ
      db.cases = remote.cases || [];
      db.tracks = remote.tracks || [];
      db.progress = remote.progress || [];
      db.todos = remote.todos || [];
      db._date = remote._date;
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); } catch(e) {}
      render();
    }
  } catch(e) { /* éœé»˜å¤±æ•— */ }
}

async function ghPush() {
  const token = localStorage.getItem('gh_token');
  const repo = localStorage.getItem('gh_repo');
  if (!token || !repo) { alert('è«‹å…ˆè¨­å®š GitHub Token å’Œ Repository'); return; }
  ghStatus('â³ ä¸Šå‚³ä¸­...');
  try {
    const data = { _type:'cloud_sync', _date:new Date().toISOString(), cases:db.cases, tracks:db.tracks, progress:db.progress, todos:db.todos };
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    // Get current file SHA if exists
    let sha = null;
    try {
      const getRes = await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', { headers:{'Authorization':'Bearer '+token} });
      if (getRes.ok) { const f = await getRes.json(); sha = f.sha; }
    } catch(e) {}
    const body = { message:'sync: '+new Date().toISOString().slice(0,16), content:content };
    if (sha) body.sha = sha;
    const putRes = await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', {
      method:'PUT', headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'}, body:JSON.stringify(body)
    });
    if (!putRes.ok) throw new Error('HTTP ' + putRes.status);
    ghStatus('âœ… ä¸Šå‚³æˆåŠŸï¼ ' + new Date().toLocaleTimeString());
  } catch(err) {
    ghStatus('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + err.message, true);
  }
}

async function ghPull() {
  const token = localStorage.getItem('gh_token');
  const repo = localStorage.getItem('gh_repo');
  if (!token || !repo) { alert('è«‹å…ˆè¨­å®š GitHub Token å’Œ Repository'); return; }
  ghStatus('â³ ä¸‹è¼‰ä¸­...');
  try {
    const res = await fetch('https://api.github.com/repos/'+repo+'/contents/data.json', { headers:{'Authorization':'Bearer '+token} });
    if (!res.ok) throw new Error(res.status === 404 ? 'é›²ç«¯å°šç„¡è³‡æ–™ï¼Œè«‹å…ˆä¸Šå‚³' : 'HTTP ' + res.status);
    const f = await res.json();
    const json = decodeURIComponent(escape(atob(f.content)));
    const data = JSON.parse(json);
    if (!data.cases) throw new Error('è³‡æ–™æ ¼å¼ä¸æ­£ç¢º');
    if (!confirm('å¾é›²ç«¯ä¸‹è¼‰æœƒè¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼ˆ' + db.cases.length + ' ç­† â†’ ' + data.cases.length + ' ç­†ï¼‰ï¼Œç¢ºå®šï¼Ÿ')) { ghStatus('å·²å–æ¶ˆ'); return; }
    db.cases = data.cases || [];
    db.tracks = data.tracks || [];
    db.progress = data.progress || [];
    db.todos = data.todos || [];
    saveData(db);
    ghStatus('âœ… ä¸‹è¼‰æˆåŠŸï¼å…± ' + db.cases.length + ' ç­†å€‹æ¡ˆ ' + new Date().toLocaleTimeString());
    render();
  } catch(err) {
    ghStatus('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + err.message, true);
  }
}

function importJson(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.cases) throw new Error('JSON æ ¼å¼ä¸æ­£ç¢º');
      if (!confirm('åŒ¯å…¥æœƒè¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼ˆ' + db.cases.length + ' ç­†å€‹æ¡ˆï¼‰ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;
      db.cases = data.cases || [];
      db.tracks = data.tracks || [];
      db.progress = data.progress || [];
      saveData(db);
      alert('âœ… åŒ¯å…¥å®Œæˆï¼å…± ' + db.cases.length + ' ç­†å€‹æ¡ˆã€‚');
      render();
    } catch(err) {
      alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function restoreArchive(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.cases || !data.cases.length) throw new Error('æ‰¾ä¸åˆ°å€‹æ¡ˆè³‡æ–™');
      const names = data.cases.map(c => c.id + ' ' + c.name).join('\n  ');
      if (!confirm('å³å°‡é‚„åŸä»¥ä¸‹ ' + data.cases.length + ' å€‹å€‹æ¡ˆï¼š\n  ' + names + '\n\nå·²å­˜åœ¨ç›¸åŒç·¨è™Ÿçš„å€‹æ¡ˆæœƒè¢«è¦†è“‹ã€‚ç¢ºå®šç¹¼çºŒï¼Ÿ')) return;

      // Merge: upsert by ID
      (data.cases || []).forEach(function(c) {
        const idx = db.cases.findIndex(x => x.id === c.id);
        if (idx >= 0) db.cases[idx] = c; else db.cases.push(c);
      });
      (data.tracks || []).forEach(function(t) {
        const idx = db.tracks.findIndex(x => x.id === t.id);
        if (idx >= 0) db.tracks[idx] = t; else db.tracks.push(t);
      });
      saveData(db);
      alert('âœ… é‚„åŸå®Œæˆï¼å·²åŠ å› ' + data.cases.length + ' å€‹å€‹æ¡ˆã€‚');
      render();
    } catch(err) {
      alert('âŒ é‚„åŸå¤±æ•—ï¼š' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

// â”€â”€â”€ Todo Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addSubtaskRow(title, dueDate) {
  const list = document.getElementById('subtask-list');
  if (!list) return;
  var hint = document.getElementById('subtask-empty');
  if (hint) hint.style.display = 'none';
  const row = document.createElement('div');
  row.style.cssText = 'display:flex;align-items:center;gap:6px;margin-bottom:6px';
  row.innerHTML = '<input type="text" class="st-title" value="'+(title||'')+'" placeholder="ç´°é …åç¨±" style="flex:1;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px">'
    + '<input type="date" class="st-date" value="'+(dueDate||'')+'" style="width:140px;padding:7px 8px;border:1px solid var(--border);border-radius:6px;font-size:13px">'
    + '<button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;color:#D55E00;cursor:pointer;font-size:16px;padding:4px">âœ•</button>';
  list.appendChild(row);
}

function collectSubtasks() {
  const rows = document.querySelectorAll('#subtask-list > div');
  const result = [];
  rows.forEach(row => {
    const title = row.querySelector('.st-title').value.trim();
    if (title) result.push({ title: title, dueDate: row.querySelector('.st-date').value, done: false });
  });
  return result;
}

function openAddTodo(prefillCaseId) {
  openFormModal('æ–°å¢å¾…è¾¦äº‹é …', `
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="field"><label>å¾…è¾¦å…§å®¹ *</label><input type="text" id="td-title" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..."></div>
      <div class="form-grid">
        <div class="field"><label>æé†’æ—¥æœŸ</label><input type="date" id="td-remind"></div>
        <div class="field"><label>åˆ°æœŸæ—¥</label><input type="date" id="td-due"></div>
      </div>
      <div class="field"><label>é—œè¯å€‹æ¡ˆ</label>
        <select id="td-case"><option value="">ç„¡</option>${db.cases.map(c=>'<option value="'+c.id+'"'+(c.id===prefillCaseId?' selected':'')+'>'+c.id+' '+c.name+'</option>').join('')}</select>
      </div>
      <div style="padding:12px 14px;background:rgba(0,114,178,0.04);border:1px solid rgba(0,114,178,0.15);border-radius:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <label style="font-size:13px;font-weight:600;color:#0072B2">ğŸ“‹ ç´°é …ï¼ˆå­å¾…è¾¦ï¼‰</label>
          <button type="button" class="btn btn-outline btn-sm" style="border-color:#0072B2;color:#0072B2" onclick="addSubtaskRow()">ï¼‹ æ–°å¢ç´°é …</button>
        </div>
        <div id="subtask-list"></div>
        <div id="subtask-empty" style="font-size:11px;color:var(--text-3);text-align:center;padding:8px">é»æ“Šã€Œï¼‹ æ–°å¢ç´°é …ã€åŠ å…¥å­å¾…è¾¦é …ç›®</div>
      </div>
      <div class="field"><label>å‚™è¨»</label><textarea id="td-note" rows="2" placeholder="å‚™è¨»èªªæ˜..."></textarea></div>
    </div>
  `, function() {
    const title = document.getElementById('td-title').value.trim();
    if (!title) { alert('è«‹è¼¸å…¥å¾…è¾¦å…§å®¹ï¼'); return false; }
    db.todos.push({
      id: genTodoId(), title: title,
      dueDate: document.getElementById('td-due').value,
      remind: document.getElementById('td-remind').value,
      caseId: document.getElementById('td-case').value,
      note: document.getElementById('td-note').value,
      subtasks: collectSubtasks(),
      done: false, doneDate: null,
      created: new Date().toISOString().slice(0,10)
    });
    saveData(db); return true;
  });
}

function openEditTodo(id) {
  const t = db.todos.find(x => x.id === id);
  if (!t) return;
  openFormModal('ç·¨è¼¯å¾…è¾¦äº‹é …', `
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="field"><label>å¾…è¾¦å…§å®¹ *</label><input type="text" id="td-title" value="${t.title}"></div>
      <div class="form-grid">
        <div class="field"><label>æé†’æ—¥æœŸ</label><input type="date" id="td-remind" value="${(t.remind||'').slice(0,10)}"></div>
        <div class="field"><label>åˆ°æœŸæ—¥</label><input type="date" id="td-due" value="${t.dueDate||''}"></div>
      </div>
      <div class="field"><label>é—œè¯å€‹æ¡ˆ</label>
        <select id="td-case"><option value="">ç„¡</option>${db.cases.map(c=>'<option value="'+c.id+'" '+(t.caseId===c.id?'selected':'')+'>'+c.id+' '+c.name+'</option>').join('')}</select>
      </div>
      <div style="padding:12px 14px;background:rgba(0,114,178,0.04);border:1px solid rgba(0,114,178,0.15);border-radius:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <label style="font-size:13px;font-weight:600;color:#0072B2">ğŸ“‹ ç´°é …ï¼ˆå­å¾…è¾¦ï¼‰</label>
          <button type="button" class="btn btn-outline btn-sm" style="border-color:#0072B2;color:#0072B2" onclick="addSubtaskRow()">ï¼‹ æ–°å¢ç´°é …</button>
        </div>
        <div id="subtask-list"></div>
      </div>
      <div class="field"><label>å‚™è¨»</label><textarea id="td-note" rows="2">${t.note||''}</textarea></div>
    </div>
  `, function() {
    const title = document.getElementById('td-title').value.trim();
    if (!title) { alert('è«‹è¼¸å…¥å¾…è¾¦å…§å®¹ï¼'); return false; }
    t.title = title;
    t.dueDate = document.getElementById('td-due').value;
    t.remind = document.getElementById('td-remind').value;
    t.caseId = document.getElementById('td-case').value;
    t.note = document.getElementById('td-note').value;
    t.subtasks = collectSubtasks();
    saveData(db); return true;
  });
  // è¼‰å…¥æ—¢æœ‰ç´°é …
  setTimeout(function() {
    (t.subtasks||[]).forEach(function(s) { addSubtaskRow(s.title, s.dueDate); });
  }, 80);
}

function toggleTodo(id) {
  const t = db.todos.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  t.doneDate = t.done ? new Date().toISOString().slice(0,10) : null;
  saveData(db);
  render();
}

function toggleSubtask(todoId, idx) {
  const t = db.todos.find(x => x.id === todoId);
  if (!t || !t.subtasks || !t.subtasks[idx]) return;
  t.subtasks[idx].done = !t.subtasks[idx].done;
  saveData(db);
  render();
}

function copyTodo(id) {
  const t = db.todos.find(x => x.id === id);
  if (!t) return;
  db.todos.push({
    id: genTodoId(), title: t.title + 'ï¼ˆå‰¯æœ¬ï¼‰',
    dueDate: t.dueDate, remind: t.remind || '',
    caseId: t.caseId, note: t.note,
    subtasks: (t.subtasks||[]).map(s => ({ title: s.title, dueDate: s.dueDate, done: false })),
    done: false, doneDate: null,
    created: new Date().toISOString().slice(0,10)
  });
  saveData(db);
  render();
}

function deleteTodo(id) {
  if (!confirm('ç¢ºå®šåˆªé™¤é€™é …å¾…è¾¦ï¼Ÿ')) return;
  db.todos = db.todos.filter(t => t.id !== id);
  saveData(db);
  render();
}

// â”€â”€â”€ Todo Reminder Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playAlertSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const notes = [523.25, 659.25, 783.99, 1046.5]; // C5 E5 G5 C6
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.4);
      osc.start(ctx.currentTime + i * 0.15);
      osc.stop(ctx.currentTime + i * 0.15 + 0.4);
    });
    // å†ä¾†ä¸€è¼ª
    setTimeout(() => {
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 0.4);
        osc.start(ctx.currentTime + i * 0.15);
        osc.stop(ctx.currentTime + i * 0.15 + 0.4);
      });
    }, 1200);
  } catch(e) {}
}

function showReminderAlert(items, options = {}) {
  // options: { title, subtitle, color, buttonLabel, buttonAction }
  const title = options.title || 'æé†’é€šçŸ¥';
  const color = options.color || '#D55E00';
  const colorEnd = options.colorEnd || '#e87a30';
  const icon = options.icon || 'ğŸ””';

  document.getElementById('reminder-overlay')?.remove();

  const overlay = document.createElement('div');
  overlay.id = 'reminder-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s ease';

  const itemsHtml = items.map(t => {
    const borderColor = t._type === 'overdue' ? '#D55E00' : t._type === 'deadline' ? '#e8a020' : '#0072B2';
    return `<div style="padding:14px 18px;background:rgba(0,0,0,0.03);border-left:4px solid ${borderColor};border-radius:0 8px 8px 0;margin-bottom:10px">
      <div style="font-size:15px;font-weight:700">${t.title}</div>
      <div style="font-size:13px;color:#666;margin-top:4px">${t.subtitle || ''}</div>
    </div>`;
  }).join('');

  overlay.innerHTML = `
    <div style="background:#fff;border-radius:16px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;animation:slideUp 0.3s ease">
      <div style="background:linear-gradient(135deg,${color},${colorEnd});padding:28px 24px;text-align:center">
        <div style="font-size:48px;margin-bottom:8px">${icon}</div>
        <div style="font-size:22px;font-weight:700;color:#fff">${title}</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-top:4px">å…± ${items.length} é …éœ€è¦æ³¨æ„</div>
      </div>
      <div style="padding:20px 24px;max-height:300px;overflow-y:auto">${itemsHtml}</div>
      <div style="padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:center">
        <button onclick="document.getElementById('reminder-overlay').remove();navigate('deadlines')" style="padding:12px 28px;background:${color};color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer">æŸ¥çœ‹æœŸé™</button>
        <button onclick="document.getElementById('reminder-overlay').remove();navigate('todos')" style="padding:12px 28px;background:#0072B2;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer">æŸ¥çœ‹å¾…è¾¦</button>
        <button onclick="document.getElementById('reminder-overlay').remove()" style="padding:12px 28px;background:#f0f0f0;color:#333;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer">çŸ¥é“äº†</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  playAlertSound();
}

// â”€â”€â”€ çµ±ä¸€æé†’æª¢æŸ¥ï¼ˆå¾…è¾¦ + å€‹æ¡ˆæœŸé™ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _reminderShownToday = {};

function checkAllReminders() {
  const now = new Date();
  const today = now.toISOString().slice(0, 10);
  const alertItems = [];

  // 1) å¾…è¾¦äº‹é …æé†’
  if (db.todos) {
    db.todos.filter(t => !t.done).forEach(t => {
      // æé†’æ—¥æœŸåˆ°äº†
      if (t.remind && !t._notified && new Date(t.remind) <= now) {
        t._notified = true;
        alertItems.push({
          title: 'â° ' + t.title,
          subtitle: t.dueDate ? 'åˆ°æœŸï¼š' + fmtDate(t.dueDate) : 'å¾…è¾¦äº‹é …æé†’',
          _type: 'overdue'
        });
      }
      // åˆ°æœŸæ—¥ 14 å¤©å…§æˆ–å·²é€¾æœŸ
      if (t.dueDate) {
        const daysTodo = Math.ceil((new Date(t.dueDate) - now) / 86400000);
        const keyTodo = 'todo-due-' + t.id + '-' + today;
        if (daysTodo <= 14 && !_reminderShownToday[keyTodo]) {
          _reminderShownToday[keyTodo] = true;
          if (daysTodo < 0) {
            alertItems.push({
              title: 'ğŸš¨ å¾…è¾¦å·²é€¾æœŸï¼š' + t.title,
              subtitle: 'å·²é€¾æœŸ ' + Math.abs(daysTodo) + ' å¤©ï¼ˆ' + fmtDate(t.dueDate) + 'ï¼‰',
              _type: 'overdue'
            });
          } else {
            alertItems.push({
              title: 'ğŸ“‹ å¾…è¾¦å³å°‡åˆ°æœŸï¼š' + t.title,
              subtitle: 'é‚„å‰© ' + daysTodo + ' å¤©ï¼ˆ' + fmtDate(t.dueDate) + 'ï¼‰',
              _type: 'deadline'
            });
          }
        }
      }
      // å­ç´°é …åˆ°æœŸæ—¥ 7 å¤©å…§
      if (t.subtasks) {
        t.subtasks.filter(s => !s.done && s.dueDate).forEach((s,i) => {
          const daysSub = Math.ceil((new Date(s.dueDate) - now) / 86400000);
          const keySub = 'todo-sub-' + t.id + '-' + i + '-' + today;
          if (daysSub <= 7 && !_reminderShownToday[keySub]) {
            _reminderShownToday[keySub] = true;
            if (daysSub < 0) {
              alertItems.push({
                title: 'ğŸš¨ ç´°é …å·²é€¾æœŸï¼š' + s.title,
                subtitle: t.title + 'ãƒ»å·²é€¾æœŸ ' + Math.abs(daysSub) + ' å¤©',
                _type: 'overdue'
              });
            } else {
              alertItems.push({
                title: 'ğŸ“‹ ç´°é …å³å°‡åˆ°æœŸï¼š' + s.title,
                subtitle: t.title + 'ãƒ»é‚„å‰© ' + daysSub + ' å¤©',
                _type: 'deadline'
              });
            }
          }
        });
      }
    });
  }

  // 2) å€‹æ¡ˆæˆªæ­¢æ—¥æœŸ â€” 7å¤©å…§åˆ°æœŸæˆ–å·²é€¾æœŸ
  const activeTracks = db.tracks.filter(tr => {
    const c = db.cases.find(x => x.id === tr.caseId);
    return c && c.status !== 'å·²çµ¦ä»˜' && c.status !== 'å·²èª¿è§£å®Œæˆ' && c.status !== 'æ’¤æ¡ˆ';
  });

  activeTracks.forEach(tr => {
    const c = db.cases.find(x => x.id === tr.caseId);
    const cName = c ? c.name : tr.caseId;

    // æé†’æ—¥æœŸ â€” 45å¤©å…§æˆ–å·²é€¾æœŸ
    if (tr.deadline) {
      const days = Math.ceil((new Date(tr.deadline) - now) / 86400000);
      const key = 'deadline-' + tr.id + '-' + today;
      if (days <= 45 && !_reminderShownToday[key]) {
        _reminderShownToday[key] = true;
        if (days < 0) {
          alertItems.push({
            title: 'ğŸš¨ ' + cName + 'ï½œ' + tr.name,
            subtitle: 'æé†’æ—¥å·²é€¾æœŸ ' + Math.abs(days) + ' å¤©ï¼ˆ' + fmtDate(tr.deadline) + 'ï¼‰',
            _type: 'overdue'
          });
        } else {
          alertItems.push({
            title: 'ğŸ”” ' + cName + 'ï½œ' + tr.name,
            subtitle: 'æé†’æ—¥æœŸé‚„å‰© ' + days + ' å¤©ï¼ˆ' + fmtDate(tr.deadline) + 'ï¼‰',
            _type: 'deadline'
          });
        }
      }
    }

    // é è¨ˆå®Œæˆæ—¥ â€” 30å¤©å…§æˆ–å·²é€¾æœŸ
    if (tr.plannedDate) {
      const days2 = Math.ceil((new Date(tr.plannedDate) - now) / 86400000);
      const key2 = 'planned-' + tr.id + '-' + today;
      if (days2 <= 30 && !_reminderShownToday[key2]) {
        _reminderShownToday[key2] = true;
        if (days2 < 0) {
          alertItems.push({
            title: 'ğŸ“‹ ' + cName + 'ï½œ' + tr.name,
            subtitle: 'é è¨ˆå®Œæˆæ—¥å·²é€¾æœŸ ' + Math.abs(days2) + ' å¤©ï¼ˆ' + fmtDate(tr.plannedDate) + 'ï¼‰',
            _type: 'overdue'
          });
        } else {
          alertItems.push({
            title: 'ğŸ“‹ ' + cName + 'ï½œ' + tr.name,
            subtitle: 'é è¨ˆå®Œæˆæ—¥é‚„å‰© ' + days2 + ' å¤©ï¼ˆ' + fmtDate(tr.plannedDate) + 'ï¼‰',
            _type: 'deadline'
          });
        }
      }
    }
  });

  // é¡¯ç¤ºæé†’
  if (alertItems.length > 0) {
    showReminderAlert(alertItems, {
      title: 'æé†’é€šçŸ¥',
      icon: 'ğŸ””',
      color: '#D55E00',
      colorEnd: '#e87a30'
    });
    swNotify(alertItems.map(t => t.title).join('\n'));
  }
}
// è«‹æ±‚é€šçŸ¥æ¬Šé™
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}
setInterval(checkAllReminders, 30000);
setTimeout(checkAllReminders, 2000); // é–‹é é¢ 2 ç§’å¾Œå…ˆæª¢æŸ¥ä¸€æ¬¡

// â”€â”€â”€ PWA Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator && location.hostname.includes('github.io')) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    console.log('SW registered');
    // æ¥æ”¶ SW çš„è¨Šæ¯ï¼ˆé»é€šçŸ¥æ™‚è·³è½‰ï¼‰
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.type === 'OPEN_TODOS') {
        navigate('todos');
      }
    });
  }).catch(err => console.log('SW failed:', err));
}

// é€é SW ç™¼é€é€šçŸ¥ï¼ˆæ¯”ç›´æ¥ new Notification æ›´å¯é ï¼‰
function swNotify(body) {
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', body: body });
  } else if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('å¾…è¾¦æé†’', { body: body });
  }
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ¸…ç†å­¤ç«‹è³‡æ–™ï¼ˆå€‹æ¡ˆå·²åˆªé™¤ä½†é€²åº¦/è¿½è¹¤è»¸æ®˜ç•™ï¼‰
(function cleanOrphans() {
  const caseIds = new Set(db.cases.map(c => c.id));
  const before = db.progress.length + db.tracks.length;
  db.progress = db.progress.filter(p => caseIds.has(p.caseId));
  db.tracks = db.tracks.filter(t => caseIds.has(t.caseId));
  if (db.progress.length + db.tracks.length < before) saveData(db);
})();
render();
// é é¢è¼‰å…¥å¾Œè‡ªå‹•å¾ GitHub æ‹‰å–æœ€æ–°è³‡æ–™
setTimeout(ghAutoPull, 500);
</script>
</body>
</html>
