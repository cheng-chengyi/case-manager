<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å€‹æ¡ˆç®¡ç†ç³»çµ±ï½œå‹ä¿ãƒ»è·ç½ãƒ»å•†æ¥­ä¿éšªãƒ»å‹è³‡çˆ­è­°</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0f1f3d;
    --navy-2: #1a2f52;
    --navy-3: #243a63;
    --gold: #c9a84c;
    --gold-light: #e8c87a;
    --teal: #0EA5B0;
    --teal-light: #23a3a3;
    --bg: #f4f6fa;
    --surface: #ffffff;
    --surface-2: #f0f4f8;
    --border: #d4dce8;
    --text: #1a2236;
    --text-2: #4a5568;
    --text-3: #718096;
    --danger: #D55E00;
    --warning: #d69e2e;
    --success: #0072B2;
    --info: #2b6cb0;
    --shadow: 0 2px 12px rgba(15,31,61,0.08);
    --shadow-lg: 0 8px 32px rgba(15,31,61,0.14);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* Layout */
  .app { display: flex; height: 100vh; overflow: hidden; }
  .sidebar { width: 240px; background: var(--surface); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; border-right: 1px solid var(--border); }
  .main { flex: 1; overflow-y: auto; }
  
  /* Sidebar */
  .sidebar-logo { padding: 24px 20px 20px; border-bottom: 1px solid var(--border); }
  .sidebar-logo h1 { font-family: 'Playfair Display', serif; color: var(--navy); font-size: 16px; line-height: 1.4; }
  .sidebar-logo p { color: var(--text-3); font-size: 11px; margin-top: 4px; }
  .nav-section { padding: 16px 12px 8px; }
  .nav-label { color: var(--text-3); font-size: 10px; font-weight: 600; letter-spacing: 1.2px; text-transform: uppercase; padding: 0 8px; margin-bottom: 6px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px; cursor: pointer; color: var(--text-2); font-size: 13.5px; transition: all 0.18s; margin-bottom: 2px; }
  .nav-item:hover { background: var(--surface-2); color: var(--navy); }
  .nav-item.active { background: rgba(0,114,178,0.12); color: #0072B2; font-weight: 600; border-left: 3px solid #0072B2; padding-left: 7px; }
  .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }
  .sidebar-footer { margin-top: auto; padding: 16px; border-top: 1px solid var(--border); }
  .sidebar-footer p { color: var(--text-3); font-size: 10px; text-align: center; }

  /* Top bar */
  .topbar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 28px; height: 56px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 10; }
  .topbar-title { font-size: 15px; font-weight: 600; color: var(--navy); }
  .topbar-actions { display: flex; gap: 10px; align-items: center; }
  .btn { padding: 7px 16px; border-radius: 7px; font-size: 13px; font-family: inherit; cursor: pointer; border: none; font-weight: 500; transition: all 0.18s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover { background: var(--navy-2); }
  .btn-gold { background: var(--gold); color: var(--navy); font-weight: 600; }
  .btn-gold:hover { background: var(--gold-light); }
  .btn-outline { background: transparent; color: var(--text-2); border: 1px solid var(--border); }
  .btn-outline:hover { border-color: var(--navy); color: var(--navy); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-sm { padding: 5px 12px; font-size: 12px; }
  .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 6px; justify-content: center; }

  /* Content area */
  .content { padding: 24px 28px; }

  /* Stats cards */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stat-card.all::before { background: var(--navy); }
  .stat-card.active::before { background: var(--success); }
  .stat-card.pending::before { background: var(--warning); }
  .stat-card.closed::before { background: var(--text-3); }
  .stat-label { font-size: 12px; color: var(--text-3); font-weight: 500; margin-bottom: 8px; }
  .stat-num { font-size: 32px; font-weight: 700; color: var(--navy); line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--text-3); margin-top: 6px; }
  .stat-icon { position: absolute; right: 16px; top: 16px; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
  .stat-card.all .stat-icon { background: rgba(15,31,61,0.08); }
  .stat-card.active .stat-icon { background: rgba(0,114,178,0.1); }
  .stat-card.pending .stat-icon { background: rgba(214,158,46,0.1); }
  .stat-card.closed .stat-icon { background: rgba(113,128,150,0.1); }

  /* Type badges */
  .type-chips { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 24px; }
  .type-chip { background: var(--surface); border-radius: 10px; padding: 14px 16px; border: 1px solid var(--border); cursor: pointer; transition: all 0.18s; }
  .type-chip:hover { border-color: var(--navy); transform: translateY(-1px); }
  .type-chip.selected { border-color: var(--gold); background: rgba(201,168,76,0.06); }
  .type-chip-label { font-size: 12px; color: var(--text-3); margin-bottom: 4px; }
  .type-chip-count { font-size: 24px; font-weight: 700; }
  .type-chip.labor .type-chip-count { color: #2b6cb0; }
  .type-chip.injury-ins .type-chip-count { color: #D55E00; }
  .type-chip.farmer .type-chip-count { color: #0072B2; }
  .type-chip.civil .type-chip-count { color: #0EA5B0; }
  .type-chip.injury .type-chip-count { color: #dd6b20; }
  .type-chip.commercial .type-chip-count { color: #6b46c1; }
  .type-chip.dispute .type-chip-count { color: #4a5568; }

  /* Table */
  .table-card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
  .table-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .search-box { display: flex; align-items: center; gap: 8px; background: var(--surface-2); border: 1px solid var(--border); border-radius: 8px; padding: 7px 12px; flex: 1; max-width: 300px; }
  .search-box input { border: none; background: transparent; font-family: inherit; font-size: 13px; color: var(--text); outline: none; width: 100%; }
  .search-box input::placeholder { color: var(--text-3); }
  table { width: 100%; border-collapse: collapse; }
  th { background: var(--surface-2); color: var(--text-3); font-size: 11px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; padding: 10px 16px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 13px 16px; font-size: 13px; color: var(--text); border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(15,31,61,0.025); cursor: pointer; }
  
  /* Badges */
  .badge { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-blue { background: rgba(43,108,176,0.12); color: #2b6cb0; }
  .badge-red { background: rgba(213,94,0,0.12); color: #D55E00; }
  .badge-purple { background: rgba(107,70,193,0.12); color: #6b46c1; }
  .badge-green { background: rgba(0,114,178,0.12); color: #0072B2; }
  .badge-yellow { background: rgba(214,158,46,0.12); color: #b7791f; }
  .badge-gray { background: rgba(113,128,150,0.12); color: #4a5568; }
  .badge-teal { background: rgba(14,165,176,0.12); color: #0EA5B0; }
  .badge-orange { background: rgba(221,107,32,0.12); color: #dd6b20; }
  
  /* Status pill */
  .status-active { background: rgba(0,114,178,0.12); color: #0072B2; }
  .status-pending { background: rgba(214,158,46,0.15); color: #b7791f; }
  .status-review { background: rgba(43,108,176,0.12); color: #2b6cb0; }
  .status-mediation { background: rgba(14,165,176,0.12); color: #0EA5B0; }
  .status-lawsuit { background: rgba(213,94,0,0.12); color: #D55E00; }
  .status-closed { background: rgba(113,128,150,0.12); color: #4a5568; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(15,31,61,0.45); backdrop-filter: blur(2px); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
  .modal { background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-lg); width: 100%; max-width: 680px; max-height: 90vh; overflow-y: auto; }
  .modal-head { padding: 22px 24px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--surface); z-index: 1; }
  .modal-head h2 { font-size: 17px; font-weight: 700; color: var(--navy); }
  .modal-body { padding: 22px 24px; }
  .modal-foot { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  .form-full { grid-column: 1/-1; }
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field label { font-size: 12px; font-weight: 600; color: var(--text-2); }
  .field input, .field select, .field textarea { padding: 9px 12px; border: 1px solid var(--border); border-radius: 7px; font-family: inherit; font-size: 13px; color: var(--text); background: var(--surface); outline: none; transition: border 0.18s; }
  .field input:focus, .field select:focus, .field textarea:focus { border-color: var(--navy); box-shadow: 0 0 0 3px rgba(15,31,61,0.08); }
  .field textarea { resize: vertical; min-height: 80px; }
  .section-divider { margin: 18px 0 14px; padding-bottom: 8px; border-bottom: 2px solid var(--border); font-size: 12px; font-weight: 700; color: var(--navy); letter-spacing: 0.5px; text-transform: uppercase; }

  /* Detail view */
  .detail-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
  .detail-main {}
  .detail-aside {}
  .card { background: var(--surface); border-radius: 12px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px; }
  .card-head { padding: 14px 18px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; color: var(--navy); display: flex; align-items: center; justify-content: space-between; }
  .card-body { padding: 16px 18px; }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .info-item label { font-size: 11px; color: var(--text-3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.4px; }
  .info-item value, .info-item .val { display: block; font-size: 13px; color: var(--text); margin-top: 3px; font-weight: 500; }
  
  /* Timeline */
  .timeline { list-style: none; padding-left: 0; }
  .timeline li { position: relative; padding: 0 0 20px 32px; }
  .timeline li::before { content: ''; position: absolute; left: 10px; top: 20px; bottom: 0; width: 1px; background: var(--border); }
  .timeline li:last-child::before { display: none; }
  .timeline-dot { position: absolute; left: 4px; top: 4px; width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--navy); background: var(--surface); }
  .timeline-dot.done { background: var(--success); border-color: var(--success); }
  .timeline-dot.active { background: var(--gold); border-color: var(--gold); }
  .timeline-date { font-size: 11px; color: var(--text-3); font-weight: 500; }
  .timeline-stage { font-size: 12px; font-weight: 700; color: var(--navy); margin: 2px 0; }
  .timeline-desc { font-size: 12px; color: var(--text-2); }
  .timeline-next { font-size: 11px; color: var(--teal); margin-top: 4px; }

  /* Deadline alert */
  .deadline-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-radius: 8px; margin-bottom: 8px; border: 1px solid; }
  .deadline-urgent { background: rgba(213,94,0,0.06); border-color: rgba(213,94,0,0.25); }
  .deadline-soon { background: rgba(214,158,46,0.06); border-color: rgba(214,158,46,0.25); }
  .deadline-ok { background: rgba(0,114,178,0.06); border-color: rgba(0,114,178,0.2); }
  .deadline-label { font-size: 12px; font-weight: 600; }
  .deadline-days { font-size: 12px; font-weight: 700; padding: 2px 10px; border-radius: 12px; }
  .days-urgent { background: rgba(213,94,0,0.15); color: #D55E00; }
  .days-soon { background: rgba(214,158,46,0.15); color: #b7791f; }
  .days-ok { background: rgba(0,114,178,0.12); color: #0072B2; }

  /* Empty state */
  .empty { text-align: center; padding: 60px 20px; color: var(--text-3); }
  .empty svg { width: 48px; height: 48px; margin: 0 auto 12px; opacity: 0.3; }
  .empty p { font-size: 14px; }

  /* Progress bar */
  .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 6px; }
  .progress-fill { height: 100%; border-radius: 3px; background: var(--gold); }

  /* Amount */
  .amount { font-family: 'Playfair Display', serif; }

  /* Tabs */
  .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; gap: 0; }
  .tab { padding: 10px 18px; font-size: 13px; font-weight: 500; color: var(--text-3); cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.18s; }
  .tab:hover { color: var(--navy); }
  .tab.active { color: var(--navy); border-bottom-color: var(--gold); font-weight: 700; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  
  /* Misc */
  .text-muted { color: var(--text-3); font-size: 12px; }
  .divider { height: 1px; background: var(--border); margin: 16px 0; }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; background: var(--surface-2); color: var(--text-2); border: 1px solid var(--border); margin: 2px; }

  @media (max-width: 1100px) {
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .type-chips { grid-template-columns: repeat(2,1fr); }
    .detail-grid { grid-template-columns: 1fr; }
  }

  /* â”€â”€â”€ Mobile â”€â”€â”€ */
  .mobile-menu-btn { display: none; background: none; border: none; cursor: pointer; padding: 6px; color: var(--navy); }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 49; }

  @media (max-width: 768px) {
    html { font-size: 18px; }
    .app { flex-direction: column; }
    .sidebar {
      position: fixed; left: -260px; top: 0; bottom: 0; width: 250px; z-index: 50;
      transition: left 0.25s ease; box-shadow: none;
    }
    .sidebar.open { left: 0; box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
    .sidebar-overlay.open { display: block; }
    .mobile-menu-btn { display: block; }
    .main { width: 100%; }
    .topbar { padding: 0 14px; height: 50px; zoom: 1.35; }
    .topbar-title { font-size: 18px; }
    .content { padding: 14px; font-size: 16px; zoom: 1.35; }
    .modal-overlay { padding: 10px; zoom: 1.35; }
    .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
    .type-chips { grid-template-columns: 1fr; }
    .stat-card { padding: 14px; }
    .stat-card .num { font-size: 28px; }
    .stat-card .label { font-size: 14px; }
    .form-grid { grid-template-columns: 1fr; }
    .form-grid.cols-3 { grid-template-columns: 1fr; }
    .info-grid { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr; }
    .content > div[style*="grid-template-columns"] { display: block !important; }
    .content > div[style*="grid-template-columns"] > div { margin-bottom: 16px; }
    .content [style*="grid-template-columns:1fr 3"],
    .content [style*="grid-template-columns:1fr 2"] { display: block !important; }
    .content [style*="grid-template-columns:1fr 3"] > div,
    .content [style*="grid-template-columns:1fr 2"] > div { margin-bottom: 16px; }
    .card-body [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
    .card-body [style*="grid-template-columns:repeat(3"] { grid-template-columns: 1fr !important; }
    .table-card { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { min-width: 700px; }
    table th, table td { font-size: 15px; padding: 10px 12px; }
    .modal { max-width: 100%; margin: 10px; border-radius: 12px; }
    .modal-head { padding: 16px; }
    .modal-head h2 { font-size: 19px; }
    .modal-body { padding: 16px; font-size: 16px; }
    .modal-foot { padding: 12px 16px; }
    .card-head { font-size: 16px; }
    .card-body { padding: 14px 16px; font-size: 15px; }
    .field label { font-size: 15px; }
    .field input, .field select, .field textarea { font-size: 16px; }
    .btn { font-size: 15px; padding: 10px 18px; }
    .badge { font-size: 13px; }
    .nav-item { font-size: 16px; padding: 12px 10px; }
  }

  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr; }
    .topbar-actions { gap: 6px; }
    .topbar-actions .btn { font-size: 14px; padding: 8px 12px; }
  }
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Mobile sidebar overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <h1>å€‹æ¡ˆç®¡ç†ç³»çµ±</h1>
      <p>å‹ä¿ãƒ»è·ç½ãƒ»å•†æ¥­ä¿éšªãƒ»å‹è³‡çˆ­è­°</p>
      <div id="sidebar-date" style="color:var(--text-2);font-size:12px;margin-top:8px;font-weight:500"></div>
    </div>
    <div class="nav-section">
      <div class="nav-label">ä¸»è¦åŠŸèƒ½</div>
      <div class="nav-item active" onclick="navigate('dashboard')" id="nav-dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        å€‹æ¡ˆç¸½è¦½
      </div>
      <div class="nav-item" onclick="navigate('cases')" id="nav-cases">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        å€‹æ¡ˆæ¸…å–®
      </div>
      <div class="nav-item" onclick="navigate('progress')" id="nav-progress">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        é€²åº¦è¿½è¹¤
      </div>
      <div class="nav-item" onclick="navigate('deadlines')" id="nav-deadlines">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        æœŸé™ç®¡ç†
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-label">è³‡æ–™ç®¡ç†</div>
      <div class="nav-item" onclick="navigate('archive')" id="nav-archive">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
        æ­¸æª”èˆ‡å‚™ä»½
      </div>
    </div>
    <div class="sidebar-footer">
      <p>è³‡æ–™å„²å­˜æ–¼æœ¬æ©Ÿ Â· éš±ç§å®‰å…¨</p>
    </div>
  </nav>

  <!-- Main -->
  <div class="main" id="main-content">
    <!-- Content renders here via JS -->
  </div>

</div>

<script>
// â”€â”€â”€ Data Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = 'case_mgmt_v4';

const defaultCases = [
  { id:'A001', type:'å‹å·¥ä¿éšªçµ¦ä»˜', name:'ç‹å°æ˜', idNum:'A123456789', phone:'0912-345-678',
    employer:'å°ç£è£½é€ è‚¡ä»½æœ‰é™å…¬å¸', insurer:'å‹å‹•éƒ¨å‹å·¥ä¿éšªå±€', wage: 45800, accidentDate:'2025-10-15', status:'é€²è¡Œä¸­',
    receiveDate:'2025-11-01', handler:'é™³é¡§å•', deadline:'2026-02-28', deadlineNote:'å‹ä¿å±€è£œä»¶æ³•å®šæˆªæ­¢',
    plannedDate:'2026-02-10', plannedDateNote:'é è¨ˆå‚™é½Šæ‰€æœ‰æ–‡ä»¶é€å‡º',
    amount:350000, note:'éœ€è£œå°±é†«è­‰æ˜ï¼Œå·²å‘å‹ä¿å±€ç¢ºèªæ”¶ä»¶è™Ÿç¢¼ 123456789', created:'2025-11-01', updated:'2026-01-10' },
  { id:'A002', type:'è·ç½è£œå„Ÿçˆ­è­°', name:'æå¤§è¯', idNum:'B234567890', phone:'0923-456-789',
    employer:'å»ºè¨­å·¥ç¨‹æœ‰é™å…¬å¸', insurer:'å‹å‹•éƒ¨å‹å·¥ä¿éšªå±€', wage: 52000, accidentDate:'2025-08-20', status:'å¯©æ ¸ä¸­',
    receiveDate:'2025-09-05', handler:'æ—é¡§å•', deadline:'2026-03-15', deadlineNote:'å‹å‹•å±€èª¿è§£æˆªæ­¢',
    plannedDate:'2026-03-01', plannedDateNote:'é è¨ˆæº–å‚™å¥½èª¿è§£æ–‡ä»¶',
    amount:550000, note:'é›‡ä¸»å¦èªè·ç½ï¼Œå·²å‘å‹å‹•å±€ç”³è«‹è·ç½èªå®š', created:'2025-09-05', updated:'2026-01-15' },
  { id:'A003', type:'å•†æ¥­ä¿éšªç†è³ ', name:'å¼µç¾ç²', idNum:'C345678901', phone:'0934-567-890',
    employer:'å€‹äººï¼ˆæœå‹™æ¥­ï¼‰', insurer:'å¯Œé‚¦äººå£½', wage: 35000, accidentDate:'2025-11-30', status:'å¾…è£œä»¶',
    receiveDate:'2025-12-10', handler:'é™³é¡§å•', deadline:'2026-02-20', deadlineNote:'ä¿éšªå…¬å¸è£œä»¶æ³•å®šæˆªæ­¢',
    plannedDate:'2026-02-10', plannedDateNote:'é è¨ˆå–å¾—è¨ºæ–·æ›¸ä¸¦è£œä»¶',
    amount:180000, note:'ä¿éšªå…¬å¸æ‹’è³ ï¼Œè¦æ±‚è£œè¨ºæ–·æ›¸', created:'2025-12-10', updated:'2026-01-20' },
  { id:'A004', type:'å‹è³‡çˆ­è­°/è¨´è¨Ÿ', name:'é™³å»ºåœ‹', idNum:'D456789012', phone:'0945-678-901',
    employer:'ç§‘æŠ€å…¬å¸', insurer:'å‹å‹•éƒ¨å‹å·¥ä¿éšªå±€', wage: 65000, accidentDate:'2025-07-01', status:'è¨´è¨Ÿä¸­',
    receiveDate:'2025-08-01', handler:'ç‹é¡§å•', deadline:'2026-04-10', deadlineNote:'æ³•é™¢é–‹åº­ï¼ˆä¸å¯æ›´å‹•ï¼‰',
    plannedDate:'2026-03-25', plannedDateNote:'é è¨ˆå‚™å¥½ç­”è¾¯ç‹€é€æ³•é™¢',
    amount:450000, note:'è³‡é£è²»çˆ­è­°ï¼Œå°å—åœ°é™¢ç¬¬äºŒæ¬¡åº­', created:'2025-08-01', updated:'2026-01-18' },
  { id:'A005', type:'å‹å·¥ä¿éšªçµ¦ä»˜', name:'æ—æ·‘èŠ¬', idNum:'E567890123', phone:'0956-789-012',
    employer:'ç™¾è²¨é›¶å”®æœ‰é™å…¬å¸', insurer:'å‹å‹•éƒ¨å‹å·¥ä¿éšªå±€', wage: 28000, accidentDate:'2024-06-15', status:'å·²çµæ¡ˆ',
    receiveDate:'2024-07-01', handler:'é™³é¡§å•', deadline:'', deadlineNote:'',
    plannedDate:'', plannedDateNote:'',
    amount:210000, note:'è€å¹´çµ¦ä»˜å·²æ ¸å®šï¼Œæ¡ˆä»¶çµæ¡ˆ', created:'2024-07-01', updated:'2025-03-15' },
];

// è¿½è¹¤è»¸ï¼šæ¯å€‹æ¡ˆä»¶å¯æœ‰å¤šæ¢ä¸¦è¡Œè¿½è¹¤è»¸
const defaultTracks = [
  { id:'TR-A001-1', caseId:'A001', name:'å‹å·¥ä¿éšªå‚·ç—…çµ¦ä»˜', type:'å‹å·¥ä¿éšªçµ¦ä»˜', status:'é€²è¡Œä¸­',
    deadline:'2026-02-28', deadlineNote:'å‹ä¿å±€è£œä»¶æˆªæ­¢', plannedDate:'2026-02-10', plannedDateNote:'é è¨ˆå‚™é½Šæ–‡ä»¶', amount:150000, note:'' },
  { id:'TR-A001-2', caseId:'A001', name:'è·ç½é†«ç™‚çµ¦ä»˜', type:'è·ç½ä¿éšªçµ¦ä»˜', status:'é€²è¡Œä¸­',
    deadline:'', deadlineNote:'', plannedDate:'2026-03-01', plannedDateNote:'é è¨ˆç”³è«‹å®Œæˆ', amount:80000, note:'åŒæ­¥ç”³è«‹è·ç½ä¿éšª' },
  { id:'TR-A001-3', caseId:'A001', name:'é›‡ä¸»è·ç½è£œå„Ÿ', type:'è·ç½è£œå„Ÿçˆ­è­°', status:'é€²è¡Œä¸­',
    deadline:'', deadlineNote:'', plannedDate:'2026-04-01', plannedDateNote:'å”å•†ç›®æ¨™', amount:120000, note:'å¦å‘é›‡ä¸»æ±‚å„Ÿå·®é¡' },
  { id:'TR-A002-1', caseId:'A002', name:'è·ç½èªå®šç”³è«‹', type:'è·ç½ä¿éšªçµ¦ä»˜', status:'å¯©æ ¸ä¸­',
    deadline:'2026-03-15', deadlineNote:'å‹å‹•å±€èª¿è§£æˆªæ­¢', plannedDate:'2026-03-01', plannedDateNote:'æº–å‚™èª¿è§£æ–‡ä»¶', amount:350000, note:'' },
  { id:'TR-A002-2', caseId:'A002', name:'é›‡ä¸»è£œå„Ÿçˆ­è­°', type:'è·ç½è£œå„Ÿçˆ­è­°', status:'èª¿è§£ä¸­',
    deadline:'', deadlineNote:'', plannedDate:'2026-04-01', plannedDateNote:'å”å•†æœŸé™', amount:200000, note:'èª¿è§£ä¸æˆå°‡æè¨´è¨Ÿ' },
  { id:'TR-A003-1', caseId:'A003', name:'å•†æ¥­ä¿éšªç†è³ ', type:'å•†æ¥­ä¿éšªç†è³ ', status:'å¾…è£œä»¶',
    deadline:'2026-02-20', deadlineNote:'ä¿éšªå…¬å¸è£œä»¶æˆªæ­¢', plannedDate:'2026-02-10', plannedDateNote:'å–å¾—è¨ºæ–·æ›¸', amount:180000, note:'' },
  { id:'TR-A004-1', caseId:'A004', name:'è³‡é£è²»è¨´è¨Ÿ', type:'å‹è³‡çˆ­è­°/è¨´è¨Ÿ', status:'è¨´è¨Ÿä¸­',
    deadline:'2026-04-10', deadlineNote:'æ³•é™¢é–‹åº­', plannedDate:'2026-03-25', plannedDateNote:'å‚™å¥½ç­”è¾¯ç‹€', amount:450000, note:'' },
  { id:'TR-A005-1', caseId:'A005', name:'è€å¹´çµ¦ä»˜ç”³è«‹', type:'å‹å·¥ä¿éšªçµ¦ä»˜', status:'å·²çµæ¡ˆ',
    deadline:'', deadlineNote:'', plannedDate:'', plannedDateNote:'', amount:210000, note:'å·²æ ¸å®šçµæ¡ˆ' },
];

const defaultProgress = [
  { caseId:'A001', trackId:'TR-A001-1', date:'2025-11-01', stage:'æ”¶æ¡ˆ', desc:'æ”¶åˆ°å§”è¨—ï¼Œå–å¾—æˆæ¬Šæ›¸åŠèº«åˆ†è­‰ä»¶', sendRecv:'æ”¶ä»¶', handler:'é™³é¡§å•', nextStep:'æ•´ç†ç—…æ­·è³‡æ–™', nextDate:'2025-11-15', note:'' },
  { caseId:'A001', trackId:'TR-A001-1', date:'2025-11-20', stage:'è£œä»¶', desc:'è‡³å°å—é†«é™¢ç”³è«‹è¨ºæ–·è­‰æ˜æ›¸åŠç—…æ­·', sendRecv:'', handler:'é™³é¡§å•', nextStep:'æº–å‚™ç”³è«‹æ›¸', nextDate:'2025-12-05', note:'' },
  { caseId:'A001', trackId:'TR-A001-1', date:'2025-12-10', stage:'é€ä»¶', desc:'å‘å‹ä¿å±€é€ä»¶ç”³è«‹å‚·ç—…çµ¦ä»˜ï¼Œæ›è™Ÿ123456789', sendRecv:'é€ä»¶', handler:'é™³é¡§å•', nextStep:'ç­‰å¾…å¯©æŸ¥', nextDate:'2026-02-10', note:'å·²è£œè¶³æ‰€æœ‰æ–‡ä»¶' },
  { caseId:'A001', trackId:'TR-A001-2', date:'2025-11-05', stage:'æ”¶æ¡ˆ', desc:'åŒæ­¥ç”³è«‹è·ç½ä¿éšªé†«ç™‚çµ¦ä»˜', sendRecv:'æ”¶ä»¶', handler:'é™³é¡§å•', nextStep:'å‚™å¦¥é†«ç™‚è²»ç”¨å–®æ“š', nextDate:'2025-12-01', note:'' },
  { caseId:'A001', trackId:'TR-A001-2', date:'2026-01-10', stage:'é€ä»¶', desc:'é€ä»¶ç”³è«‹è·ç½é†«ç™‚çµ¦ä»˜', sendRecv:'é€ä»¶', handler:'é™³é¡§å•', nextStep:'ç­‰å¾…å¯©æŸ¥', nextDate:'2026-03-01', note:'' },
  { caseId:'A001', trackId:'TR-A001-3', date:'2026-01-15', stage:'æ”¶æ¡ˆ', desc:'å‘é›‡ä¸»ä¸»å¼µè·ç½è£œå„Ÿå·®é¡è²¬ä»»', sendRecv:'', handler:'é™³é¡§å•', nextStep:'è¨ˆç®—å·®é¡é‡‘é¡', nextDate:'2026-02-01', note:'å‹åŸºæ³•ç¬¬59æ¢' },
  { caseId:'A002', trackId:'TR-A002-1', date:'2025-09-05', stage:'æ”¶æ¡ˆ', desc:'è·ç½äº‹æ•…ï¼Œå…¬å¸å¦èªè·ç½ï¼Œæ”¶å–å§”ä»»ç‹€åŠç›¸é—œæ–‡ä»¶', sendRecv:'æ”¶ä»¶', handler:'æ—é¡§å•', nextStep:'è’é›†ç¾å ´è­‰æ“š', nextDate:'2025-09-20', note:'' },
  { caseId:'A002', trackId:'TR-A002-1', date:'2025-10-15', stage:'é€ä»¶', desc:'å‘å‹å‹•å±€ç”³è«‹è·ç½èªå®š', sendRecv:'é€ä»¶', handler:'æ—é¡§å•', nextStep:'ç­‰å¾…èª¿æŸ¥', nextDate:'2025-11-15', note:'' },
  { caseId:'A002', trackId:'TR-A002-1', date:'2025-11-20', stage:'å”å•†/èª¿è§£', desc:'å‹å‹•å±€å®‰æ’èª¿è§£ï¼Œè³‡æ–¹æœªå’Œè§£', sendRecv:'', handler:'æ—é¡§å•', nextStep:'å†æ¬¡èª¿è§£', nextDate:'2026-03-15', note:'è³‡æ–¹æ…‹åº¦å¼·ç¡¬' },
  { caseId:'A002', trackId:'TR-A002-2', date:'2025-10-01', stage:'æ”¶æ¡ˆ', desc:'å‘é›‡ä¸»ä¸»å¼µè·ç½è£œå„Ÿè²¬ä»»', sendRecv:'', handler:'æ—é¡§å•', nextStep:'å¯„å­˜è­‰ä¿¡å‡½', nextDate:'2025-10-20', note:'' },
  { caseId:'A002', trackId:'TR-A002-2', date:'2025-11-01', stage:'å”å•†/èª¿è§£', desc:'ç¬¬ä¸€æ¬¡å”å•†ï¼Œé›‡ä¸»æå‡ºå’Œè§£æ–¹æ¡ˆä¸æ¥å—', sendRecv:'', handler:'æ—é¡§å•', nextStep:'çºŒè¡Œèª¿è§£', nextDate:'2026-04-01', note:'å°æ–¹å‡ºåƒ¹éä½' },
  { caseId:'A003', trackId:'TR-A003-1', date:'2025-12-10', stage:'æ”¶æ¡ˆ', desc:'å•†æ¥­ä¿éšªæ‹’è³ ï¼Œå§”è¨—ç”³è¨´', sendRecv:'æ”¶ä»¶', handler:'é™³é¡§å•', nextStep:'æ•´ç†ç†è³ è³‡æ–™', nextDate:'2025-12-20', note:'' },
  { caseId:'A003', trackId:'TR-A003-1', date:'2026-01-05', stage:'è£œä»¶', desc:'ä¿éšªå…¬å¸è¦æ±‚è£œè¨ºæ–·æ›¸', sendRecv:'', handler:'é™³é¡§å•', nextStep:'è£œé€è¨ºæ–·æ›¸', nextDate:'2026-02-20', note:'æˆªæ­¢æ—¥ï¼š2/20ï¼Œéœ€åŠ å¿«' },
  { caseId:'A004', trackId:'TR-A004-1', date:'2025-08-01', stage:'æ”¶æ¡ˆ', desc:'è³‡é£è²»çˆ­è­°ï¼Œæèµ·è¨´è¨Ÿ', sendRecv:'æ”¶ä»¶', handler:'ç‹é¡§å•', nextStep:'æ’°å¯«èµ·è¨´ç‹€', nextDate:'2025-09-01', note:'' },
  { caseId:'A004', trackId:'TR-A004-1', date:'2025-10-05', stage:'è¨´è¨Ÿ', desc:'ç¬¬ä¸€æ¬¡é–‹åº­ï¼Œæ³•å®˜è¦æ±‚è£œå……ç­”è¾¯', sendRecv:'', handler:'ç‹é¡§å•', nextStep:'æº–å‚™ç­”è¾¯ç‹€', nextDate:'2026-04-10', note:'å°å—åœ°é™¢ æ°‘äº‹åº­' },
];

function loadData() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (s) return JSON.parse(s);
  } catch(e) {}
  return { cases: defaultCases, tracks: defaultTracks, progress: defaultProgress };
}
function saveData(data) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
}
let db = loadData();
if (!db.cases) db.cases = defaultCases;
if (!db.tracks) db.tracks = defaultTracks;
if (!db.progress) db.progress = defaultProgress;
var _pid = 1;
db.progress.forEach(function(p){ if (!p.id) p.id = 'P' + String(_pid++).padStart(4,'0'); });
function genProgressId() {
  var nums = db.progress.map(function(p){ return parseInt((p.id||'').slice(1))||0; });
  return 'P' + String((nums.length ? Math.max.apply(null,nums) : 0) + 1).padStart(4,'0');
}
function genTrackId(caseId) {
  const prefix = 'TR-' + caseId + '-';
  const nums = db.tracks.filter(t => t.id.startsWith(prefix)).map(t => parseInt(t.id.slice(prefix.length))||0);
  const max = nums.length ? Math.max(...nums) : 0;
  return prefix + (max + 1);
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const typeColor = {
  'å‹å·¥ä¿éšªçµ¦ä»˜':'badge-blue','è·ç½ä¿éšªçµ¦ä»˜':'badge-red','è¾²æ°‘ä¿éšªçµ¦ä»˜':'badge-green','å…¬æ•™ä¿éšªçµ¦ä»˜':'badge-teal',
  'è·ç½è£œå„Ÿçˆ­è­°':'badge-orange','å•†æ¥­ä¿éšªç†è³ ':'badge-purple','å‹è³‡çˆ­è­°/è¨´è¨Ÿ':'badge-gray',
  'å‹ä¿ç”Ÿè‚²çµ¦ä»˜':'badge-blue','å‹ä¿å‚·ç—…çµ¦ä»˜':'badge-blue','å‹ä¿å¤±èƒ½çµ¦ä»˜':'badge-blue','å‹ä¿è€å¹´çµ¦ä»˜':'badge-blue','å‹ä¿æ­»äº¡çµ¦ä»˜':'badge-blue',
  'è·ä¿é†«ç™‚çµ¦ä»˜':'badge-red','è·ä¿å‚·ç—…çµ¦ä»˜':'badge-red','è·ä¿å¤±èƒ½çµ¦ä»˜':'badge-red','è·ä¿æ­»äº¡çµ¦ä»˜':'badge-red',
  'çˆ­è­°å¯©è­°è¨´é¡˜':'badge-gray','è·ç½è£œå„Ÿè³ å„Ÿ':'badge-orange','å‹è³‡çˆ­è­°äº‹é …':'badge-gray',
  'å£½éšª':'badge-purple','é†«ç™‚éšª':'badge-purple','æ„å¤–éšª':'badge-purple','å¤±èƒ½éšª':'badge-purple','é•·ç…§éšª':'badge-purple'
};
const statusColor = {
  'é€²è¡Œä¸­': 'status-active', 'å¾…è£œä»¶': 'status-pending', 'å¯©æ ¸ä¸­': 'status-review',
  'èª¿è§£ä¸­': 'status-mediation', 'è¨´è¨Ÿä¸­': 'status-lawsuit', 'å·²çµæ¡ˆ': 'status-closed', 'æ’¤æ¡ˆ': 'status-closed'
};
const stageColor = {
  'æ”¶æ¡ˆ': 'badge-blue', 'è£œä»¶': 'badge-yellow', 'é€ä»¶': 'badge-teal',
  'æ©Ÿé—œå¯©æŸ¥': 'badge-orange', 'å”å•†/èª¿è§£': 'badge-teal', 'è¨´è¨Ÿ': 'badge-red',
  'æ ¸å®š/åˆ¤æ±º': 'badge-green', 'çµ¦ä»˜/çµæ¡ˆ': 'badge-gray', 'æ’¤æ¡ˆ': 'badge-gray'
};
function fmt(n) { return n ? parseInt(n).toLocaleString('zh-TW') : '-'; }
function fmtDate(d) {
  if (!d) return '-';
  const parts = d.split('-');
  if (parts.length !== 3) return d;
  const roc = parseInt(parts[0]) - 1911;
  return roc + 'å¹´' + parts[1] + 'æœˆ' + parts[2] + 'æ—¥';
}
function rocHint(inputId) {
  const el = document.getElementById(inputId);
  if (!el || !el.value) return '';
  return fmtDate(el.value);
}
function daysUntil(d) {
  if (!d) return null;
  const diff = Math.ceil((new Date(d) - new Date()) / 86400000);
  return diff;
}
function daysBadge(days) {
  if (days === null) return '';
  if (days < 0) return `<span class="badge badge-red">å·²é€¾æœŸ ${Math.abs(days)} å¤©</span>`;
  if (days <= 14) return `<span class="days-urgent deadline-days">${days} å¤©å¾Œ</span>`;
  if (days <= 30) return `<span class="days-soon deadline-days">${days} å¤©å¾Œ</span>`;
  return `<span class="days-ok deadline-days">${days} å¤©å¾Œ</span>`;
}
function genId() {
  const ids = db.cases.map(c => c.id).filter(id => /^A\d+$/.test(id)).map(id => parseInt(id.slice(1)));
  const max = ids.length ? Math.max(...ids) : 0;
  return 'A' + String(max + 1).padStart(3, '0');
}

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentView = 'dashboard';
let selectedCase = null;
let filterType = null;
let filterStatus = null;
let searchQuery = '';
let progressFilter = '';
let progressView = 'list'; // 'list' | 'calendar'
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-based

function navigate(view, caseId = null) {
  if (view !== 'cases') filterStatus = null;
  currentView = view;
  selectedCase = caseId;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const nav = document.getElementById('nav-' + (view === 'case-detail' ? 'cases' : view));
  if (nav) nav.classList.add('active');
  // æ‰‹æ©Ÿç‰ˆï¼šé—œé–‰å´æ¬„
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  render();
}

function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebar-overlay').classList.toggle('open');
}

function render() {
  const main = document.getElementById('main-content');
  main.innerHTML = views[currentView]();
  // æ’å…¥æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ•
  const topbar = main.querySelector('.topbar');
  if (topbar) {
    const btn = document.createElement('button');
    btn.className = 'mobile-menu-btn';
    btn.onclick = toggleSidebar;
    btn.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
    topbar.insertBefore(btn, topbar.firstChild);
  }
  // æ›´æ–°å´æ¬„æ—¥æœŸ
  const _d = new Date();
  const _wd = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const sdEl = document.getElementById('sidebar-date');
  if (sdEl) sdEl.textContent = (_d.getFullYear()-1911) + 'å¹´' + String(_d.getMonth()+1).padStart(2,'0') + 'æœˆ' + String(_d.getDate()).padStart(2,'0') + 'æ—¥ æ˜ŸæœŸ' + _wd[_d.getDay()];
}

// â”€â”€â”€ Views â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const views = {

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dashboard() {
  const cases = db.cases;
  const total = cases.length;
  const active = cases.filter(c => c.status === 'é€²è¡Œä¸­').length;
  const pending = cases.filter(c => c.status === 'å¾…è£œä»¶').length;
  const closed = cases.filter(c => c.status === 'å·²çµæ¡ˆ').length;
  const typeGroups = [
    { label:'å‹å·¥ä¿éšª', cls:'labor', types:['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'è·ç½ä¿éšª', cls:'injury-ins', types:['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'è¾²æ°‘/å…¬æ•™ä¿éšª', cls:'farmer', types:['è¾²æ°‘ä¿éšªçµ¦ä»˜','å…¬æ•™ä¿éšªçµ¦ä»˜'] },
    { label:'çˆ­è­°/å¯©è­°/è¨´é¡˜', cls:'dispute', types:['çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'] },
    { label:'å•†æ¥­ä¿éšª', cls:'commercial', types:['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª'] },
  ];
  
  const deadlines = cases.filter(c => (c.deadline || c.plannedDate) && c.status !== 'å·²çµæ¡ˆ')
    .filter(c => {
      const d1 = c.deadline ? daysUntil(c.deadline) : null;
      const d2 = c.plannedDate ? daysUntil(c.plannedDate) : null;
      return (d1 !== null && d1 <= 45) || (d2 !== null && d2 <= 45);
    })
    .sort((a,b) => {
      const da = Math.min(a.deadline ? daysUntil(a.deadline) : 999, a.plannedDate ? daysUntil(a.plannedDate) : 999);
      const db2 = Math.min(b.deadline ? daysUntil(b.deadline) : 999, b.plannedDate ? daysUntil(b.plannedDate) : 999);
      return da - db2;
    });

  const _now = new Date();
  const rocY = _now.getFullYear() - 1911;
  const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const today = rocY + 'å¹´' + String(_now.getMonth()+1).padStart(2,'0') + 'æœˆ' + String(_now.getDate()).padStart(2,'0') + 'æ—¥ æ˜ŸæœŸ' + weekdays[_now.getDay()];

  return `
  <div class="topbar">
    <div class="topbar-title">å€‹æ¡ˆç¸½è¦½</div>
    <div class="topbar-actions">
      <button class="btn btn-gold" onclick="openNewCase()">ï¼‹ æ–°å¢å€‹æ¡ˆ</button>
    </div>
  </div>
  <div class="content">
    <div class="stats-grid">
      <div class="stat-card all" onclick="navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0f1f3d" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <div class="stat-label">å…¨éƒ¨å€‹æ¡ˆ</div>
        <div class="stat-num">${total}</div>
        
      </div>
      <div class="stat-card active" onclick="filterStatus='é€²è¡Œä¸­';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0072B2" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div class="stat-label">é€²è¡Œä¸­</div>
        <div class="stat-num" style="color:#0072B2">${active}</div>
        
      </div>
      <div class="stat-card pending" onclick="filterStatus='å¾…è£œä»¶';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#b7791f" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <div class="stat-label">å¾…è£œä»¶</div>
        <div class="stat-num" style="color:#b7791f">${pending}</div>
        
      </div>
      <div class="stat-card closed" onclick="filterStatus='å·²çµæ¡ˆ';navigate('cases')" style="cursor:pointer">
        <div class="stat-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4a5568" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
        <div class="stat-label">å·²çµæ¡ˆ</div>
        <div class="stat-num" style="color:#4a5568">${closed}</div>
        
      </div>
    </div>

    <div class="type-chips">
      ${typeGroups.map(g => `
        <div class="type-chip ${g.cls}" onclick='filterType=${JSON.stringify(g.types)};navigate("cases")' style="cursor:pointer">
          <div class="type-chip-label">${g.label}</div>
          <div class="type-chip-count">${cases.filter(c=>g.types.includes(c.type)).length}</div>
        </div>
      `).join('')}
    </div>

    <div style="display:grid;grid-template-columns:1fr 380px;gap:20px">
      <div>
        <div class="table-card">
          <div class="table-header">
            <div style="font-size:14px;font-weight:700;color:var(--navy)">â° è¿‘æœŸæœŸé™ï¼ˆ45å¤©å…§ï¼‰</div>
          </div>
          ${deadlines.length === 0 ? '<div class="empty"><p>è¿‘æœŸç„¡åˆ°æœŸäº‹é …</p></div>' : `
          <div style="padding:12px 16px">
            ${deadlines.map(c => {
              const rows = [];
              if (c.deadline && daysUntil(c.deadline) <= 45) {
                const days = daysUntil(c.deadline);
                const cls = days <= 14 ? 'deadline-urgent' : days <= 30 ? 'deadline-soon' : 'deadline-ok';
                rows.push(`<div class="deadline-item ${cls}" onclick="navigate('case-detail','${c.id}')" style="cursor:pointer">
                  <div>
                    <div class="deadline-label">${c.name} <span style="font-size:10px;color:#D55E00;font-weight:700;margin-left:6px">âš ï¸ æˆªæ­¢æ—¥æœŸ</span></div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:2px">${c.deadlineNote} Â· ${fmtDate(c.deadline)}</div>
                  </div>
                  ${daysBadge(days)}
                </div>`);
              }
              if (c.plannedDate && daysUntil(c.plannedDate) <= 45) {
                const days2 = daysUntil(c.plannedDate);
                const cls2 = days2 <= 7 ? 'deadline-soon' : 'deadline-ok';
                rows.push(`<div class="deadline-item ${cls2}" onclick="navigate('case-detail','${c.id}')" style="cursor:pointer">
                  <div>
                    <div class="deadline-label">${c.name} <span style="font-size:10px;color:#0EA5B0;font-weight:700;margin-left:6px">ğŸ“‹ é è¨ˆå®Œæˆ</span></div>
                    <div style="font-size:11px;color:var(--text-3);margin-top:2px">${c.plannedDateNote} Â· ${fmtDate(c.plannedDate)}</div>
                  </div>
                  ${daysBadge(days2)}
                </div>`);
              }
              return rows.join('');
            }).join('')}
          </div>`}
        </div>
      </div>
      <div>
        <div class="table-card">
          <div class="table-header"><div style="font-size:14px;font-weight:700;color:var(--navy)">æœ€è¿‘æ›´æ–°å€‹æ¡ˆ</div></div>
          <div>
            ${[...db.cases].sort((a,b) => b.updated.localeCompare(a.updated)).slice(0,5).map(c => `
              <div onclick="navigate('case-detail','${c.id}')" style="padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s" onmouseenter="this.style.background='rgba(15,31,61,0.025)'" onmouseleave="this.style.background=''">
                <div style="display:flex;align-items:center;justify-content:space-between">
                  <div style="font-size:13px;font-weight:600">${c.name} <span style="color:var(--text-3);font-weight:400">${c.id}</span></div>
                  <span class="badge ${statusColor[c.status]}">${c.status}</span>
                </div>
                <div style="font-size:11px;color:var(--text-3);margin-top:3px">${c.type} Â· æ›´æ–°ï¼š${fmtDate(c.updated)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  </div>`;
},

// â”€â”€ Cases List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cases() {
  let list = db.cases;
  if (filterType) {
    if (Array.isArray(filterType)) list = list.filter(c => filterType.includes(c.type));
    else list = list.filter(c => c.type === filterType);
  }
  if (filterStatus) list = list.filter(c => c.status === filterStatus);
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    list = list.filter(c => c.name.includes(q) || c.id.toLowerCase().includes(q) || c.employer.includes(q) || c.handler.includes(q) || (c.insurer||'').includes(q));
  }
  const typeFilterGroups = [
    { label:'å‹å·¥ä¿éšª', types:['å‹å·¥ä¿éšªçµ¦ä»˜','å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'è·ç½ä¿éšª', types:['è·ç½ä¿éšªçµ¦ä»˜','è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'] },
    { label:'å…¬è¾²æ•™', types:['è¾²æ°‘ä¿éšªçµ¦ä»˜','å…¬æ•™ä¿éšªçµ¦ä»˜'] },
    { label:'çˆ­è­°/è¨´è¨Ÿ', types:['çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿçˆ­è­°','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°/è¨´è¨Ÿ','å‹è³‡çˆ­è­°äº‹é …'] },
    { label:'å•†æ¥­ä¿éšª', types:['å•†æ¥­ä¿éšªç†è³ ','å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª'] },
  ];
  const statusLabel = filterStatus ? ' Â· ç¯©é¸ï¼š'+filterStatus : '';
  return `
  <div class="topbar">
    <div class="topbar-title">å€‹æ¡ˆæ¸…å–® <span class="text-muted">ï¼ˆ${list.length} ç­†${statusLabel}ï¼‰</span></div>
    <div class="topbar-actions">
      ${filterStatus ? '<button class="btn btn-outline btn-sm" onclick="filterStatus=null;render()">âœ• æ¸…é™¤ç‹€æ…‹ç¯©é¸</button>' : ''}
      <button class="btn btn-gold" onclick="openNewCase()">ï¼‹ æ–°å¢å€‹æ¡ˆ</button>
    </div>
  </div>
  <div class="content">
    <div class="table-card">
      <div class="table-header">
        <div class="search-box">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="æœå°‹å§“åã€ç·¨è™Ÿã€æŠ•ä¿å–®ä½ã€ä¿éšªå…¬å¸..." value="${searchQuery}"
            oninput="searchQuery=this.value;render()" />
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-sm ${!filterType?'btn-primary':'btn-outline'}" onclick="filterType=null;render()">å…¨éƒ¨</button>
          ${typeFilterGroups.map(g => {
            const isActive = Array.isArray(filterType) && JSON.stringify(filterType) === JSON.stringify(g.types);
            return '<button class="btn btn-sm '+(isActive?'btn-primary':'btn-outline')+'" onclick=\'filterType='+JSON.stringify(g.types)+';render()\'>'+g.label+'</button>';
          }).join('')}
        </div>
      </div>
      <table>
        <thead><tr>
          <th>å€‹æ¡ˆç·¨è™Ÿ</th><th>ç•¶äº‹äºº</th><th>å€‹æ¡ˆé¡å‹</th>
          <th>æŠ•ä¿å–®ä½/ä¿éšªå…¬å¸</th><th>æ¡ˆä»¶ç‹€æ…‹</th><th style="color:#D55E00">âš ï¸ æˆªæ­¢æ—¥æœŸ</th><th style="color:#0EA5B0">ğŸ“‹ é è¨ˆå®Œæˆ</th>
          <th>é ä¼°é‡‘é¡</th><th>è² è²¬äºº</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
        ${list.length === 0 ? `<tr><td colspan="10"><div class="empty"><p>æ‰¾ä¸åˆ°ç¬¦åˆçš„å€‹æ¡ˆ</p></div></td></tr>` :
          list.map(c => {
            const days = daysUntil(c.deadline);
            const daysP = daysUntil(c.plannedDate);
            return `
            <tr onclick="navigate('case-detail','${c.id}')">
              <td><span style="font-family:'Playfair Display';font-weight:600;color:var(--navy)">${c.id}</span></td>
              <td><strong>${c.name}</strong></td>
              <td><span class="badge ${typeColor[c.type]}">${c.type}</span></td>
              <td style="max-width:140px"><div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px">${c.employer}</div>${c.insurer?`<div style="font-size:11px;color:var(--text-3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px">${c.insurer}</div>`:""}</td>
              <td><span class="badge ${statusColor[c.status]}">${c.status}</span></td>
              <td>${c.deadline ? `<div style="font-size:12px;font-weight:600;color:#D55E00">${fmtDate(c.deadline)}</div><div style="font-size:11px;color:var(--text-3)">${c.deadlineNote}</div>${daysBadge(days)}` : '<span style="color:var(--text-3);font-size:12px">æœªè¨­å®š</span>'}</td>
              <td>${c.plannedDate ? `<div style="font-size:12px;font-weight:600;color:#0EA5B0">${fmtDate(c.plannedDate)}</div><div style="font-size:11px;color:var(--text-3)">${c.plannedDateNote}</div>${daysBadge(daysP)}` : '<span style="color:var(--text-3);font-size:12px">æœªè¨­å®š</span>'}</td>
              <td class="amount" style="color:var(--navy);font-weight:600">NT$ ${fmt(c.amount)}</td>
              <td><span class="badge badge-gray">${c.handler}</span></td>
              <td onclick="event.stopPropagation()" style="white-space:nowrap">
                <button class="btn btn-outline btn-sm" onclick="openEditCase('${c.id}');event.stopPropagation()">ç·¨è¼¯</button>
                <button class="btn btn-outline btn-sm" onclick="openNewCase('${c.id}');event.stopPropagation()" style="margin-left:4px" title="è¤‡è£½æ­¤å€‹æ¡ˆ">è¤‡è£½</button>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
},

// â”€â”€ Case Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
'case-detail'() {
  const c = db.cases.find(x => x.id === selectedCase);
  if (!c) return '<div class="content"><p>æ‰¾ä¸åˆ°å€‹æ¡ˆ</p></div>';
  const tracks = db.tracks.filter(t => t.caseId === c.id);
  const totalAmount = tracks.reduce((s,t) => s + (parseInt(t.amount)||0), 0) || parseInt(c.amount)||0;
  const trackColors = ['#2b6cb0','#D55E00','#0072B2','#6b46c1','#E69F00','#0EA5B0','#b7791f'];
  const trackBgColors = ['rgba(43,108,176,0.06)','rgba(213,94,0,0.06)','rgba(0,114,178,0.06)',
    'rgba(107,70,193,0.06)','rgba(230,159,0,0.06)','rgba(14,165,176,0.06)','rgba(183,121,31,0.06)'];

  function renderTimeline(progs, col) {
    if (!progs.length) return '<div class="empty" style="padding:16px 0"><p>å°šç„¡é€²åº¦è¨˜éŒ„</p></div>';
    var html = '<ul class="timeline">';
    progs.forEach(function(p, i) {
      var dotStyle = i === progs.length-1 ? 'background:'+col+';border-color:'+col : '';
      var srBadge = p.sendRecv ? '<span class="badge '+(p.sendRecv==='æ”¶ä»¶'?'badge-green':'badge-teal')+'" style="font-size:10px">'+p.sendRecv+'</span>' : '';
      var noteLine = p.note ? '<div class="timeline-desc" style="color:var(--text-3)">å‚™è¨»ï¼š'+p.note+'</div>' : '';
      var nextLine = p.nextStep ? '<div class="timeline-next" style="color:'+col+'">â†’ ä¸‹ä¸€æ­¥ï¼š'+p.nextStep+'ï¼ˆ'+fmtDate(p.nextDate)+'ï¼‰</div>' : '';
      html += '<li>'
        + '<div class="timeline-dot '+(i===progs.length-1?'active':'done')+'" style="'+dotStyle+'"></div>'
        + '<div class="timeline-date">'+fmtDate(p.date)+'</div>'
        + '<div class="timeline-stage">'+p.stage+' '+srBadge+'</div>'
        + '<div class="timeline-desc">'+p.desc+'</div>'
        + noteLine + nextLine
        + '</li>';
    });
    return html + '</ul>';
  }

  function renderTrack(tr, idx) {
    var col = trackColors[idx % trackColors.length];
    var bg = trackBgColors[idx % trackBgColors.length];
    var progs = db.progress.filter(function(p){ return p.trackId === tr.id; })
      .sort(function(a,b){ return a.date.localeCompare(b.date); });
    var lastProg = progs[progs.length-1];
    var days = daysUntil(tr.deadline);
    var daysP = daysUntil(tr.plannedDate);

    var deadlineRow = tr.deadline
      ? '<div style="font-size:11px"><span style="color:#D55E00;font-weight:600">âš ï¸ æˆªæ­¢ï¼š</span>'
        + fmtDate(tr.deadline) + ' ' + daysBadge(days) + '</div>' : '';
    var plannedRow = tr.plannedDate
      ? '<div style="font-size:11px"><span style="color:#0EA5B0;font-weight:600">ğŸ“‹ é è¨ˆï¼š</span>'
        + fmtDate(tr.plannedDate) + ' ' + daysBadge(daysP) + '</div>' : '';

    var lastProgHtml = '';
    if (lastProg) {
      var nextH = lastProg.nextStep
        ? '<div style="margin-top:8px;font-size:11px;color:'+col+';font-weight:600">â†’ '+lastProg.nextStep+'</div>'
          + '<div style="font-size:11px;color:var(--text-3)">'+fmtDate(lastProg.nextDate)+'</div>' : '';
      lastProgHtml = '<div style="background:var(--surface-2);border-radius:8px;padding:12px;border:1px solid var(--border)">'
        + '<div style="font-size:11px;font-weight:600;color:var(--text-3);margin-bottom:6px">æœ€æ–°é€²åº¦</div>'
        + '<span class="badge '+(stageColor[lastProg.stage]||'badge-gray')+'">'+lastProg.stage+'</span>'
        + '<div style="font-size:12px;margin-top:8px;color:var(--text-2)">'+lastProg.desc+'</div>'
        + nextH + '</div>';
    }
    var noteHtml = tr.note
      ? '<div style="margin-top:8px;font-size:11px;color:var(--text-3);padding:8px;background:var(--surface-2);border-radius:6px">'+tr.note+'</div>' : '';

    return '<div class="card" id="track-'+tr.id+'" style="border-top:3px solid '+col+';margin-bottom:20px">'
      + '<div class="card-head" style="background:'+bg+';padding:14px 18px">'
      + '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">'
      + '<div style="width:10px;height:10px;border-radius:50%;background:'+col+';flex-shrink:0"></div>'
      + '<span style="font-size:14px;font-weight:700;color:'+col+'">'+tr.name+'</span>'
      + '<span class="badge '+(typeColor[tr.type]||'badge-gray')+'">'+tr.type+'</span>'
      + '<span class="badge '+(statusColor[tr.status]||'badge-gray')+'">'+tr.status+'</span>'
      + '<span style="margin-left:auto;font-size:13px;font-weight:700;color:'+col+'" class="amount">NT$ '+fmt(tr.amount)+'</span>'
      + '</div>'
      + (deadlineRow||plannedRow ? '<div style="display:flex;gap:16px;margin-top:10px;flex-wrap:wrap">'+deadlineRow+plannedRow+'</div>' : '')
      + '</div>'
      + '<div class="card-body" style="padding:16px 20px">'
      + '<div style="display:grid;grid-template-columns:1fr 260px;gap:16px">'
      + '<div>' + renderTimeline(progs, col) + '</div>'
      + '<div>'
      + lastProgHtml + noteHtml
      + '<button class="btn btn-outline btn-sm" style="width:100%;margin-top:10px;border-color:'+col+';color:'+col+'" onclick="_trackAction(this)" data-action="addProgress" data-case="'+c.id+'" data-track="'+tr.id+'">ï¼‹ æ–°å¢é€²åº¦</button>'
      + '<button class="btn btn-outline btn-sm" style="width:100%;margin-top:6px;font-size:11px" onclick="_trackAction(this)" data-action="editTrack" data-track="'+tr.id+'">ç·¨è¼¯æ­¤è¿½è¹¤è»¸</button>'
      + '</div></div></div></div>';
  }

  var tracksHtml = tracks.length === 0
    ? '<div class="card"><div class="card-body"><div class="empty"><p>å°šç„¡è¿½è¹¤è»¸</p>'
      + '<button class="btn btn-gold" style="margin-top:12px" onclick="_trackAction(this)" data-action="addTrack" data-case="'+c.id+'">ï¼‹ æ–°å¢ç¬¬ä¸€æ¢è¿½è¹¤è»¸</button>'
      + '</div></div></div>'
    : tracks.map(function(tr,i){ return renderTrack(tr,i); }).join('');

  var sidebarTracks = tracks.length === 0
    ? '<div class="text-muted" style="text-align:center;padding:12px;font-size:12px">å°šç„¡è¿½è¹¤è»¸</div>'
    : tracks.map(function(tr,i){
        var col2 = trackColors[i%trackColors.length];
        var bg2 = trackBgColors[i%trackBgColors.length];
        return '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;margin-bottom:6px;background:'+bg2+';cursor:pointer;border:1px solid rgba(0,0,0,0.05)" onclick="_trackAction(this)" data-action="scrollTo" data-track="'+tr.id+'">'
          + '<div style="width:8px;height:8px;border-radius:50%;background:'+col2+';flex-shrink:0"></div>'
          + '<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+tr.name+'</div>'
          + '<div style="font-size:10px;color:var(--text-3)">'+tr.type+'</div></div>'
          + '<span class="badge '+(statusColor[tr.status]||'badge-gray')+'" style="font-size:10px">'+tr.status+'</span>'
          + '</div>';
      }).join('')
    + '<div style="padding-top:10px;border-top:1px solid var(--border);margin-top:6px">'
    + '<div style="font-size:11px;color:var(--text-3)">å„è»¸ç¸½è¨ˆé ä¼°é‡‘é¡</div>'
    + '<div class="amount" style="font-size:20px;font-weight:700;color:var(--navy);margin-top:4px">NT$ '+fmt(totalAmount)+'</div></div>';

  var dateQuickHtml = '';
  var hasDateTracks = tracks.filter(function(tr){ return tr.deadline||tr.plannedDate; });
  if (hasDateTracks.length > 0) {
    var dateRows = hasDateTracks.map(function(tr){
      var rows = '';
      if (tr.deadline) {
        var d = daysUntil(tr.deadline);
        rows += '<div class="deadline-item '+(d<=14?'deadline-urgent':d<=30?'deadline-soon':'deadline-ok')+'" style="margin-bottom:6px">'
          + '<div><div style="font-size:11px;font-weight:700">'+tr.name+'</div>'
          + '<div style="font-size:10px;color:var(--text-3)">âš ï¸ '+(tr.deadlineNote||'æˆªæ­¢')+' '+fmtDate(tr.deadline)+'</div></div>'
          + daysBadge(d) + '</div>';
      }
      if (tr.plannedDate) {
        var d2 = daysUntil(tr.plannedDate);
        rows += '<div class="deadline-item '+(d2<=7?'deadline-soon':'deadline-ok')+'" style="margin-bottom:6px">'
          + '<div><div style="font-size:11px;font-weight:700">'+tr.name+'</div>'
          + '<div style="font-size:10px;color:var(--text-3)">ğŸ“‹ '+(tr.plannedDateNote||'é è¨ˆ')+' '+fmtDate(tr.plannedDate)+'</div></div>'
          + daysBadge(d2) + '</div>';
      }
      return rows;
    }).join('');
    dateQuickHtml = '<div class="card"><div class="card-head">æ—¥æœŸå¿«è¦½</div><div class="card-body" style="padding:10px">' + dateRows + '</div></div>';
  }

  return `
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <button class="btn btn-outline btn-sm" onclick="navigate('cases')">â† è¿”å›</button>
      <div class="topbar-title">${c.name}ï½œ${c.id}</div>
      <span class="badge ${statusColor[c.status]}">${c.status}</span>
    </div>
    <div class="topbar-actions">
      <button class="btn btn-outline btn-sm" onclick="openEditCase('${c.id}')">ç·¨è¼¯å€‹æ¡ˆ</button>
      <button class="btn btn-outline btn-sm" onclick="openNewCase('${c.id}')" title="è¤‡è£½æ–°å¢">ğŸ“‹ è¤‡è£½æ–°å¢</button>
      <button class="btn btn-outline btn-sm" onclick="openAddTrack('${c.id}')" style="border-color:var(--teal);color:var(--teal)">ï¼‹ æ–°å¢è¿½è¹¤è»¸</button>
      <button class="btn btn-gold btn-sm" onclick="openAddProgress('${c.id}','')">ï¼‹ æ–°å¢é€²åº¦</button>
    </div>
  </div>
  <div class="content">
    <div style="display:grid;grid-template-columns:1fr 300px;gap:20px">
      <div>
        <div class="card" style="margin-bottom:16px">
          <div class="card-head">
            ç•¶äº‹äººåŸºæœ¬è³‡æ–™
            <span style="font-size:11px;color:var(--text-3);font-weight:400">å…± ${tracks.length} æ¢è¿½è¹¤è»¸ãƒ»ç¸½é ä¼° NT$ ${fmt(totalAmount)}</span>
          </div>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-item"><label>å§“å</label><value>${c.name}</value></div>
              <div class="info-item"><label>èº«åˆ†è­‰è™Ÿ</label><value>${c.idNum}</value></div>
              <div class="info-item"><label>è¯çµ¡é›»è©±</label><value>${c.phone}</value></div>
              <div class="info-item"><label>æŠ•ä¿å–®ä½</label><value>${c.employer}</value></div>
              <div class="info-item"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><value>${c.insurer||'â€”'}</value></div>
              <div class="info-item"><label>æŠ•ä¿è–ªè³‡</label><value>NT$ ${fmt(c.wage)}</value></div>
              <div class="info-item"><label>äº‹æ•…/èµ·å§‹æ—¥</label><value>${fmtDate(c.accidentDate)}</value></div>
              <div class="info-item"><label>å—ç†æ—¥æœŸ</label><value>${fmtDate(c.receiveDate)}</value></div>
              <div class="info-item"><label>è² è²¬äºº</label><value>${c.handler}</value></div>
            </div>
            ${c.note ? '<div class="divider"></div><div style="font-size:12px;color:var(--text-2)">'+c.note+'</div>' : ''}
          </div>
        </div>
        ${tracksHtml}
      </div>
      <div>
        <div class="card" style="margin-bottom:14px">
          <div class="card-head">è¿½è¹¤è»¸ç¸½è¦½</div>
          <div class="card-body" style="padding:12px">${sidebarTracks}</div>
        </div>
        ${dateQuickHtml}
      </div>
    </div>
  </div>`;
},
// â”€â”€ Progress â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
progress() {
  let progs = db.progress;
  if (progressFilter) progs = progs.filter(p => p.caseId === progressFilter);

  // â”€â”€ List View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function listView() {
    return `<div class="table-card">
      <table>
        <thead><tr>
          <th>å€‹æ¡ˆ</th><th>è¿½è¹¤è»¸</th><th>æ—¥æœŸ</th><th>é€²åº¦éšæ®µ</th><th>è¾¦ç†äº‹é …èªªæ˜</th>
          <th>æ”¶/é€ä»¶</th><th>æ‰¿è¾¦äºº</th><th>ä¸‹ä¸€æ­¥</th><th>å‚™è¨»</th>
        </tr></thead>
        <tbody>
        ${progs.length === 0 ? `<tr><td colspan="9"><div class="empty"><p>å°šç„¡é€²åº¦è¨˜éŒ„</p></div></td></tr>` :
          [...progs].sort((a,b) => b.date.localeCompare(a.date)).map(p => {
            const c = db.cases.find(x => x.id === p.caseId);
            const tr = p.trackId ? db.tracks.find(t => t.id === p.trackId) : null;
            return `<tr onclick="navigate('case-detail','${p.caseId}')" style="cursor:pointer">
              <td><strong>${p.caseId}</strong><div style="font-size:11px;color:var(--text-3)">${c?c.name:''}</div></td>
              <td style="max-width:130px">${tr ? `<div style="font-size:12px;font-weight:600">${tr.name}</div><span class="badge ${typeColor[tr.type]||'badge-gray'}" style="font-size:10px">${tr.type}</span>` : '<span style="color:var(--text-3);font-size:11px">â€”</span>'}</td>
              <td style="white-space:nowrap">${fmtDate(p.date)}</td>
              <td><span class="badge ${stageColor[p.stage]||'badge-gray'}">${p.stage}</span></td>
              <td style="max-width:180px">${p.desc}</td>
              <td>${p.sendRecv ? `<span class="badge ${p.sendRecv==='æ”¶ä»¶'?'badge-green':'badge-teal'}">${p.sendRecv}</span>` : '-'}</td>
              <td>${p.handler}</td>
              <td style="max-width:130px">${p.nextStep||'-'}${p.nextDate?`<div style="font-size:11px;color:var(--text-3)">${fmtDate(p.nextDate)}</div>`:''}</td>
              <td style="max-width:110px;color:var(--text-3);font-size:12px">${p.note||'-'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`;
  }

  // â”€â”€ Calendar View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function calendarView() {
    const y = calYear, m = calMonth;
    const rocY = y - 1911;
    const monthNames = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
    const firstDaySun = new Date(y, m, 1).getDay(); // 0=Sun
    const firstDay = (firstDaySun + 6) % 7; // convert: Mon=0, Tue=1, ... Sun=6
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const today = new Date();

    // Group events by date string YYYY-MM-DD
    function pad(n){ return String(n).padStart(2,'0'); }
    const eventsByDate = {};
    const allProgs = progressFilter ? db.progress.filter(p=>p.caseId===progressFilter) : db.progress;

    // Progress events
    allProgs.forEach(p => {
      if (!p.date) return;
      if (!eventsByDate[p.date]) eventsByDate[p.date] = [];
      const c = db.cases.find(x=>x.id===p.caseId);
      eventsByDate[p.date].push({ type:'progress', label:(c?c.name:p.caseId)+': '+p.stage, desc:p.desc, caseId:p.caseId, badge:'badge-blue', dot:'#2b6cb0', stage:p.stage, sendRecv:p.sendRecv });
      // Next step date
      if (p.nextDate) {
        if (!eventsByDate[p.nextDate]) eventsByDate[p.nextDate] = [];
        eventsByDate[p.nextDate].push({ type:'next', label:(c?c.name:p.caseId)+': '+p.nextStep, desc:'ä¸‹ä¸€æ­¥', caseId:p.caseId, badge:'badge-teal', dot:'#0EA5B0' });
      }
    });

    // Deadline events from tracks (or case-level)
    const checkCases = progressFilter ? db.cases.filter(c=>c.id===progressFilter) : db.cases;
    const checkTracks = progressFilter ? db.tracks.filter(t=>t.caseId===progressFilter) : db.tracks;
    checkTracks.forEach(tr => {
      const c = db.cases.find(x=>x.id===tr.caseId);
      if (tr.deadline) {
        if (!eventsByDate[tr.deadline]) eventsByDate[tr.deadline] = [];
        eventsByDate[tr.deadline].push({ type:'deadline', label:(c?c.name:tr.caseId)+' æˆªæ­¢', desc:tr.deadlineNote||tr.name, caseId:tr.caseId, badge:'badge-red', dot:'#D55E00' });
      }
      if (tr.plannedDate) {
        if (!eventsByDate[tr.plannedDate]) eventsByDate[tr.plannedDate] = [];
        eventsByDate[tr.plannedDate].push({ type:'planned', label:(c?c.name:tr.caseId)+' é è¨ˆå®Œæˆ', desc:tr.plannedDateNote||tr.name, caseId:tr.caseId, badge:'badge-teal', dot:'#0EA5B0' });
      }
    });

    // Build calendar grid
    let cells = '';
    const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
    for (let i = 0; i < totalCells; i++) {
      const dayNum = i - firstDay + 1;
      const isValid = dayNum >= 1 && dayNum <= daysInMonth;
      const dateStr = isValid ? y+'-'+pad(m+1)+'-'+pad(dayNum) : '';
      const isToday = isValid && today.getFullYear()===y && today.getMonth()===m && today.getDate()===dayNum;
      const events = (isValid && eventsByDate[dateStr]) || [];
      const rocDay = (y-1911)+'/'+(m+1)+'/'+dayNum;

      const dotHtml = events.slice(0,4).map(e =>
        `<span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${e.dot};margin:1px" title="${e.label}"></span>`
      ).join('');
      const evtHtml = events.slice(0,3).map(e =>
        `<div onclick="event.stopPropagation();navigate('case-detail','${e.caseId}')" style="font-size:10px;padding:2px 5px;margin:1px 0;border-radius:3px;background:${e.dot}18;border-left:2px solid ${e.dot};color:var(--text);cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${e.label}: ${e.desc}">${e.label}</div>`
      ).join('') + (events.length > 3 ? `<div style="font-size:9px;color:var(--text-3);padding-left:3px">+${events.length-3} æ›´å¤š</div>` : '');

      cells += `<div style="min-height:90px;padding:6px;${(i%7)<6?'border-right:1px solid var(--border);':''}border-bottom:1px solid var(--border);background:${isToday?'rgba(201,168,76,0.08)':isValid?'var(--surface)':'var(--surface-2)'}">`
        + (isValid ? `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">`
          + `<span style="font-size:12px;font-weight:${isToday?'700':'500'};color:${isToday?'var(--gold)':'var(--text)'};width:22px;height:22px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:${isToday?'var(--gold)':'transparent'};color:${isToday?'#fff':'var(--text)'}">${dayNum}</span>`
          + `<span style="font-size:9px;color:var(--text-3)">${events.length>0?dotHtml:''}</span>`
          + `</div>${evtHtml}` : '')
        + `</div>`;
    }

    const weekDayHeaders = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map((d,i) =>
      `<div style="padding:8px 0;text-align:center;font-size:11px;font-weight:700;color:var(--text-3);background:var(--surface-2);border-bottom:1px solid var(--border);${i<6?'border-right:1px solid var(--border)':''}">${d}</div>`
    ).join('');

    return `<div style="background:var(--surface);border-radius:12px;border:1px solid var(--border);overflow:hidden;box-shadow:var(--shadow)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--navy)">
        <button class="btn btn-sm" style="background:rgba(255,255,255,0.1);color:#fff;border:none" onclick="calMonth--;if(calMonth<0){calMonth=11;calYear--;}render()">â€¹</button>
        <div style="font-size:16px;font-weight:700;color:#fff">${rocY} å¹´ ${monthNames[m]}</div>
        <button class="btn btn-sm" style="background:rgba(255,255,255,0.1);color:#fff;border:none" onclick="calMonth++;if(calMonth>11){calMonth=0;calYear++;}render()">â€º</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(7,minmax(0,1fr))">${weekDayHeaders}${cells}</div>
      <div style="padding:10px 16px;border-top:1px solid var(--border);display:flex;gap:16px;font-size:11px;color:var(--text-3)">
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#2b6cb0;margin-right:4px"></span>é€²åº¦è¨˜éŒ„</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#D55E00;margin-right:4px"></span>æˆªæ­¢æ—¥æœŸ</span>
        <span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#0EA5B0;margin-right:4px"></span>é è¨ˆå®Œæˆ/ä¸‹ä¸€æ­¥</span>
      </div>
    </div>`;
  }

  const viewContent = progressView === 'calendar' ? calendarView() : listView();

  return `
  <div class="topbar">
    <div class="topbar-title">é€²åº¦è¿½è¹¤</div>
    <div class="topbar-actions">
      <select class="btn btn-outline" onchange="progressFilter=this.value;render()" style="cursor:pointer">
        <option value="">å…¨éƒ¨å€‹æ¡ˆ</option>
        ${db.cases.map(c => `<option value="${c.id}" ${progressFilter===c.id?'selected':''}>${c.id} ${c.name}</option>`).join('')}
      </select>
      <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden">
        <button class="btn btn-sm" style="border-radius:0;border:none;${progressView==='list'?'background:var(--navy);color:#fff':''}" onclick="progressView='list';render()" title="æ¸…å–®æª¢è¦–">â˜° æ¸…å–®</button>
        <button class="btn btn-sm" style="border-radius:0;border:none;border-left:1px solid var(--border);${progressView==='calendar'?'background:var(--navy);color:#fff':''}" onclick="progressView='calendar';render()" title="è¡Œäº‹æ›†æª¢è¦–">ğŸ“… è¡Œäº‹æ›†</button>
      </div>
      <button class="btn btn-gold" onclick="openAddProgress('')">ï¼‹ æ–°å¢é€²åº¦</button>
    </div>
  </div>
  <div class="content">
    ${viewContent}
  </div>`;
},

// â”€â”€ Deadlines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deadlines() {
  // åŒæ™‚è®€å–è¿½è¹¤è»¸ + å€‹æ¡ˆå±¤ç´šçš„æ—¥æœŸ
  const activeCases = db.cases.filter(c => c.status !== 'å·²çµæ¡ˆ' && c.status !== 'æ’¤æ¡ˆ');
  const activeCaseIds = new Set(activeCases.map(c => c.id));

  // å½™æ•´æ‰€æœ‰æˆªæ­¢æ—¥æœŸï¼ˆè¿½è¹¤è»¸å„ªå…ˆï¼Œå€‹æ¡ˆå±¤ç´šè£œå……ï¼‰
  const hardItems = [];
  const plannedItems = [];

  db.tracks.filter(t => activeCaseIds.has(t.caseId) && t.status !== 'å·²çµæ¡ˆ' && t.status !== 'æ’¤æ¡ˆ').forEach(t => {
    const c = db.cases.find(x => x.id === t.caseId);
    if (!c) return;
    if (t.deadline) hardItems.push({ id:t.id, caseId:t.caseId, name:c.name, type:t.type, deadline:t.deadline, deadlineNote:t.deadlineNote||t.name, days:daysUntil(t.deadline), trackName:t.name });
    if (t.plannedDate) plannedItems.push({ id:t.id, caseId:t.caseId, name:c.name, type:t.type, plannedDate:t.plannedDate, plannedDateNote:t.plannedDateNote||t.name, days:daysUntil(t.plannedDate), trackName:t.name });
  });
  // å€‹æ¡ˆå±¤ç´šï¼ˆç„¡è¿½è¹¤è»¸æ™‚çš„ fallbackï¼‰
  activeCases.filter(c => c.deadline && !db.tracks.some(t=>t.caseId===c.id&&t.deadline)).forEach(c => {
    hardItems.push({ id:c.id, caseId:c.id, name:c.name, type:c.type, deadline:c.deadline, deadlineNote:c.deadlineNote||'', days:daysUntil(c.deadline), trackName:null });
  });
  activeCases.filter(c => c.plannedDate && !db.tracks.some(t=>t.caseId===c.id&&t.plannedDate)).forEach(c => {
    plannedItems.push({ id:c.id, caseId:c.id, name:c.name, type:c.type, plannedDate:c.plannedDate, plannedDateNote:c.plannedDateNote||'', days:daysUntil(c.plannedDate), trackName:null });
  });

  hardItems.sort((a,b) => a.days - b.days);
  plannedItems.sort((a,b) => a.days - b.days);

  function hardCard(item) {
    const cls = item.days < 0 ? 'deadline-urgent' : item.days <= 14 ? 'deadline-urgent' : item.days <= 30 ? 'deadline-soon' : 'deadline-ok';
    const accent = item.days < 0 ? '#5C1A1A' : item.days <= 14 ? '#D55E00' : item.days <= 30 ? '#b7791f' : '#0072B2';
    return `<div onclick="navigate('case-detail','${item.caseId}')" class="deadline-item ${cls}" style="margin-bottom:8px;cursor:pointer;border-left:3px solid ${accent}" onmouseenter="this.style.opacity='0.85'" onmouseleave="this.style.opacity='1'">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">${item.name} <span style="color:var(--text-3);font-weight:400;font-size:11px">${item.caseId}</span></div>
        ${item.trackName ? `<div style="font-size:11px;color:var(--text-3)">è¿½è¹¤è»¸ï¼š${item.trackName}</div>` : ''}
        <div style="font-size:11px;color:var(--text-3);margin-top:1px">${item.deadlineNote} Â· ${fmtDate(item.deadline)}</div>
        <span class="badge ${typeColor[item.type]||'badge-gray'}" style="font-size:10px;margin-top:4px">${item.type}</span>
      </div>
      <div style="flex-shrink:0">${daysBadge(item.days)}</div>
    </div>`;
  }

  function plannedCard(item) {
    const cls = item.days <= 7 ? 'deadline-soon' : 'deadline-ok';
    const accent = item.days <= 7 ? '#b7791f' : '#0EA5B0';
    return `<div onclick="navigate('case-detail','${item.caseId}')" class="deadline-item ${cls}" style="margin-bottom:8px;cursor:pointer;border-left:3px solid ${accent}" onmouseenter="this.style.opacity='0.85'" onmouseleave="this.style.opacity='1'">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:700">${item.name} <span style="color:var(--text-3);font-weight:400;font-size:11px">${item.caseId}</span></div>
        ${item.trackName ? `<div style="font-size:11px;color:var(--text-3)">è¿½è¹¤è»¸ï¼š${item.trackName}</div>` : ''}
        <div style="font-size:11px;color:var(--text-3);margin-top:1px">${item.plannedDateNote} Â· ${fmtDate(item.plannedDate)}</div>
        <span class="badge ${typeColor[item.type]||'badge-gray'}" style="font-size:10px;margin-top:4px">${item.type}</span>
      </div>
      <div style="flex-shrink:0">${daysBadge(item.days)}</div>
    </div>`;
  }

  const overdue = hardItems.filter(i => i.days < 0);
  const urgent  = hardItems.filter(i => i.days >= 0 && i.days <= 14);
  const soon    = hardItems.filter(i => i.days > 14 && i.days <= 30);
  const later   = hardItems.filter(i => i.days > 30);

  const p7    = plannedItems.filter(i => i.days <= 7);
  const p30   = plannedItems.filter(i => i.days > 7 && i.days <= 30);
  const pLater= plannedItems.filter(i => i.days > 30);

  function section(label, color, bg, items, cardFn, emptyMsg) {
    return `<div style="margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:${color};margin-bottom:8px;padding:5px 10px;background:${bg};border-radius:6px">${label}</div>
      ${items.length ? items.map(cardFn).join('') : `<div class="text-muted" style="padding:10px;font-size:12px">${emptyMsg}</div>`}
    </div>`;
  }

  return `
  <div class="topbar">
    <div class="topbar-title">æœŸé™ç®¡ç†</div>
    <div class="topbar-actions" style="font-size:12px;color:var(--text-3)">å…± ${hardItems.length + plannedItems.length} ç­†å¾…è¾¦æœŸé™</div>
  </div>
  <div class="content">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">

      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:rgba(213,94,0,0.05);border-radius:10px;border:1px solid rgba(213,94,0,0.25)">
          <span style="font-size:20px">âš ï¸</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:#D55E00">å®Œæˆæˆªæ­¢æ—¥æœŸ</div>
            <div style="font-size:11px;color:var(--text-3)">æ³•å®šæœŸé™ãƒ»æ³•é™¢æœŸæ—¥ãƒ»æ©Ÿé—œè¦æ±‚æˆªæ­¢</div>
          </div>
          <span style="margin-left:auto;font-size:13px;font-weight:700;color:#D55E00">${hardItems.filter(i=>i.days>=0).length} ç­†</span>
        </div>
        ${overdue.length ? section('ğŸš« å·²é€¾æœŸ', '#5C1A1A', 'rgba(92,26,26,0.08)', overdue, hardCard, '') : ''}
        ${section('ğŸ”” 14å¤©å…§ï¼ˆç·Šæ€¥ï¼‰', '#D55E00', 'rgba(213,94,0,0.07)', urgent, hardCard, 'ç„¡ç·Šæ€¥æˆªæ­¢')}
        ${section('â± 15â€“30å¤©', '#b7791f', 'rgba(214,158,46,0.07)', soon, hardCard, 'ç„¡')}
        ${section('ğŸ“Œ 30å¤©ä»¥ä¸Š', '#4a5568', 'var(--surface-2)', later, hardCard, 'ç„¡')}
      </div>

      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding:10px 14px;background:rgba(14,165,176,0.05);border-radius:10px;border:1px solid rgba(14,165,176,0.25)">
          <span style="font-size:20px">ğŸ“‹</span>
          <div>
            <div style="font-size:13px;font-weight:700;color:#0EA5B0">é è¨ˆå®Œæˆæ—¥æœŸ</div>
            <div style="font-size:11px;color:var(--text-3)">å…§éƒ¨è¦åŠƒç›®æ¨™ãƒ»é è¨ˆå‚™ä»¶å®Œæˆæ—¥</div>
          </div>
          <span style="margin-left:auto;font-size:13px;font-weight:700;color:#0EA5B0">${plannedItems.length} ç­†</span>
        </div>
        ${section('â° 7å¤©å…§ï¼ˆå³å°‡åˆ°æœŸï¼‰', '#0EA5B0', 'rgba(14,165,176,0.07)', p7, plannedCard, 'ç„¡')}
        ${section('ğŸ“… 8â€“30å¤©', '#0072B2', 'rgba(0,114,178,0.07)', p30, plannedCard, 'ç„¡')}
        ${section('ğŸ“Œ 30å¤©ä»¥ä¸Š', '#4a5568', 'var(--surface-2)', pLater, plannedCard, 'ç„¡')}
      </div>
    </div>
  </div>`;
},

// â”€â”€ Archive & Backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
archive() {
  const closedCases = db.cases.filter(c => c.status === 'å·²çµæ¡ˆ' || c.status === 'æ’¤æ¡ˆ');
  const activeCases = db.cases.filter(c => c.status !== 'å·²çµæ¡ˆ' && c.status !== 'æ’¤æ¡ˆ');
  const closedTracks = db.tracks.filter(t => closedCases.some(c => c.id === t.caseId));
  const closedProgress = db.progress.filter(p => closedCases.some(c => c.id === p.caseId));

  // ä¼°ç®— localStorage ä½¿ç”¨é‡
  let storageUsed = 0;
  try { const s = localStorage.getItem('case_mgmt_v4'); if (s) storageUsed = new Blob([s]).size; } catch(e){}
  const storageKB = (storageUsed / 1024).toFixed(1);
  const storagePct = Math.min((storageUsed / (5*1024*1024)) * 100, 100).toFixed(1);

  return `
  <div class="topbar">
    <div class="topbar-title">æ­¸æª”èˆ‡å‚™ä»½</div>
  </div>
  <div class="content">
    <div style="max-width:720px">

      <!-- å„²å­˜ç©ºé–“ -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head">ğŸ’¾ å„²å­˜ç©ºé–“æ¦‚æ³</div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;text-align:center;margin-bottom:16px">
            <div><div style="font-size:28px;font-weight:700;color:var(--navy)">${db.cases.length}</div><div style="font-size:11px;color:var(--text-3)">å…¨éƒ¨å€‹æ¡ˆ</div></div>
            <div><div style="font-size:28px;font-weight:700;color:#0072B2">${activeCases.length}</div><div style="font-size:11px;color:var(--text-3)">é€²è¡Œä¸­</div></div>
            <div><div style="font-size:28px;font-weight:700;color:var(--text-3)">${closedCases.length}</div><div style="font-size:11px;color:var(--text-3)">å·²çµæ¡ˆ/æ’¤æ¡ˆ</div></div>
          </div>
          <div style="font-size:12px;color:var(--text-2);margin-bottom:6px">localStorage ä½¿ç”¨ï¼š${storageKB} KB / 5,120 KBï¼ˆ${storagePct}%ï¼‰</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${storagePct}%;background:${parseFloat(storagePct)>80?'var(--danger)':parseFloat(storagePct)>50?'var(--warning)':'var(--gold)'}"></div></div>
        </div>
      </div>

      <!-- æ­¸æª”çµæ¡ˆ -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head" style="${closedCases.length ? 'background:rgba(201,168,76,0.06)' : ''}">
          ğŸ“¦ æ­¸æª”å·²çµæ¡ˆå€‹æ¡ˆ
          ${closedCases.length ? '<span class="badge badge-yellow">'+closedCases.length+' ç­†å¯æ­¸æª”</span>' : '<span class="badge badge-gray">ç„¡å¯æ­¸æª”å€‹æ¡ˆ</span>'}
        </div>
        <div class="card-body">
          ${closedCases.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-3);font-size:13px">ç›®å‰æ²’æœ‰å·²çµæ¡ˆæˆ–æ’¤æ¡ˆçš„å€‹æ¡ˆ</div>' : `
          <div style="padding:10px 14px;background:rgba(0,114,178,0.05);border-radius:8px;font-size:12px;color:var(--text-2);margin-bottom:14px;border-left:3px solid #0072B2">
            æ­¸æª”æœƒå…ˆä¸‹è¼‰ä¸€ä»½ JSON å‚™ä»½æª”ï¼Œç¢ºèªä¸‹è¼‰å¾Œå†å¾ç³»çµ±ä¸­åˆªé™¤ã€‚<br>
            å‚™ä»½æª”åŒ…å«å®Œæ•´çš„å€‹æ¡ˆè³‡æ–™ã€è¿½è¹¤è»¸å’Œé€²åº¦è¨˜éŒ„ï¼Œæ—¥å¾Œå¯é€éã€ŒåŒ¯å…¥ã€é‚„åŸã€‚
          </div>
          <div style="margin-bottom:14px">
            ${closedCases.map(c => {
              const tCount = db.tracks.filter(t => t.caseId === c.id).length;
              const pCount = db.progress.filter(p => p.caseId === c.id).length;
              return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:6px">'
                + '<input type="checkbox" class="archive-cb" value="'+c.id+'" checked style="width:16px;height:16px;cursor:pointer">'
                + '<div style="flex:1;min-width:0">'
                + '<div style="font-size:13px;font-weight:600">'+c.name+' <span style="color:var(--text-3);font-weight:400">'+c.id+'</span></div>'
                + '<div style="font-size:11px;color:var(--text-3)">'+c.type+' Â· '+tCount+' æ¢è¿½è¹¤è»¸ Â· '+pCount+' ç­†é€²åº¦ Â· <span class="badge '+(c.status==='å·²çµæ¡ˆ'?'status-closed':'status-closed')+'">'+c.status+'</span></div>'
                + '</div></div>';
            }).join('')}
          </div>
          <div style="display:flex;gap:10px">
            <button class="btn btn-gold" onclick="archiveSelected()">ğŸ“¦ æ­¸æª”ä¸¦ä¸‹è¼‰é¸å–çš„å€‹æ¡ˆ</button>
            <button class="btn btn-outline btn-sm" onclick="var cbs=document.querySelectorAll('.archive-cb');var allChecked=[].every.call(cbs,function(cb){return cb.checked});cbs.forEach(function(cb){cb.checked=!allChecked})">å…¨é¸ / å…¨ä¸é¸</button>
          </div>
          `}
        </div>
      </div>

      <!-- åŒ¯å‡º -->
      <div class="card" style="margin-bottom:20px">
        <div class="card-head">ğŸ“¥ åŒ¯å‡ºå‚™ä»½</div>
        <div class="card-body">
          <button class="btn btn-gold" onclick="exportAllJson()" style="width:100%">ğŸ“¥ åŒ¯å‡ºå…¨éƒ¨è³‡æ–™ï¼ˆJSONï¼‰</button>
          <div style="font-size:11px;color:var(--text-3);margin-top:8px;text-align:center">ä¸‹è¼‰ç›®å‰ç³»çµ±å…§æ‰€æœ‰å€‹æ¡ˆã€è¿½è¹¤è»¸ã€é€²åº¦è¨˜éŒ„</div>
        </div>
      </div>

      <!-- åŒ¯å…¥ï¼šå…©ç¨®æ–¹å¼ä¸¦æ’ -->
      <div class="card">
        <div class="card-head">ğŸ“¤ åŒ¯å…¥é‚„åŸ</div>
        <div class="card-body" style="padding:0">
          <div style="display:grid;grid-template-columns:1fr 1fr;min-height:100%">

            <!-- å·¦ï¼šé‚„åŸæ­¸æª” -->
            <div style="padding:18px;border-right:1px solid var(--border)">
              <div style="font-size:14px;font-weight:700;color:#0072B2;margin-bottom:4px">â™»ï¸ é‚„åŸæ­¸æª”å€‹æ¡ˆ</div>
              <div style="font-size:12px;color:var(--text-2);margin-bottom:14px;line-height:1.6">
                æŠŠä¹‹å‰æ­¸æª”çš„å€‹æ¡ˆ<strong>åŠ å›ä¾†</strong>ã€‚<br>ç¾æœ‰é€²è¡Œä¸­çš„å€‹æ¡ˆ<strong style="color:#0072B2">ä¸å—å½±éŸ¿</strong>ã€‚
              </div>
              <div style="padding:10px;background:rgba(0,114,178,0.05);border-radius:8px;font-size:11px;color:var(--text-3);margin-bottom:14px">
                <div style="margin-bottom:4px"><strong>è¡Œç‚ºï¼š</strong>Mergeï¼ˆåˆä½µï¼‰</div>
                <div style="margin-bottom:4px"><strong>é©åˆï¼š</strong>æŸ¥èˆŠæ¡ˆã€é‡å•Ÿå·²çµæ¡ˆå€‹æ¡ˆ</div>
                <div><strong>é¢¨éšªï¼š</strong><span style="color:#0072B2">ä½</span> â€” åƒ…ç›¸åŒ ID æœƒè¢«è¦†è“‹</div>
              </div>
              <button class="btn btn-outline" onclick="document.getElementById('restore-file').click()" style="width:100%">é¸æ“‡æ­¸æª”æª”æ¡ˆ</button>
              <input type="file" id="restore-file" accept=".json" style="display:none" onchange="restoreArchive(this)">
            </div>

            <!-- å³ï¼šå…¨é‡é‚„åŸ -->
            <div style="padding:18px">
              <div style="font-size:14px;font-weight:700;color:#D55E00;margin-bottom:4px">ğŸ”„ å…¨é‡é‚„åŸ</div>
              <div style="font-size:12px;color:var(--text-2);margin-bottom:14px;line-height:1.6">
                å¾å‚™ä»½æª”<strong>å®Œæ•´é‚„åŸ</strong>ã€‚<br>ç¾æœ‰è³‡æ–™<strong style="color:#D55E00">å…¨éƒ¨è¢«å–ä»£</strong>ã€‚
              </div>
              <div style="padding:10px;background:rgba(213,94,0,0.04);border-radius:8px;font-size:11px;color:var(--text-3);margin-bottom:14px">
                <div style="margin-bottom:4px"><strong>è¡Œç‚ºï¼š</strong>è¦†è“‹ï¼ˆæ¸…ç©ºå¾ŒåŒ¯å…¥ï¼‰</div>
                <div style="margin-bottom:4px"><strong>é©åˆï¼š</strong>æ›é›»è…¦ã€ç€è¦½å™¨è³‡æ–™éºå¤±</div>
                <div><strong>é¢¨éšªï¼š</strong><span style="color:#D55E00">é«˜</span> â€” ç¾æœ‰è³‡æ–™å…¨éƒ¨æ¶ˆå¤±</div>
              </div>
              <button class="btn btn-outline" onclick="document.getElementById('import-file').click()" style="width:100%;border-color:rgba(213,94,0,0.4);color:#D55E00">é¸æ“‡å‚™ä»½æª”æ¡ˆ</button>
              <input type="file" id="import-file" accept=".json" style="display:none" onchange="importJson(this)">
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>`;
}
};

// â”€â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fillFromCase(srcId) {
  if (!srcId) return;
  const src = db.cases.find(c => c.id === srcId);
  if (!src) return;
  // Fill all fields from source case
  const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
  const setHint = (id) => { const h = document.getElementById('hint-'+id); const el = document.getElementById(id); if (h && el && el.value) h.textContent = rocHint(id); };

  // Type: find matching option
  const typeEl = document.getElementById('f-type');
  if (typeEl) {
    for (let opt of typeEl.options) { if (opt.value === src.type) { opt.selected = true; break; } }
  }
  setVal('f-name', src.name);
  setVal('f-id-num', src.idNum);
  setVal('f-phone', src.phone);
  setVal('f-employer', src.employer);
  setVal('f-insurer', src.insurer||'');
  setVal('f-wage', src.wage);
  setVal('f-accident', src.accidentDate);
  setVal('f-receive', new Date().toISOString().slice(0,10)); // fresh receive date
  const statusEl = document.getElementById('f-status');
  if (statusEl) { for (let opt of statusEl.options) { if (opt.value === 'é€²è¡Œä¸­') { opt.selected = true; break; } } }
  setVal('f-handler', src.handler);
  setVal('f-amount', src.amount);
  setVal('f-deadline', '');
  setVal('f-deadline-note', src.deadlineNote || '');
  setVal('f-planned', '');
  setVal('f-planned-note', src.plannedDateNote || '');
  setVal('f-note', src.note ? '[è¤‡è£½è‡ª ' + src.id + ' ' + src.name + '] ' + src.note : '');
  // Update ROC hints
  ['f-accident','f-receive'].forEach(setHint);
  // Flash feedback
  const banner = document.getElementById('copy-banner');
  if (banner) {
    banner.innerHTML = 'âœ“ å·²è¤‡è£½ <strong>' + src.id + ' ' + src.name + '</strong> çš„è³‡æ–™ï¼Œè«‹ç¢ºèªä¸¦ä¿®æ”¹';
    banner.style.display = 'block';
  }
}

function openNewCase(copyFromId) {
  const id = genId();
  showModal('æ–°å¢å€‹æ¡ˆ', `
    <div id="copy-banner" style="display:none;padding:10px 14px;background:rgba(0,114,178,0.08);border:1px solid rgba(0,114,178,0.25);border-radius:8px;font-size:12px;color:#0072B2;margin-bottom:14px"></div>
    <div style="padding:12px 14px;background:rgba(201,168,76,0.07);border:1px dashed var(--gold);border-radius:10px;margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--gold);margin-bottom:8px">ğŸ“‹ å¿«é€Ÿè¤‡è£½ç¾æœ‰å€‹æ¡ˆè³‡æ–™ï¼ˆå¯é¸ï¼‰</div>
      <div class="form-grid">
        <div class="field">
          <label>é¸æ“‡ä¾†æºå€‹æ¡ˆ</label>
          <select id="f-copy-src" onchange="fillFromCase(this.value)">
            <option value="">â€” ä¸è¤‡è£½ï¼Œå¾ç©ºç™½é–‹å§‹ â€”</option>
            ${db.cases.map(c => '<option value="' + c.id + '">' + c.id + 'ã€€' + c.name + 'ã€€ï¼ˆ' + c.type + 'ï¼‰</option>').join('')}
          </select>
        </div>
        <div class="field" style="justify-content:flex-end;padding-top:18px">
          <div style="font-size:11px;color:var(--text-3)">é¸æ“‡å€‹æ¡ˆå¾Œè‡ªå‹•å¡«å…¥åŸºæœ¬è³‡æ–™<br>æ—¥æœŸèˆ‡ç·¨è™Ÿå°‡è‡ªå‹•é‡è¨­</div>
        </div>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-id" value="${id}" placeholder="è‡ªå‹•ç·¨è™Ÿ"></div>
      <div class="field"><label>å€‹æ¡ˆé¡å‹ *</label>
        <select id="f-type"><option value="">è«‹é¸æ“‡</option>
          <optgroup label="å‹å·¥ä¿éšª">
            <option>å‹ä¿ç”Ÿè‚²çµ¦ä»˜</option>
            <option>å‹ä¿å‚·ç—…çµ¦ä»˜</option>
            <option>å‹ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>å‹ä¿è€å¹´çµ¦ä»˜</option>
            <option>å‹ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            <option>è·ä¿é†«ç™‚çµ¦ä»˜</option>
            <option>è·ä¿å‚·ç—…çµ¦ä»˜</option>
            <option>è·ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>è·ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="å…¬è¾²æ•™ä¿éšª">
            <option>è¾²æ°‘ä¿éšªçµ¦ä»˜</option>
            <option>å…¬æ•™ä¿éšªçµ¦ä»˜</option>
          </optgroup>
          <optgroup label="çˆ­è­°/å¯©è­°">
            <option>çˆ­è­°å¯©è­°è¨´é¡˜</option>
            <option>è·ç½è£œå„Ÿè³ å„Ÿ</option>
            <option>å‹è³‡çˆ­è­°äº‹é …</option>
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            <option>å£½éšª</option>
            <option>é†«ç™‚éšª</option>
            <option>æ„å¤–éšª</option>
            <option>å¤±èƒ½éšª</option>
            <option>é•·ç…§éšª</option>
          </optgroup>
        </select>
      </div>
    </div>
    <div class="section-divider">ç•¶äº‹äººè³‡æ–™</div>
    <div class="form-grid cols-3">
      <div class="field"><label>å§“å *</label><input type="text" id="f-name"></div>
      <div class="field"><label>èº«åˆ†è­‰è™Ÿ</label><input type="text" id="f-id-num"></div>
      <div class="field"><label>è¯çµ¡é›»è©±</label><input type="text" id="f-phone"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>æŠ•ä¿å–®ä½</label><input type="text" id="f-employer"></div>
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="f-insurer" list="insurer-dl" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('f-insurer').value='';document.getElementById('f-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
    </div>
    <div class="form-grid cols-3">
      <div class="field"><label>æŠ•ä¿è–ªè³‡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-wage"></div>
      <div class="field"><label>äº‹æ•…/èµ·å§‹æ—¥æœŸ</label><input type="date" id="f-accident" onchange="var h=document.getElementById('hint-f-accident');if(h)h.textContent=rocHint('f-accident');"><div id="hint-f-accident" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>å—ç†æ—¥æœŸ</label><input type="date" id="f-receive" value="${new Date().toISOString().slice(0,10)}" onchange="var h=document.getElementById('hint-f-receive');if(h)h.textContent=rocHint('f-receive');"><div id="hint-f-receive" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="section-divider">æ¡ˆä»¶è³‡è¨Š</div>
    <div class="form-grid cols-3">
      <div class="field"><label>æ¡ˆä»¶ç‹€æ…‹</label>
        <select id="f-status">
          ${['é€²è¡Œä¸­','å¾…è£œä»¶','å¯©æ ¸ä¸­','èª¿è§£ä¸­','è¨´è¨Ÿä¸­','å·²çµæ¡ˆ','æ’¤æ¡ˆ'].map(s=>`<option ${s==='é€²è¡Œä¸­'?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>è² è²¬äºº</label><input type="text" id="f-handler" value="é™³é¡§å•"></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-amount"></div>
    </div>
    <div style="margin-top:14px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸï¼ˆæ³•å®š/æ©Ÿé—œè¦æ±‚ï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-deadline" onchange="var h=document.getElementById('hint-f-deadline');if(h)h.textContent=rocHint('f-deadline');"><div id="hint-f-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="f-deadline-note" placeholder="å¦‚ï¼šå‹ä¿å±€è£œä»¶æˆªæ­¢ã€æ³•é™¢é–‹åº­æ—¥"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸï¼ˆå…§éƒ¨è¦åŠƒï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-planned" onchange="var h=document.getElementById('hint-f-planned');if(h)h.textContent=rocHint('f-planned');"><div id="hint-f-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="f-planned-note" placeholder="å¦‚ï¼šé è¨ˆå‚™å¦¥æ–‡ä»¶ã€é è¨ˆé€ä»¶"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><textarea id="f-note" rows="3"></textarea></div>
  `, () => {
    const newCase = {
      id: document.getElementById('f-id').value || id,
      type: document.getElementById('f-type').value,
      name: document.getElementById('f-name').value,
      idNum: document.getElementById('f-id-num').value,
      phone: document.getElementById('f-phone').value,
      employer: document.getElementById('f-employer').value,
      insurer: document.getElementById('f-insurer').value,
      wage: document.getElementById('f-wage').value,
      accidentDate: document.getElementById('f-accident').value,
      status: document.getElementById('f-status').value,
      receiveDate: document.getElementById('f-receive').value,
      handler: document.getElementById('f-handler').value,
      deadline: document.getElementById('f-deadline').value,
      deadlineNote: document.getElementById('f-deadline-note').value,
      plannedDate: document.getElementById('f-planned').value,
      plannedDateNote: document.getElementById('f-planned-note').value,
      amount: document.getElementById('f-amount').value,
      note: document.getElementById('f-note').value,
      created: new Date().toISOString().slice(0,10),
      updated: new Date().toISOString().slice(0,10)
    };
    if (!newCase.name || !newCase.type) { alert('å§“åå’Œå€‹æ¡ˆé¡å‹ç‚ºå¿…å¡«ï¼'); return false; }
    db.cases.push(newCase);
    saveData(db);
    return true;
  });
  // Pre-select copy source if provided
  if (copyFromId) {
    setTimeout(() => {
      const sel = document.getElementById('f-copy-src');
      if (sel) { sel.value = copyFromId; fillFromCase(copyFromId); }
    }, 80);
  }
}

function openEditCase(id) {
  const c = db.cases.find(x => x.id === id);
  if (!c) return;
  showModal(`ç·¨è¼¯å€‹æ¡ˆ â€” ${c.name}`, `
    <div class="form-grid">
      <div class="field"><label>å€‹æ¡ˆç·¨è™Ÿ</label><input type="text" id="f-id" value="${c.id}" disabled></div>
      <div class="field"><label>å€‹æ¡ˆé¡å‹</label>
        <select id="f-type">
          <optgroup label="å‹å·¥ä¿éšª">
            ${['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            ${['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å…¬è¾²æ•™ä¿éšª">
            ${['è¾²æ°‘ä¿éšªçµ¦ä»˜','å…¬æ•™ä¿éšªçµ¦ä»˜'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="çˆ­è­°/å¯©è­°">
            ${['çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            ${['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª'].map(t=>`<option ${t===c.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
        </select>
      </div>
    </div>
    <div class="section-divider">ç•¶äº‹äººè³‡æ–™</div>
    <div class="form-grid cols-3">
      <div class="field"><label>å§“å</label><input type="text" id="f-name" value="${c.name}"></div>
      <div class="field"><label>èº«åˆ†è­‰è™Ÿ</label><input type="text" id="f-id-num" value="${c.idNum}"></div>
      <div class="field"><label>è¯çµ¡é›»è©±</label><input type="text" id="f-phone" value="${c.phone}"></div>
    </div>
    <div class="form-grid">
      <div class="field"><label>æŠ•ä¿å–®ä½</label><input type="text" id="f-employer" value="${c.employer}"></div>
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="f-insurer" list="insurer-dl" value="${c.insurer||''}" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('f-insurer').value='';document.getElementById('f-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
    </div>
    <div class="form-grid cols-3">
      <div class="field"><label>æŠ•ä¿è–ªè³‡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-wage" value="${c.wage}"></div>
      <div class="field"><label>äº‹æ•…/èµ·å§‹æ—¥æœŸ</label><input type="date" id="f-accident" value="${c.accidentDate}" onchange="var h=document.getElementById('hint-f-accident');if(h)h.textContent=rocHint('f-accident');"><div id="hint-f-accident" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
      <div class="field"><label>å—ç†æ—¥æœŸ</label><input type="date" id="f-receive" value="${c.receiveDate}" onchange="var h=document.getElementById('hint-f-receive');if(h)h.textContent=rocHint('f-receive');"><div id="hint-f-receive" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="section-divider">æ¡ˆä»¶è³‡è¨Š</div>
    <div class="form-grid cols-3">
      <div class="field"><label>æ¡ˆä»¶ç‹€æ…‹</label>
        <select id="f-status">
          ${['é€²è¡Œä¸­','å¾…è£œä»¶','å¯©æ ¸ä¸­','èª¿è§£ä¸­','è¨´è¨Ÿä¸­','å·²çµæ¡ˆ','æ’¤æ¡ˆ'].map(s=>`<option ${s===c.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>è² è²¬äºº</label><input type="text" id="f-handler" value="${c.handler}"></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="f-amount" value="${c.amount}"></div>
    </div>
    <div style="margin-top:14px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸï¼ˆæ³•å®š/æ©Ÿé—œè¦æ±‚ï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-deadline" value="${c.deadline}" onchange="var h=document.getElementById('hint-f-deadline');if(h)h.textContent=rocHint('f-deadline');"><div id="hint-f-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="f-deadline-note" value="${c.deadlineNote}"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸï¼ˆå…§éƒ¨è¦åŠƒï¼‰</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆä»¥è¥¿å…ƒå¹´è¼¸å…¥ï¼Œè‡ªå‹•é¡¯ç¤ºæ°‘åœ‹ï¼‰</span></label><input type="date" id="f-planned" value="${c.plannedDate||''}" onchange="var h=document.getElementById('hint-f-planned');if(h)h.textContent=rocHint('f-planned');"><div id="hint-f-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="f-planned-note" value="${c.plannedDateNote||''}"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><textarea id="f-note" rows="3">${c.note}</textarea></div>
    <div class="divider"></div>
    <button class="btn btn-danger btn-sm" onclick="if(confirm('ç¢ºå®šåˆªé™¤æ­¤å€‹æ¡ˆï¼Ÿ'))deleteCase('${c.id}')">åˆªé™¤æ­¤å€‹æ¡ˆ</button>
  `, () => {
    c.type = document.getElementById('f-type').value;
    c.name = document.getElementById('f-name').value;
    c.idNum = document.getElementById('f-id-num').value;
    c.phone = document.getElementById('f-phone').value;
    c.employer = document.getElementById('f-employer').value;
    c.insurer = document.getElementById('f-insurer').value;
    c.wage = document.getElementById('f-wage').value;
    c.accidentDate = document.getElementById('f-accident').value;
    c.status = document.getElementById('f-status').value;
    c.receiveDate = document.getElementById('f-receive').value;
    c.handler = document.getElementById('f-handler').value;
    c.deadline = document.getElementById('f-deadline').value;
    c.deadlineNote = document.getElementById('f-deadline-note').value;
    c.plannedDate = document.getElementById('f-planned').value;
    c.plannedDateNote = document.getElementById('f-planned-note').value;
    c.amount = document.getElementById('f-amount').value;
    c.note = document.getElementById('f-note').value;
    c.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

function deleteCase(id) {
  db.cases = db.cases.filter(c => c.id !== id);
  db.tracks = db.tracks.filter(t => t.caseId !== id);
  db.progress = db.progress.filter(p => p.caseId !== id);
  saveData(db);
  closeModal();
  navigate('cases');
}


// â”€â”€â”€ Track Modal Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _trackAction(el) {
  var action = el.getAttribute('data-action');
  var caseId = el.getAttribute('data-case');
  var trackId = el.getAttribute('data-track');
  if (action === 'addProgress') openAddProgress(caseId, trackId);
  else if (action === 'editTrack') openEditTrack(trackId);
  else if (action === 'addTrack') openAddTrack(caseId);
  else if (action === 'scrollTo') {
    var el2 = document.getElementById('track-' + trackId);
    if (el2) el2.scrollIntoView({behavior: 'smooth'});
  }
}

function openAddTrack(caseId) {
  var c = db.cases.find(function(x){ return x.id === caseId; });
  showModal('æ–°å¢è¿½è¹¤è»¸ â€” ' + (c ? c.name : caseId), `
    <div style="padding:10px 12px;background:rgba(201,168,76,0.08);border-radius:8px;font-size:12px;color:var(--text-2);margin-bottom:14px">
      åŒä¸€å€‹æ¡ˆä¸»å¯åŒæ™‚ä¸¦è¡Œå¤šæ¢è¿½è¹¤è»¸ï¼Œå„æœ‰è‡ªå·±çš„é€²åº¦è¨˜éŒ„èˆ‡æœŸé™ã€‚
    </div>
    <div class="form-grid">
      <div class="field form-full"><label>è¿½è¹¤è»¸åç¨± *</label>
        <input type="text" id="ft-name" placeholder="ä¾‹ï¼šå‹ä¿å‚·ç—…çµ¦ä»˜ç”³è«‹ã€å¯Œé‚¦é†«ç™‚éšªç†è³ ">
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>é¡å‹ *</label>
        <select id="ft-type"><option value="">è«‹é¸æ“‡</option>
          <optgroup label="å‹å·¥ä¿éšª">
            <option>å‹ä¿ç”Ÿè‚²çµ¦ä»˜</option><option>å‹ä¿å‚·ç—…çµ¦ä»˜</option><option>å‹ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>å‹ä¿è€å¹´çµ¦ä»˜</option><option>å‹ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            <option>è·ä¿é†«ç™‚çµ¦ä»˜</option><option>è·ä¿å‚·ç—…çµ¦ä»˜</option><option>è·ä¿å¤±èƒ½çµ¦ä»˜</option>
            <option>è·ä¿æ­»äº¡çµ¦ä»˜</option>
          </optgroup>
          <optgroup label="å…¬è¾²æ•™ä¿éšª">
            <option>è¾²æ°‘ä¿éšªçµ¦ä»˜</option><option>å…¬æ•™ä¿éšªçµ¦ä»˜</option>
          </optgroup>
          <optgroup label="çˆ­è­°/å¯©è­°">
            <option>çˆ­è­°å¯©è­°è¨´é¡˜</option><option>è·ç½è£œå„Ÿè³ å„Ÿ</option><option>å‹è³‡çˆ­è­°äº‹é …</option>
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            <option>å£½éšª</option><option>é†«ç™‚éšª</option><option>æ„å¤–éšª</option>
            <option>å¤±èƒ½éšª</option><option>é•·ç…§éšª</option>
          </optgroup>
        </select>
      </div>
      <div class="field"><label>åˆå§‹ç‹€æ…‹</label>
        <select id="ft-status">
          ${['é€²è¡Œä¸­','å¾…è£œä»¶','å¯©æ ¸ä¸­','èª¿è§£ä¸­','è¨´è¨Ÿä¸­','å·²çµæ¡ˆ','æ’¤æ¡ˆ'].map(s=>`<option ${s==='é€²è¡Œä¸­'?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="ft-insurer" list="insurer-dl" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('ft-insurer').value='';document.getElementById('ft-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="ft-amount" placeholder="0"></div>
    </div>
    <div style="margin-top:12px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="ft-deadline" onchange="var h=document.getElementById('hint-ft-deadline');if(h)h.textContent=rocHint('ft-deadline');"><div id="hint-ft-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="ft-deadline-note" placeholder="å¦‚ï¼šå‹ä¿å±€è£œä»¶æˆªæ­¢"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ</label><input type="date" id="ft-planned" onchange="var h=document.getElementById('hint-ft-planned');if(h)h.textContent=rocHint('ft-planned');"><div id="hint-ft-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="ft-planned-note" placeholder="å¦‚ï¼šé è¨ˆå‚™å¦¥æ–‡ä»¶"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><input type="text" id="ft-note"></div>
  `, () => {
    var name = document.getElementById('ft-name').value;
    if (!name) { alert('è¿½è¹¤è»¸åç¨±ç‚ºå¿…å¡«ï¼'); return false; }
    var tr = {
      id: genTrackId(caseId), caseId: caseId, name: name,
      type: document.getElementById('ft-type').value,
      insurer: document.getElementById('ft-insurer').value,
      status: document.getElementById('ft-status').value,
      deadline: document.getElementById('ft-deadline').value,
      deadlineNote: document.getElementById('ft-deadline-note').value,
      plannedDate: document.getElementById('ft-planned').value,
      plannedDateNote: document.getElementById('ft-planned-note').value,
      amount: document.getElementById('ft-amount').value,
      note: document.getElementById('ft-note').value,
      created: new Date().toISOString().slice(0,10)
    };
    db.tracks.push(tr);
    var c2 = db.cases.find(function(x){ return x.id === caseId; });
    if (c2) c2.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

function openEditTrack(trackId) {
  var tr = db.tracks.find(function(x){ return x.id === trackId; });
  if (!tr) return;
  showModal(`ç·¨è¼¯è¿½è¹¤è»¸ â€” ${tr.name}`, `
    <div class="form-grid">
      <div class="field form-full"><label>è¿½è¹¤è»¸åç¨± *</label>
        <input type="text" id="ft-name" value="${tr.name}">
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>é¡å‹</label>
        <select id="ft-type">
          <optgroup label="å‹å·¥ä¿éšª">
            ${['å‹ä¿ç”Ÿè‚²çµ¦ä»˜','å‹ä¿å‚·ç—…çµ¦ä»˜','å‹ä¿å¤±èƒ½çµ¦ä»˜','å‹ä¿è€å¹´çµ¦ä»˜','å‹ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="è·ç½ä¿éšª">
            ${['è·ä¿é†«ç™‚çµ¦ä»˜','è·ä¿å‚·ç—…çµ¦ä»˜','è·ä¿å¤±èƒ½çµ¦ä»˜','è·ä¿æ­»äº¡çµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å…¬è¾²æ•™ä¿éšª">
            ${['è¾²æ°‘ä¿éšªçµ¦ä»˜','å…¬æ•™ä¿éšªçµ¦ä»˜'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="çˆ­è­°/å¯©è­°">
            ${['çˆ­è­°å¯©è­°è¨´é¡˜','è·ç½è£œå„Ÿè³ å„Ÿ','å‹è³‡çˆ­è­°äº‹é …'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
          <optgroup label="å•†æ¥­ä¿éšª">
            ${['å£½éšª','é†«ç™‚éšª','æ„å¤–éšª','å¤±èƒ½éšª','é•·ç…§éšª'].map(t=>`<option ${t===tr.type?'selected':''}>${t}</option>`).join('')}
          </optgroup>
        </select>
      </div>
      <div class="field"><label>ç‹€æ…‹</label>
        <select id="ft-status" onchange="var cr=document.getElementById('ft-closed-row');if(cr)cr.style.display=(this.value==='å·²çµæ¡ˆ'||this.value==='æ’¤æ¡ˆ')?'block':'none'">
          ${['é€²è¡Œä¸­','å¾…è£œä»¶','å¯©æ ¸ä¸­','èª¿è§£ä¸­','è¨´è¨Ÿä¸­','å·²çµæ¡ˆ','æ’¤æ¡ˆ'].map(s=>`<option ${s===tr.status?'selected':''}>${s}</option>`).join('')}
        </select>
      </div>
    </div>
    <div id="ft-closed-row" style="display:${(tr.status==='å·²çµæ¡ˆ'||tr.status==='æ’¤æ¡ˆ')?'block':'none'};margin-top:8px;padding:12px 14px;background:rgba(0,114,178,0.05);border:1px solid rgba(0,114,178,0.2);border-radius:8px;margin-bottom:8px">
      <div style="font-size:11px;font-weight:700;color:#0072B2;margin-bottom:8px">âœ“ çµæ¡ˆæ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>çµæ¡ˆæ—¥æœŸ</label><input type="date" id="ft-closed-date" value="${tr.closedDate||''}" onchange="var h=document.getElementById('hint-ft-closed-date');if(h)h.textContent=rocHint('ft-closed-date');"><div id="hint-ft-closed-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>çµæ¡ˆèªªæ˜</label><input type="text" id="ft-closed-note" value="${tr.closedNote||''}" placeholder="å¦‚ï¼šæ ¸å®šçµ¦ä»˜ã€èª¿è§£æˆç«‹"></div>
      </div>
    </div>
    <div class="form-grid">
      <div class="field"><label>ä¿éšªå…¬å¸/ä¸»ç®¡æ©Ÿé—œ</label><div style="display:flex;gap:6px"><input type="text" id="ft-insurer" list="insurer-dl" value="${tr.insurer||''}" placeholder="è¼¸å…¥æˆ–é¸æ“‡..." style="flex:1"><button type="button" class="btn btn-outline btn-sm" onclick="document.getElementById('ft-insurer').value='';document.getElementById('ft-insurer').focus()" style="flex-shrink:0;padding:5px 8px" title="æ¸…é™¤">âœ•</button></div></div>
      <div class="field"><label>é ä¼°é‡‘é¡ï¼ˆå…ƒï¼‰</label><input type="number" id="ft-amount" value="${tr.amount||''}"></div>
    </div>
    <div style="margin-top:12px;padding:12px 14px;background:rgba(213,94,0,0.04);border:1px solid rgba(213,94,0,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#D55E00;margin-bottom:10px">âš ï¸ å®Œæˆæˆªæ­¢æ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>æˆªæ­¢æ—¥æœŸ</label><input type="date" id="ft-deadline" value="${tr.deadline||''}" onchange="var h=document.getElementById('hint-ft-deadline');if(h)h.textContent=rocHint('ft-deadline');"><div id="hint-ft-deadline" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>æˆªæ­¢èªªæ˜</label><input type="text" id="ft-deadline-note" value="${tr.deadlineNote||''}"></div>
      </div>
    </div>
    <div style="margin-top:10px;padding:12px 14px;background:rgba(14,165,176,0.04);border:1px solid rgba(14,165,176,0.2);border-radius:8px">
      <div style="font-size:11px;font-weight:700;color:#0EA5B0;margin-bottom:10px">ğŸ“‹ é è¨ˆå®Œæˆæ—¥æœŸ</div>
      <div class="form-grid">
        <div class="field"><label>é è¨ˆå®Œæˆæ—¥æœŸ</label><input type="date" id="ft-planned" value="${tr.plannedDate||''}" onchange="var h=document.getElementById('hint-ft-planned');if(h)h.textContent=rocHint('ft-planned');"><div id="hint-ft-planned" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
        <div class="field"><label>å®Œæˆé …ç›®èªªæ˜</label><input type="text" id="ft-planned-note" value="${tr.plannedDateNote||''}"></div>
      </div>
    </div>
    <div class="field" style="margin-top:12px"><label>å‚™è¨»</label><input type="text" id="ft-note" value="${tr.note||''}"></div>
    <div class="divider"></div>
    <button class="btn btn-danger btn-sm" onclick="if(confirm('ç¢ºå®šåˆªé™¤æ­¤è¿½è¹¤è»¸ï¼Ÿé€²åº¦è¨˜éŒ„ä¹Ÿæœƒä¸€ä½µåˆªé™¤ã€‚'))deleteTrack('${tr.id}')">åˆªé™¤æ­¤è¿½è¹¤è»¸</button>
  `, () => {
    tr.name = document.getElementById('ft-name').value;
    tr.type = document.getElementById('ft-type').value;
    tr.insurer = document.getElementById('ft-insurer').value;
    tr.status = document.getElementById('ft-status').value;
    var tcd = document.getElementById('ft-closed-date'); if (tcd) tr.closedDate = tcd.value || '';
    var tcn = document.getElementById('ft-closed-note'); if (tcn) tr.closedNote = tcn.value || '';
    tr.amount = document.getElementById('ft-amount').value;
    tr.deadline = document.getElementById('ft-deadline').value;
    tr.deadlineNote = document.getElementById('ft-deadline-note').value;
    tr.plannedDate = document.getElementById('ft-planned').value;
    tr.plannedDateNote = document.getElementById('ft-planned-note').value;
    tr.note = document.getElementById('ft-note').value;
    saveData(db);
    return true;
  });
}

function deleteTrack(trackId) {
  db.tracks = db.tracks.filter(function(t){ return t.id !== trackId; });
  db.progress = db.progress.filter(function(p){ return p.trackId !== trackId; });
  saveData(db);
  closeModal();
}

function updateTrackOptions(caseId) {
  const sel = document.getElementById('fp-track');
  if (!sel) return;
  const tracks = db.tracks.filter(t => t.caseId === caseId);
  sel.innerHTML = '<option value="">â€” ä¸æŒ‡å®šè¿½è¹¤è»¸ â€”</option>' +
    tracks.map(t => '<option value="' + t.id + '">' + t.name + 'ï¼ˆ' + t.type + 'ï¼‰</option>').join('');
}

function openAddProgress(caseId, trackId) {
  showModal('æ–°å¢é€²åº¦è¨˜éŒ„', `
    <div class="form-grid">
      <div class="field"><label>å€‹æ¡ˆ *</label>
        <select id="fp-case" onchange="updateTrackOptions(this.value)">
          ${db.cases.map(c=>`<option value="${c.id}" ${c.id===caseId?'selected':''}>${c.id} ${c.name}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>æ—¥æœŸ * <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆè¥¿å…ƒå¹´ï¼Œè‡ªå‹•æ›ç®—æ°‘åœ‹ï¼‰</span></label><input type="date" id="fp-date" value="${new Date().toISOString().slice(0,10)}" onchange="var h=document.getElementById('hint-fp-date');if(h)h.textContent=rocHint('fp-date');"><div id="hint-fp-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="field" style="margin-bottom:12px">
      <label>è¿½è¹¤è»¸ <span style="color:var(--text-3);font-weight:400;font-size:10px">ï¼ˆé¸æ“‡æ­¤é€²åº¦å±¬æ–¼å“ªæ¢è¿½è¹¤è»¸ï¼‰</span></label>
      <select id="fp-track" style="border:2px solid var(--gold)">
        <option value="">â€” ä¸æŒ‡å®šè¿½è¹¤è»¸ â€”</option>
        ${db.tracks.filter(t=>t.caseId===caseId).map(t=>`<option value="${t.id}" ${t.id===trackId?'selected':''}>${t.name}ï¼ˆ${t.type}ï¼‰</option>`).join('')}
      </select>
    </div>
    <div class="form-grid">
      <div class="field"><label>é€²åº¦éšæ®µ *</label>
        <select id="fp-stage">
          ${['æ”¶æ¡ˆ','è£œä»¶','é€ä»¶','æ©Ÿé—œå¯©æŸ¥','å”å•†/èª¿è§£','è¨´è¨Ÿ','æ ¸å®š/åˆ¤æ±º','çµ¦ä»˜/çµæ¡ˆ','æ’¤æ¡ˆ'].map(s=>`<option>${s}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>æ”¶/é€ä»¶</label>
        <select id="fp-sr"><option value="">ä¸é©ç”¨</option><option>æ”¶ä»¶</option><option>é€ä»¶</option></select>
      </div>
    </div>
    <div class="field"><label>è¾¦ç†äº‹é …èªªæ˜ *</label><textarea id="fp-desc" rows="3" placeholder="èªªæ˜æœ¬æ¬¡è¾¦ç†çš„å…·é«”äº‹é …"></textarea></div>
    <div class="form-grid">
      <div class="field"><label>æ‰¿è¾¦äºº</label><input type="text" id="fp-handler" value="é™³é¡§å•"></div>
      <div class="field"><label>ä¸‹æ¬¡é‡è¦æ—¥æœŸ</label><input type="date" id="fp-next-date" onchange="var h=document.getElementById('hint-fp-next-date');if(h)h.textContent=rocHint('fp-next-date');"><div id="hint-fp-next-date" style="font-size:11px;color:#0EA5B0;margin-top:3px;font-weight:600;min-height:16px"></div></div>
    </div>
    <div class="field"><label>ä¸‹ä¸€æ­¥é©Ÿ</label><input type="text" id="fp-next" placeholder="ä¸‹ä¸€æ­¥è¦åšä»€éº¼"></div>
    <div class="field" style="margin-top:8px"><label>å‚™è¨»</label><input type="text" id="fp-note"></div>
  `, () => {
    const p = {
      id: genProgressId(),
      caseId: document.getElementById('fp-case').value,
      trackId: document.getElementById('fp-track').value || null,
      date: document.getElementById('fp-date').value,
      stage: document.getElementById('fp-stage').value,
      desc: document.getElementById('fp-desc').value,
      sendRecv: document.getElementById('fp-sr').value,
      handler: document.getElementById('fp-handler').value,
      nextStep: document.getElementById('fp-next').value,
      nextDate: document.getElementById('fp-next-date').value,
      note: document.getElementById('fp-note').value
    };
    if (!p.caseId || !p.date || !p.desc) { alert('å€‹æ¡ˆã€æ—¥æœŸã€èªªæ˜ç‚ºå¿…å¡«ï¼'); return false; }
    db.progress.push(p);
    const c = db.cases.find(x => x.id === p.caseId);
    if (c) c.updated = new Date().toISOString().slice(0,10);
    saveData(db);
    return true;
  });
}

// â”€â”€â”€ Modal Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(title, body, onConfirm) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-head">
        <h2>${title}</h2>
        <button class="btn btn-outline btn-icon" onclick="closeModal()">âœ•</button>
      </div>
      <div class="modal-body">${body}</div>
      <div class="modal-foot">
        <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-gold" onclick="confirmModal()">ç¢ºèªå„²å­˜</button>
      </div>
    </div>`;
  overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
  document.body.appendChild(overlay);
  window._modalConfirm = onConfirm;
  setTimeout(() => {
    ['f-accident','f-receive','f-deadline','f-planned','fp-date','fp-next-date','ft-deadline','ft-planned','f-closed-date','ft-closed-date'].forEach(function(id) {
      var el = document.getElementById(id);
      var hint = document.getElementById('hint-'+id);
      if (el && hint && el.value) hint.textContent = rocHint(id);
    });
  }, 60);
}
function closeModal() {
  document.querySelector('.modal-overlay')?.remove();
  render();
}
function confirmModal() {
  if (window._modalConfirm && window._modalConfirm() !== false) closeModal();
}


// Insurer datalist injected via JS
document.body.insertAdjacentHTML("beforeend",'<datalist id="insurer-dl"><option value="å‹ä¿å±€"><option value="å°éŠ€äººå£½"><option value="å°ç£äººå£½"><option value="ä¿èª äººå£½"><option value="åœ‹æ³°äººå£½"><option value="å‡±åŸºäººå£½"><option value="å—å±±äººå£½"><option value="æ–°å…‰äººå£½"><option value="å¯Œé‚¦äººå£½"><option value="ä¸‰å•†ç¾é‚¦äººå£½"><option value="é é›„äººå£½"><option value="å®æ³°äººå£½"><option value="å®‰è¯äººå£½"><option value="ç¬¬ä¸€é‡‘äººå£½"><option value="åˆåº«äººå£½"><option value="å°æ–°äººå£½"><option value="å…¨çƒäººå£½"><option value="å…ƒå¤§äººå£½"><option value="å®‰é”äººå£½"><option value="å‹é‚¦äººå£½"><option value="æ³•å·´äººå£½"><option value="å…†è±ç”¢éšª"><option value="è‡ºç£ç”¢éšª"><option value="å¯Œé‚¦ç”¢éšª"><option value="å’Œæ³°ç”¢éšª"><option value="æ³°å®‰ç”¢éšª"><option value="æ˜å°ç”¢éšª"><option value="å—å±±ç”¢éšª"><option value="ç¬¬ä¸€ç”¢éšª"><option value="æ—ºæ—ºå‹è¯ç”¢éšª"><option value="è¯å—ç”¢éšª"><option value="æ–°å…‰ç”¢éšª"><option value="åœ‹æ³°ç”¢éšª"><option value="æ–°å®‰æ±äº¬ç”¢éšª"><option value="ä¸­åœ‹ä¿¡è¨—ç”¢éšª"><option value="å®‰é”ç”¢éšª"><option value="æ³•å·´ç”¢éšª"><option value="AIGç”¢éšª"></datalist>');

// â”€â”€â”€ Archive & Backup Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function archiveSelected() {
  const checkboxes = document.querySelectorAll('.archive-cb:checked');
  const ids = Array.from(checkboxes).map(cb => cb.value);
  if (ids.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å€‹æ¡ˆï¼'); return; }

  // æ”¶é›†è¦æ­¸æª”çš„è³‡æ–™
  const archiveCases = db.cases.filter(c => ids.includes(c.id));
  const archiveTracks = db.tracks.filter(t => ids.includes(t.caseId));
  const archiveProgress = db.progress.filter(p => ids.includes(p.caseId));

  const archiveData = {
    _type: 'archive',
    _date: new Date().toISOString(),
    _note: 'æ­¸æª”å€‹æ¡ˆï¼š' + archiveCases.map(c => c.id + ' ' + c.name).join('ã€'),
    cases: archiveCases,
    tracks: archiveTracks,
    progress: archiveProgress
  };

  // ä¸‹è¼‰
  const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'æ­¸æª”_' + ids.join('_') + '_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);

  // ç¢ºèªåˆªé™¤
  setTimeout(function() {
    const names = archiveCases.map(c => c.id + ' ' + c.name).join('\n  ');
    if (confirm('æª”æ¡ˆå·²ä¸‹è¼‰ã€‚\n\nç¢ºå®šè¦å¾ç³»çµ±ä¸­åˆªé™¤ä»¥ä¸‹ ' + ids.length + ' å€‹å€‹æ¡ˆï¼Ÿ\n  ' + names + '\n\nï¼ˆå¯éš¨æ™‚å¾å‚™ä»½æª”é‚„åŸï¼‰')) {
      db.cases = db.cases.filter(c => !ids.includes(c.id));
      db.tracks = db.tracks.filter(t => !ids.includes(t.caseId));
      db.progress = db.progress.filter(p => !ids.includes(p.caseId));
      saveData(db);
      alert('âœ… å·²åˆªé™¤ ' + ids.length + ' å€‹çµæ¡ˆå€‹æ¡ˆï¼Œè³‡æ–™å·²æ­¸æª”ä¿å­˜ã€‚');
      render();
    }
  }, 500);
}

function exportAllJson() {
  const data = {
    _type: 'full_backup',
    _date: new Date().toISOString(),
    cases: db.cases,
    tracks: db.tracks,
    progress: db.progress
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'å€‹æ¡ˆç®¡ç†_å…¨é‡å‚™ä»½_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importJson(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.cases) throw new Error('JSON æ ¼å¼ä¸æ­£ç¢º');
      if (!confirm('åŒ¯å…¥æœƒè¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼ˆ' + db.cases.length + ' ç­†å€‹æ¡ˆï¼‰ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) return;
      db.cases = data.cases || [];
      db.tracks = data.tracks || [];
      db.progress = data.progress || [];
      var _pid2 = 1;
      db.progress.forEach(function(p){ if (!p.id) p.id = 'P' + String(_pid2++).padStart(4,'0'); });
      saveData(db);
      alert('âœ… åŒ¯å…¥å®Œæˆï¼å…± ' + db.cases.length + ' ç­†å€‹æ¡ˆã€‚');
      render();
    } catch(err) {
      alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function restoreArchive(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.cases || !data.cases.length) throw new Error('æ‰¾ä¸åˆ°å€‹æ¡ˆè³‡æ–™');
      const names = data.cases.map(c => c.id + ' ' + c.name).join('\n  ');
      if (!confirm('å³å°‡é‚„åŸä»¥ä¸‹ ' + data.cases.length + ' å€‹å€‹æ¡ˆï¼š\n  ' + names + '\n\nå·²å­˜åœ¨ç›¸åŒç·¨è™Ÿçš„å€‹æ¡ˆæœƒè¢«è¦†è“‹ã€‚ç¢ºå®šç¹¼çºŒï¼Ÿ')) return;

      // Merge: upsert by ID
      (data.cases || []).forEach(function(c) {
        const idx = db.cases.findIndex(x => x.id === c.id);
        if (idx >= 0) db.cases[idx] = c; else db.cases.push(c);
      });
      (data.tracks || []).forEach(function(t) {
        const idx = db.tracks.findIndex(x => x.id === t.id);
        if (idx >= 0) db.tracks[idx] = t; else db.tracks.push(t);
      });
      (data.progress || []).forEach(function(p) {
        if (!p.id) return;
        const idx = db.progress.findIndex(x => x.id === p.id);
        if (idx >= 0) db.progress[idx] = p; else db.progress.push(p);
      });
      saveData(db);
      alert('âœ… é‚„åŸå®Œæˆï¼å·²åŠ å› ' + data.cases.length + ' å€‹å€‹æ¡ˆã€‚');
      render();
    } catch(err) {
      alert('âŒ é‚„åŸå¤±æ•—ï¼š' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
render();
</script>
</body>
</html>
